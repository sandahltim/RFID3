{% extends "base.html" %}

{% block title %}RFID Mobile Scanner - Home{% endblock %}

{% block header_title %}Employee Scanner{% endblock %}

{% block content %}
<div class="row g-3">
    <!-- Main Scanner Button -->
    <div class="col-12">
        <a href="{{ url_for('scanner') }}" class="btn btn-primary btn-large w-100">
            <i class="fas fa-qrcode"></i>
            Start Scanning
        </a>
    </div>

    <!-- Quick Actions -->
    <div class="col-md-6">
        <a href="{{ url_for('rental_flow') }}" class="btn btn-success btn-large w-100">
            <i class="fas fa-exchange-alt"></i>
            Rental Flow
        </a>
    </div>

    <div class="col-md-6">
        <button class="btn btn-outline-primary btn-large w-100" onclick="showSearchModal()">
            <i class="fas fa-search"></i>
            Find Item
        </button>
    </div>

    <div class="col-md-6">
        <button class="btn btn-outline-success btn-large w-100" onclick="showBatchMode()">
            <i class="fas fa-layer-group"></i>
            Batch Scan
        </button>
    </div>

    <div class="col-md-6">
        <a href="{{ url_for('scanner', mode='contract') }}" class="btn btn-outline-info btn-large w-100">
            <i class="fas fa-file-contract"></i>
            Contracts
        </a>
    </div>

    <!-- System Status Card -->
    <div class="col-12">
        <div class="scanner-container">
            <h5 class="mb-3">
                <i class="fas fa-info-circle text-primary me-2"></i>
                System Status
            </h5>
            <div id="system-status">
                <div class="d-flex align-items-center">
                    <div class="loading-spinner me-3"></div>
                    <span>Checking system status...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-12">
        <div class="scanner-container">
            <h5 class="mb-3">
                <i class="fas fa-history text-secondary me-2"></i>
                Quick Help
            </h5>
            <div class="row g-2">
                <div class="col-12">
                    <div class="alert alert-info mb-2">
                        <strong><i class="fas fa-mobile-alt me-2"></i>How to Scan:</strong>
                        <br>• Tap "Start Scanning" above
                        <br>• Point camera at QR code or RFID tag
                        <br>• Or use hardware scanner if available
                    </div>
                </div>
                <div class="col-12">
                    <div class="alert alert-warning mb-2">
                        <strong><i class="fas fa-exclamation-triangle me-2"></i>Need Help?</strong>
                        <br>• Use "Find Item" to search manually
                        <br>• "Batch Scan" for multiple items
                        <br>• Contact supervisor if scanner issues
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Modal -->
<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>Find Item
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="searchInput" class="form-label">Search by Tag ID, Serial Number, or Location:</label>
                    <div class="input-group">
                        <input type="text"
                               class="form-control form-control-lg"
                               id="searchInput"
                               placeholder="Enter search term...">
                        <button class="btn btn-primary" onclick="performSearch()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                </div>
                <div id="searchResults"></div>
            </div>
        </div>
    </div>
</div>

<!-- Batch Mode Modal -->
<div class="modal fade" id="batchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-layer-group me-2"></i>Batch Scanning Mode
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Batch Mode Instructions:</strong>
                    <br>• Scan multiple items quickly
                    <br>• Results saved automatically
                    <br>• Use for inventory checks or bulk operations
                </div>
                <div class="d-grid gap-2">
                    <a href="{{ url_for('scanner') }}?mode=batch" class="btn btn-success btn-lg">
                        <i class="fas fa-play me-2"></i>Start Batch Scanning
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Check system status on load
document.addEventListener('DOMContentLoaded', function() {
    checkSystemHealth();
});

async function checkSystemHealth() {
    try {
        const response = await fetch('/api/health');
        const data = await response.json();

        const statusElement = document.getElementById('system-status');

        if (response.ok && data.status === 'healthy') {
            statusElement.innerHTML = `
                <div class="d-flex align-items-center text-success">
                    <i class="fas fa-check-circle me-3 fs-4"></i>
                    <div>
                        <strong>System Online</strong>
                        <br><small class="text-muted">
                            ${data.items_in_system.toLocaleString()} items in database
                        </small>
                    </div>
                </div>
            `;
        } else {
            throw new Error(data.error || 'System check failed');
        }
    } catch (error) {
        document.getElementById('system-status').innerHTML = `
            <div class="d-flex align-items-center text-danger">
                <i class="fas fa-exclamation-triangle me-3 fs-4"></i>
                <div>
                    <strong>System Issue</strong>
                    <br><small class="text-muted">${error.message}</small>
                </div>
            </div>
        `;
        console.error('Health check failed:', error);
    }
}

function showSearchModal() {
    const modal = new bootstrap.Modal(document.getElementById('searchModal'));
    modal.show();

    // Focus search input when modal opens
    document.getElementById('searchModal').addEventListener('shown.bs.modal', function() {
        document.getElementById('searchInput').focus();
    });
}

function showBatchMode() {
    const modal = new bootstrap.Modal(document.getElementById('batchModal'));
    modal.show();
}

async function performSearch() {
    const searchInput = document.getElementById('searchInput');
    const resultsDiv = document.getElementById('searchResults');
    const query = searchInput.value.trim();

    if (query.length < 2) {
        showMessage('Please enter at least 2 characters to search', 'warning');
        return;
    }

    resultsDiv.innerHTML = `
        <div class="text-center">
            <div class="loading-spinner me-2"></div>
            Searching...
        </div>
    `;

    try {
        const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        if (data.success && data.results.length > 0) {
            let html = `<h6 class="mb-3">Found ${data.count} items:</h6>`;

            data.results.forEach(item => {
                const statusClass = item.status ?
                    `status-${item.status.toLowerCase().replace(' ', '-')}` : 'status-available';

                html += `
                    <div class="result-card mb-2">
                        <div class="row align-items-center">
                            <div class="col-8">
                                <strong>${item.tag_id}</strong>
                                <br><small class="text-muted">
                                    ${item.rental_class_id || 'N/A'} | ${item.bin_location || 'No location'}
                                </small>
                            </div>
                            <div class="col-4 text-end">
                                <span class="status-badge ${statusClass}">
                                    ${item.status || 'Available'}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        } else {
            resultsDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-search me-2"></i>
                    No items found matching "${query}"
                </div>
            `;
        }
    } catch (error) {
        resultsDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Search failed: ${error.message}
            </div>
        `;
        console.error('Search error:', error);
    }
}

// Allow Enter key to trigger search
document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        performSearch();
    }
});

// Periodic health check
setInterval(checkSystemHealth, 30000); // Check every 30 seconds
</script>
{% endblock %}
# .github/workflows/deploy.yml
# Version: 2025-08-06-v14
# Description: Deploys RFID Dashboard updates on Raspberry Pi using self-hosted runner
# Created: 2025-08-06
# Author: Grok 3 (assisted by xAI)

name: Deploy to Pi

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for git operations

      - name: Debug environment
        run: |
          echo "User: $(whoami)"
          echo "Host: $(hostname)"
          echo "Working directory: $(pwd)"

      - name: Update repository
        run: |
          set -e
          cd /home/tim/RFID3
          # Ensure clean state, excluding protected files
          git fetch origin
          git reset --hard origin/main
          echo "Repository updated to latest main"

      - name: Install dependencies
        run: |
          set -e
          cd /home/tim/RFID3
          source venv/bin/activate
          pip install -r requirements.txt
          echo "Dependencies installed"

      - name: Restart service
        run: |
          set -e
          sudo systemctl restart rfid_dash_dev.service
          sudo systemctl status rfid_dash_dev.service
          echo "Service restarted"

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Monitor - RFID Dashboard</title>
    
    <link rel="stylesheet" href="/static/css/common.css?v={{ cache_bust }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .metric-card {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            margin-bottom: 15px;
        }
        .metric-card.warning {
            border-left-color: #ffc107;
        }
        .metric-card.danger {
            border-left-color: #dc3545;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .metric-value.warning {
            color: #ffc107;
        }
        .metric-value.danger {
            color: #dc3545;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-healthy { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-danger { background-color: #dc3545; }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">RFID Dashboard</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link active" href="/performance">Performance</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Performance Monitor</h1>
            <div>
                <button class="btn btn-outline-secondary" onclick="refreshAll()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button class="btn btn-outline-warning" onclick="resetMetrics()" title="Reset performance metrics">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </div>

        <!-- System Overview -->
        <div class="row">
            <div class="col-md-3">
                <div class="card metric-card" id="system-status-card">
                    <div class="card-body text-center">
                        <div id="system-status" class="metric-value">
                            <span class="status-indicator status-healthy"></span>
                            Healthy
                        </div>
                        <small class="text-muted">System Status</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div id="cpu-usage" class="metric-value">--</div>
                        <small class="text-muted">CPU Usage (%)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div id="memory-usage" class="metric-value">--</div>
                        <small class="text-muted">Memory Usage (%)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <div id="total-requests" class="metric-value">--</div>
                        <small class="text-muted">Total Requests</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Response Time Trends</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="responseTimeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">System Resource Usage</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="resourceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Endpoint Performance Table -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Endpoint Performance</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="endpoint-table">
                                <thead>
                                    <tr>
                                        <th>Endpoint</th>
                                        <th>Requests</th>
                                        <th>Errors</th>
                                        <th>Error Rate</th>
                                        <th>Avg Response (ms)</th>
                                        <th>Recent Avg (ms)</th>
                                        <th>Max Response (ms)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td colspan="7" class="text-center">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Health -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Database Health</h5>
                    </div>
                    <div class="card-body">
                        <div id="database-info">
                            <p>Loading database metrics...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let responseTimeChart, resourceChart;
        let systemData = [];
        let refreshInterval;

        // Initialize charts
        function initCharts() {
            // Response Time Chart
            const ctx1 = document.getElementById('responseTimeChart').getContext('2d');
            responseTimeChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Avg Response Time (ms)',
                        data: [],
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Response Time (ms)' }
                        }
                    }
                }
            });

            // Resource Usage Chart
            const ctx2 = document.getElementById('resourceChart').getContext('2d');
            resourceChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU %',
                        data: [],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)'
                    }, {
                        label: 'Memory %',
                        data: [],
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: 'Usage (%)' }
                        }
                    }
                }
            });
        }

        // Fetch system metrics
        async function fetchSystemMetrics() {
            try {
                const response = await fetch('/api/performance/system');
                const data = await response.json();
                
                // Update UI
                document.getElementById('cpu-usage').textContent = data.system.cpu_percent.toFixed(1);
                document.getElementById('memory-usage').textContent = data.system.memory_percent.toFixed(1);
                
                // Update chart data
                const now = new Date().toLocaleTimeString();
                systemData.push({
                    time: now,
                    cpu: data.system.cpu_percent,
                    memory: data.system.memory_percent
                });
                
                // Keep last 20 data points
                if (systemData.length > 20) {
                    systemData.shift();
                }
                
                // Update resource chart
                resourceChart.data.labels = systemData.map(d => d.time);
                resourceChart.data.datasets[0].data = systemData.map(d => d.cpu);
                resourceChart.data.datasets[1].data = systemData.map(d => d.memory);
                resourceChart.update();
                
            } catch (error) {
                console.error('Failed to fetch system metrics:', error);
            }
        }

        // Fetch application metrics
        async function fetchApplicationMetrics() {
            try {
                const response = await fetch('/api/performance/application');
                const data = await response.json();
                
                // Update total requests
                document.getElementById('total-requests').textContent = data.total_requests || 0;
                
                // Update endpoint table
                const tbody = document.querySelector('#endpoint-table tbody');
                tbody.innerHTML = '';
                
                if (Object.keys(data.endpoints).length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No endpoint data available</td></tr>';
                } else {
                    Object.entries(data.endpoints).forEach(([endpoint, stats]) => {
                        const row = document.createElement('tr');
                        const errorRateClass = stats.error_rate > 5 ? 'text-danger' : stats.error_rate > 1 ? 'text-warning' : '';
                        const responseTimeClass = stats.avg_response_time > 1000 ? 'text-danger' : stats.avg_response_time > 500 ? 'text-warning' : '';
                        
                        row.innerHTML = `
                            <td><code>${endpoint || 'unknown'}</code></td>
                            <td>${stats.call_count}</td>
                            <td>${stats.error_count}</td>
                            <td class="${errorRateClass}">${stats.error_rate.toFixed(2)}%</td>
                            <td class="${responseTimeClass}">${stats.avg_response_time}</td>
                            <td>${stats.recent_avg_response_time}</td>
                            <td>${stats.max_response_time}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
                
            } catch (error) {
                console.error('Failed to fetch application metrics:', error);
            }
        }

        // Fetch database metrics
        async function fetchDatabaseMetrics() {
            try {
                const response = await fetch('/api/performance/database');
                const data = await response.json();
                
                const dbInfo = document.getElementById('database-info');
                let html = '<div class="row">';
                
                if (data.database_version) {
                    html += `<div class="col-md-6"><strong>Database Version:</strong> ${data.database_version}</div>`;
                }
                
                html += `<div class="col-md-6"><strong>Status:</strong> <span class="status-indicator status-healthy"></span> ${data.connection_status}</div>`;
                html += '</div>';
                
                if (data.table_stats) {
                    html += '<h6 class="mt-3">Table Statistics</h6><div class="row">';
                    Object.entries(data.table_stats).forEach(([table, stats]) => {
                        if (stats.row_count !== undefined) {
                            html += `<div class="col-md-4"><strong>${table}:</strong> ${stats.row_count.toLocaleString()} rows</div>`;
                        }
                    });
                    html += '</div>';
                }
                
                dbInfo.innerHTML = html;
                
            } catch (error) {
                console.error('Failed to fetch database metrics:', error);
                document.getElementById('database-info').innerHTML = 
                    '<div class="text-danger">Failed to load database metrics</div>';
            }
        }

        // Reset performance metrics
        async function resetMetrics() {
            if (confirm('Are you sure you want to reset all performance metrics?')) {
                try {
                    const response = await fetch('/api/performance/reset', { method: 'POST' });
                    const data = await response.json();
                    alert('Performance metrics reset successfully');
                    refreshAll();
                } catch (error) {
                    alert('Failed to reset metrics: ' + error.message);
                }
            }
        }

        // Refresh all data
        function refreshAll() {
            fetchSystemMetrics();
            fetchApplicationMetrics();
            fetchDatabaseMetrics();
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            refreshAll();
            
            // Set up auto-refresh every 5 seconds
            refreshInterval = setInterval(refreshAll, 5000);
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>
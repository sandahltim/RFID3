{% extends "base.html" %}

{% block title %}Tab 3 - Items in Service{% endblock %}

{% block content %}
<!-- Main heading for Tab 3 -->
<h1>Tab 3 - Items in Service</h1>

<!-- Filter and sort controls for item table -->
<div class="filter-sort-controls mb-4">
    <div class="row">
        <div class="col-md-4">
            <label for="commonNameFilterTab3">Filter by Common Name:</label>
            <input type="text" id="commonNameFilterTab3" class="form-control" value="{{ common_name_filter }}" placeholder="Enter common name">
        </div>
        <div class="col-md-4">
            <label for="dateFilterTab3">Filter by Last Scanned Date:</label>
            <input type="date" id="dateFilterTab3" class="form-control" value="{{ date_filter }}">
        </div>
        <div class="col-md-4">
            <label for="sortFilterTab3">Sort By:</label>
            <select id="sortFilterTab3" class="form-control">
                <option value="date_last_scanned_desc" {% if sort == 'date_last_scanned_desc' %}selected{% endif %}>Last Scanned (Newest First)</option>
                <option value="date_last_scanned_asc" {% if sort == 'date_last_scanned_asc' %}selected{% endif %}>Last Scanned (Oldest First)</option>
            </select>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-md-12">
            <button class="btn btn-primary" onclick="applyTab3Filters()">Apply Filters</button>
            <button class="btn btn-secondary" onclick="clearTab3Filters()">Clear Filters</button>
        </div>
    </div>
</div>

<!-- Items in Service section, grouped by common_name and status -->
<div class="items-section">
    <h3>Items in Service</h3>
    {% if common_name_groups %}
        {% for group in common_name_groups %}
            <div class="common-name-section mb-3">
                <h4>
                    <button class="btn btn-link expand-btn" data-target="common-{{ loop.index }}">
                        {{ group.common_name }} ({{ group.total_items }} items)
                    </button>
                </h4>
                <div id="common-{{ loop.index }}">
                    {% for status_group in group.status_groups %}
                        <div class="status-section ml-3 mb-2">
                            <h5>
                                <button class="btn btn-link expand-btn" data-target="status-{{ loop.parent.loop.index }}-{{ loop.index }}">
                                    {{ status_group.status }} ({{ status_group.total_items }} items)
                                </button>
                            </h5>
                            <div id="status-{{ loop.parent.loop.index }}-{{ loop.index }}">
                                <table class="table table-bordered status-table" id="status-table-{{ loop.parent.loop.index }}-{{ loop.index }}">
                                    <thead>
                                        <tr>
                                            <th>Tag ID</th>
                                            <th>Status</th>
                                            <th>Bin Location</th>
                                            <th>Last Contract</th>
                                            <th>Last Scanned Date</th>
                                            <th>Location of Repair</th>
                                            <th>Repair Types</th>
                                            <th>Transaction Details</th>
                                            <th>Notes</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in status_group.items %}
                                            <tr>
                                                <td>{{ item.tag_id }}</td>
                                                <td>
                                                    <select id="status-{{ item.tag_id }}" onchange="updateStatusVisibility('{{ item.tag_id }}')">
                                                        <option value="{{ item.status }}" selected>{{ item.status }}</option>
                                                        <option value="Ready to Rent">Ready to Rent</option>
                                                        <option value="Sold">Sold</option>
                                                        <option value="Repair">Repair</option>
                                                        <option value="Needs to be Inspected">Needs to be Inspected</option>
                                                        <option value="Staged">Staged</option>
                                                        <option value="Wash">Wash</option>
                                                        <option value="Wet">Wet</option>
                                                    </select>
                                                </td>
                                                <td>{{ item.bin_location }}</td>
                                                <td>{{ item.last_contract_num }}</td>
                                                <td class="date-last-scanned">{{ item.date_last_scanned }}</td>
                                                <td>{{ item.location_of_repair }}</td>
                                                <td>{{ item.repair_types | join(', ') }}</td>
                                                <td>
                                                    <ul>
                                                        <li><strong>Last Transaction Scan Date:</strong> {{ item.last_transaction_scan_date }}</li>
                                                        <li><strong>Dirty/Mud:</strong> {{ 'Yes' if item.dirty_or_mud else 'No' }}</li>
                                                        <li><strong>Leaves:</strong> {{ 'Yes' if item.leaves else 'No' }}</li>
                                                        <li><strong>Oil:</strong> {{ 'Yes' if item.oil else 'No' }}</li>
                                                        <li><strong>Mold:</strong> {{ 'Yes' if item.mold else 'No' }}</li>
                                                        <li><strong>Stain:</strong> {{ 'Yes' if item.stain else 'No' }}</li>
                                                        <li><strong>Oxidation:</strong> {{ 'Yes' if item.oxidation else 'No' }}</li>
                                                        <li><strong>Rip/Tear:</strong> {{ 'Yes' if item.rip_or_tear else 'No' }}</li>
                                                        <li><strong>Sewing Repair Needed:</strong> {{ 'Yes' if item.sewing_repair_needed else 'No' }}</li>
                                                        <li><strong>Grommet:</strong> {{ 'Yes' if item.grommet else 'No' }}</li>
                                                        <li><strong>Rope:</strong> {{ 'Yes' if item.rope else 'No' }}</li>
                                                        <li><strong>Buckle:</strong> {{ 'Yes' if item.buckle else 'No' }}</li>
                                                        <li><strong>Wet:</strong> {{ 'Yes' if item.wet else 'No' }}</li>
                                                        <li><strong>Other:</strong> {{ item.other }}</li>
                                                        <li><strong>Service Required:</strong> {{ 'Yes' if item.service_required else 'No' }}</li>
                                                        <li><strong>Longitude:</strong> {{ item.longitude if item.longitude is not none else 'N/A' }}</li>
                                                        <li><strong>Latitude:</strong> {{ item.latitude if item.latitude is not none else 'N/A' }}</li>
                                                    </ul>
                                                </td>
                                                <td>
                                                    <textarea id="notes-{{ item.tag_id }}" rows="2" class="form-control" data-original-notes="{{ item.notes | escape }}" oninput="updateNotesVisibility('{{ item.tag_id }}')">{{ item.notes | escape }}</textarea>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-primary save-status-btn" onclick="updateStatus('{{ item.tag_id }}')" style="display: none;">Save Status</button>
                                                    <button class="btn btn-sm btn-primary save-notes-btn" onclick="updateNotes('{{ item.tag_id }}')" style="display: none;">Save Notes</button>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p>No items currently in service. If this is unexpected, please check the database or contact support.</p>
    {% endif %}
</div>

<!-- Section for printing RFID tags -->
<div class="print-tags-section mt-4">
    <h4>Print RFID Tags</h4>
    <div class="form-group">
        <label for="commonNameSelect">Select Common Name (Pack/Resale):</label>
        <select id="commonNameSelect" class="form-control">
            <option value="">Select Common Name</option>
        </select>
    </div>
    <div class="form-group">
        <label for="tagQuantity">Number of Tags to Print:</label>
        <input type="number" id="tagQuantity" class="form-control" min="1" value="1">
    </div>
    <button id="syncToPcBtn" class="btn btn-primary mt-2">Sync to PC</button>
    <h5 class="mt-4">Synced Items</h5>
    <table class="table table-bordered" id="csvContentsTable">
        <thead>
            <tr>
                <th>Tag ID</th>
                <th>Common Name</th>
                <th>Status</th>
                <th>Bin Location</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="csvContentsBody"></tbody>
    </table>
    <button id="updateStatusBtn" class="btn btn-success mt-2" disabled>Update Status to Ready to Rent</button>
    <div id="syncMessage" class="mt-2"></div>
</div>

<style>
.common-name-section {
    border-left: 3px solid #007bff;
    padding-left: 10px;
}
.status-section {
    border-left: 3px solid #28a745;
    padding-left: 10px;
}
</style>

<!-- Fallback message for JavaScript issues -->
<noscript>
    <div style="color: red; text-align: center; margin: 20px;">
        <p>JavaScript is disabled or failed to load. Please enable JavaScript to use the expand/collapse functionality and other interactive features.</p>
    </div>
</noscript>
{% endblock %}
{% extends "base.html" %}

{% block title %}Tab 3 - Items in Service{% endblock %}

{% block content %}
    <h2>Service</h2>

    {% include 'global_filters.html' %}

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-header">Filters</div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label for="commonNameFilter">Filter by Common Name:</label>
                    <input type="text" class="form-control" id="commonNameFilter" value="{{ common_name_filter | escape }}">
                </div>
                <div class="col-md-3">
                    <label for="lastScannedFilter">Filter by Last Scanned Date:</label>
                    <input type="date" class="form-control" id="lastScannedFilter" value="{{ date_filter | escape }}">
                </div>
                <div class="col-md-3">
                    <label for="crewFilter">Filter by Crew:</label>
                    <select class="form-control" id="crewFilter">
                        <option value="" {% if crew_filter == '' %}selected{% endif %}>All</option>
                        <option value="Tent Crew" {% if crew_filter == 'Tent Crew' %}selected{% endif %}>Tent Crew</option>
                        <option value="Linen Crew" {% if crew_filter == 'Linen Crew' %}selected{% endif %}>Linen Crew</option>
                        <option value="Service Dept" {% if crew_filter == 'Service Dept' %}selected{% endif %}>Service Dept</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="sortFilter">Sort By:</label>
                    <select class="form-control" id="sortFilter">
                        <option value="date_last_scanned_desc" {% if sort == 'date_last_scanned_desc' %}selected{% endif %}>Last Scanned (Newest First)</option>
                        <option value="date_last_scanned_asc" {% if sort == 'date_last_scanned_asc' %}selected{% endif %}>Last Scanned (Oldest First)</option>
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <button class="btn btn-primary" onclick="applyTab3Filters()">Apply Filters</button>
                    <button class="btn btn-secondary" onclick="clearTab3Filters()">Clear Filters</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Table -->
    <h3>Items in Service</h3>
    {% if crew_groups.get('Tent Crew') or crew_groups.get('Linen Crew') or crew_groups.get('Service Dept') %}
        {% for crew in ['Tent Crew', 'Linen Crew', 'Service Dept'] %}
            {% if crew_groups.get(crew) %}
                <h3>{{ crew }}</h3>
                <table class="table table-bordered table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>Rental Class ID</th>
                            <th>Common Name</th>
                            <th>In Service</th>
                            <th>On Rent</th>
                            <th>Ready to Rent</th>
                            <th>Statuses</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in crew_groups[crew] %}
                            <tr>
                                <td>{{ group.rental_class_id | escape }}</td>
                                <td>{{ group.common_name | escape }}</td>
                                <td>{{ group.number_in_service }}</td>
                                <td>{{ group.number_on_rent }}</td>
                                <td>{{ group.number_ready_to_rent }}</td>
                                <td>{{ group.statuses | join(', ') | escape }}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-secondary expand-btn"
                                                data-identifier="{{ group.rental_class_id | regex_replace('[^a-z0-9]', '_') }}"
                                                data-target-id="expand-{{ group.rental_class_id | regex_replace('[^a-z0-9]', '_') }}-{{ loop.index }}"
                                                data-expanded="false">Expand</button>
                                        <button class="btn btn-sm btn-secondary collapse-btn"
                                                data-target-id="expand-{{ group.rental_class_id | regex_replace('[^a-z0-9]', '_') }}-{{ loop.index }}"
                                                style="display:none;">Collapse</button>
                                        <button class="btn btn-sm btn-primary print-btn"
                                                data-print-level="Contract"
                                                data-print-id="common-{{ group.rental_class_id | regex_replace('[^a-z0-9]', '_') }}"
                                                data-common-name="{{ group.common_name | escape }}"
                                                data-category="{{ group.category | escape }}">Print</button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="expandable-row">
                                <td colspan="7">
                                    <div id="expand-{{ group.rental_class_id | regex_replace('[^a-z0-9]', '_') }}-{{ loop.index }}"
                                         class="expandable collapsed">
                                        <table id="common-table-{{ group.rental_class_id | regex_replace('[^a-z0-9]', '_') }}-{{ loop.index }}"
                                               class="table table-bordered table-hover common-table">
                                            <thead class="thead-dark">
                                                <tr>
                                                    <th>Common Name</th>
                                                    <th>Items in Service</th>
                                                    <th>Total Items in Inventory</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>Loading...</td>
                                                    <td>-</td>
                                                    <td>-</td>
                                                    <td>-</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <div id="pagination-common-table-{{ group.rental_class_id | regex_replace('[^a-z0-9]', '_') }}-{{ loop.index }}"
                                             class="pagination-controls"></div>
                                        <div class="row-count"></div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        {% endfor %}
        {% if total_groups > per_page %}
            <div class="pagination-controls" id="pagination-controls"
                 data-total-groups="{{ total_groups }}"
                 data-current-page="{{ current_page }}"
                 data-per-page="{{ per_page }}">
                {% if current_page > 1 %}
                    <a class="btn btn-sm btn-secondary" href="/tab/3?page={{ current_page - 1 }}{% if common_name_filter %}&common_name={{ common_name_filter | urlencode }}{% endif %}{% if date_filter %}&date_last_scanned={{ date_filter | urlencode }}{% endif %}{% if sort %}&sort={{ sort | urlencode }}{% endif %}{% if crew_filter %}&crew={{ crew_filter | urlencode }}{% endif %}">Previous</a>
                {% endif %}
                <span>Page {{ current_page }} of {{ (total_groups / per_page) | round(0, 'ceil') | int }}</span>
                {% if current_page < (total_groups / per_page) | round(0, 'ceil') | int %}
                    <a class="btn btn-sm btn-secondary" href="/tab/3?page={{ current_page + 1 }}{% if common_name_filter %}&common_name={{ common_name_filter | urlencode }}{% endif %}{% if date_filter %}&date_last_scanned={{ date_filter | urlencode }}{% endif %}{% if sort %}&sort={{ sort | urlencode }}{% endif %}{% if crew_filter %}&crew={{ crew_filter | urlencode }}{% endif %}">Next</a>
                {% endif %}
                <span>Showing {{ crew_groups['Tent Crew']|length + crew_groups['Linen Crew']|length + crew_groups['Service Dept']|length }} of {{ total_groups }} groups</span>
            </div>
        {% endif %}
    {% else %}
        <div class="alert alert-info">
            No items currently in service. If this is unexpected, please check the database or contact support.
        </div>
    {% endif %}

    <!-- Print RFID Tags Section -->
    <h3 class="mt-4">Print RFID Tags</h3>
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label for="commonNameSelect">Select Common Name (Pack/Resale):</label>
                    <select class="form-control" id="commonNameSelect">
                        <option value="">Select Common Name</option>
                        {% for common_name in common_names %}
                            <option value="{{ common_name | escape }}">{{ common_name | escape }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="tagCount">Number of Tags to Print:</label>
                    <input type="number" class="form-control" id="tagCount" min="1">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12">
                    <button class="btn btn-primary" id="syncToPCBtn">Sync to PC</button>
                    <button class="btn btn-success" id="updateStatusToReady">Update Status to Ready to Rent</button>
                </div>
            </div>
            <div id="syncMessage" class="mt-3"></div>
        </div>
    </div>

    <!-- Synced Items Table -->
    <h3>Synced Items</h3>
    <table class="table table-bordered" id="syncedItems">
        <thead class="thead-dark">
            <tr>
                <th>Tag ID</th>
                <th>Common Name</th>
                <th>Status</th>
                <th>Bin Location</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Loading...</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
                <td>-</td>
            </tr>
        </tbody>
    </table>

    <!-- JavaScript Warning -->
    <noscript>
        <div class="alert alert-warning">
            JavaScript is disabled or failed to load. Please enable JavaScript to use the expand/collapse functionality and other interactive features.
        </div>
    </noscript>
</div>
{% endblock %}

{% extends "base.html" %}

{% block title %}Tab 3 - Items in Service{% endblock %}
{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/common.js') }}?v={{ cache_bust }}"></script>
    <script src="{{ url_for('static', filename='js/tab.js') }}?v={{ cache_bust }}"></script>
    <script src="{{ url_for('static', filename='js/tab3.js') }}?v={{ cache_bust }}"></script>
{% endblock %}

{% block content %}
<div class="container">
    <h2>Tab 3 - Items in Service</h2>

    <div class="filter-sort-controls mb-3">
        <div class="row">
            <div class="col-md-3">
                <label for="commonNameFilter">Filter by Common Name:</label>
                <input type="text" id="commonNameFilter" class="form-control" value="{{ common_name_filter | escape }}" placeholder="Enter common name">
            </div>
            <div class="col-md-3">
                <label for="lastScannedFilter">Filter by Last Scanned Date:</label>
                <input type="date" id="lastScannedFilter" class="form-control" value="{{ date_filter | escape }}">
            </div>
            <div class="col-md-3">
                <label for="crewFilter">Filter by Crew:</label>
                <select id="crewFilter" class="form-control">
                    <option value="">All</option>
                    <option value="Tent Crew" {% if crew_filter == 'Tent Crew' %}selected{% endif %}>Tent Crew</option>
                    <option value="Linen Crew" {% if crew_filter == 'Linen Crew' %}selected{% endif %}>Linen Crew</option>
                    <option value="Service Dept" {% if crew_filter == 'Service Dept' %}selected{% endif %}>Service Dept</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="sortFilter">Sort By:</label>
                <select id="sortFilter" class="form-control">
                    <option value="date_last_scanned_desc" {% if sort == 'date_last_scanned_desc' %}selected{% endif %}>Last Scanned (Newest First)</option>
                    <option value="date_last_scanned_asc" {% if sort == 'date_last_scanned_asc' %}selected{% endif %}>Last Scanned (Oldest First)</option>
                </select>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-md-12">
                <button class="btn btn-primary btn-sm" onclick="applyTab3Filters()">Apply Filters</button>
                <button class="btn btn-secondary btn-sm" onclick="clearTab3Filters()">Clear Filters</button>
            </div>
        </div>
    </div>

    <h4>Items in Service</h4>

    {% if crew_groups.get('Tent Crew') or crew_groups.get('Linen Crew') or crew_groups.get('Service Dept') %}
        {% for crew in ['Tent Crew', 'Linen Crew', 'Service Dept'] %}
            {% if crew_groups.get(crew) %}
                <h4>{{ crew }}</h4>
                <table class="table table-bordered table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>Rental Class ID</th>
                            <th>Common Name</th>
                            <th>In Service</th>
                            <th>On Rent</th>
                            <th>Ready to Rent</th>
                            <th>Statuses</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for group in crew_groups[crew] %}
                            <tr>
                                <td>{{ group.rental_class_id }}</td>
                                <td>{{ group.common_name }}</td>
                                <td>{{ group.number_in_service }}</td>
                                <td>{{ group.number_on_rent }}</td>
                                <td>{{ group.number_ready_to_rent }}</td>
                                <td>{{ group.statuses | join(', ') }}</td>
                                <td>
                                    <button class="btn btn-sm btn-secondary expand-btn" 
                                            data-target-id="expand-{{ group.rental_class_id | replace(' ', '_') }}-{{ loop.index }}" 
                                            data-identifier="{{ group.rental_class_id }}">Expand</button>
                                    <button class="btn btn-sm btn-secondary collapse-btn" 
                                            data-target-id="expand-{{ group.rental_class_id | replace(' ', '_') }}-{{ loop.index }}" 
                                            style="display:none;">Collapse</button>
                                    <button class="btn btn-sm btn-info print-btn" 
                                            data-print-level="Common Name" 
                                            data-print-id="expand-{{ group.rental_class_id | replace(' ', '_') }}-{{ loop.index }}" 
                                            data-common-name="{{ group.common_name | escape }}"
                                            data-category="{{ group.rental_class_id | escape }}">Print</button>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="7">
                                    <div id="expand-{{ group.rental_class_id | replace(' ', '_') }}-{{ loop.index }}" class="expandable collapsed">
                                        <table id="common-table-{{ group.rental_class_id | replace(' ', '_') }}-{{ loop.index }}" class="table table-bordered table-hover common-table">
                                            <thead class="thead-dark">
                                                <tr>
                                                    <th>Common Name</th>
                                                    <th>Items in Service</th>
                                                    <th>Total Items in Inventory</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr><td colspan="3">Loading...</td></tr>
                                            </tbody>
                                        </table>
                                        <div id="pagination-common-table-{{ group.rental_class_id | replace(' ', '_') }}-{{ loop.index }}" class="pagination-controls mt-2"></div>
                                        <div class="row-count mt-2">Loading...</div>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}
        {% endfor %}
        {% if total_groups > per_page %}
            <div class="pagination-controls mt-3">
                {% if current_page > 1 %}
                    <a href="/tab/3?page={{ current_page - 1 }}{% if common_name_filter %}&common_name={{ common_name_filter | urlencode }}{% endif %}{% if date_filter %}&date_last_scanned={{ date_filter | urlencode }}{% endif %}{% if sort %}&sort={{ sort | urlencode }}{% endif %}{% if crew_filter %}&crew={{ crew_filter | urlencode }}{% endif %}" class="btn btn-sm btn-secondary">Previous</a>
                {% endif %}
                <div id="pagination-controls" class="pagination-controls mt-2"></div>
                {% if current_page < (total_groups / per_page) | round(0, 'ceil') | int %}
                    <a href="/tab/3?page={{ current_page + 1 }}{% if common_name_filter %}&common_name={{ common_name_filter | urlencode }}{% endif %}{% if date_filter %}&date_last_scanned={{ date_filter | urlencode }}{% endif %}{% if sort %}&sort={{ sort | urlencode }}{% endif %}{% if crew_filter %}&crew={{ crew_filter | urlencode }}{% endif %}" class="btn btn-sm btn-secondary">Next</a>
                {% endif %}
                <div class="row-count mt-2">Showing {{ crew_groups['Tent Crew']|length + crew_groups['Linen Crew']|length + crew_groups['Service Dept']|length }} of {{ total_groups }} groups</div>
            </div>
        {% endif %}
    {% else %}
        <p>No items currently in service. If this is unexpected, please check the database or contact support.</p>
    {% endif %}

    <h4>Print RFID Tags</h4>
    <div id="syncMessage" class="mb-3"></div>
    <div class="row mb-3">
        <div class="col-md-4">
            <label for="commonNameSelect">Select Common Name (Pack/Resale):</label>
            <select id="commonNameSelect" class="form-control">
                <option value="">Select Common Name</option>
                {% for common_name in common_names %}
                    <option value="{{ common_name | escape }}">{{ common_name | escape }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="tagCount">Number of Tags to Print:</label>
            <input type="number" id="tagCount" class="form-control" min="1">
        </div>
        <div class="col-md-4 align-self-end">
            <button id="syncToPCBtn" class="btn btn-primary btn-sm">Sync to PC</button>
            <button id="updateStatusToReady" class="btn btn-success btn-sm">Update Status to Ready to Rent</button>
        </div>
    </div>

    <h4>Synced Items</h4>
    <table id="syncedItems" class="table table-bordered table-hover">
        <thead class="thead-dark">
            <tr>
                <th>Tag ID</th>
                <th>Common Name</th>
                <th>Status</th>
                <th>Bin Location</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="5">Loading...</td></tr>
        </tbody>
    </table>

    <p class="text-muted">JavaScript is disabled or failed to load. Please enable JavaScript to use the expand/collapse functionality and other interactive features.</p>
</div>
{% endblock %}
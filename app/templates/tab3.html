{% extends "base.html" %}

{% block title %}Tab 3 - Items in Service{% endblock %}

{% block content %}
<h1>Tab 3 - Items in Service</h1>

<div class="filter-sort-controls mb-4">
    <div class="row">
        <div class="col-md-4">
            <label for="commonNameFilterTab3">Filter by Common Name:</label>
            <input type="text" id="commonNameFilterTab3" class="form-control" value="{{ common_name_filter }}" placeholder="Enter common name">
        </div>
        <div class="col-md-4">
            <label for="dateFilterTab3">Filter by Last Scanned Date:</label>
            <input type="date" id="dateFilterTab3" class="form-control" value="{{ date_filter }}">
        </div>
        <div class="col-md-4">
            <label for="sortFilterTab3">Sort By:</label>
            <select id="sortFilterTab3" class="form-control">
                <option value="date_last_scanned_desc" {% if sort == 'date_last_scanned_desc' %}selected{% endif %}>Last Scanned (Newest First)</option>
                <option value="date_last_scanned_asc" {% if sort == 'date_last_scanned_asc' %}selected{% endif %}>Last Scanned (Oldest First)</option>
            </select>
        </div>
    </div>
    <div class="row mt-2">
        <div class="col-md-12">
            <button class="btn btn-primary" onclick="applyTab3Filters()">Apply Filters</button>
            <button class="btn btn-secondary" onclick="clearTab3Filters()">Clear Filters</button>
        </div>
    </div>
</div>

{% for crew in crews %}
<div class="crew-section">
    <h3>
        {{ crew.name }} Items
        <button class="btn btn-sm btn-info toggle-crew" data-crew-id="{{ crew.name | lower | replace(' ', '-') }}">
            {% if crew.item_list | length > 20 %}Show More{% else %}Expand{% endif %}
        </button>
    </h3>
    <div class="expandable collapsed" id="crew-content-{{ crew.name | lower | replace(' ', '-') }}">
        {% if crew.item_list %}
            <table class="table table-bordered crew-table" id="crew-table-{{ crew.name | lower | replace(' ', '-') }}" data-crew-id="{{ crew.name | lower | replace(' ', '-') }}">
                <thead>
                    <tr>
                        <th>Tag ID</th>
                        <th>Common Name</th>
                        <th>Status</th>
                        <th>Bin Location</th>
                        <th>Last Contract</th>
                        <th>Last Scanned Date</th>
                        <th>Location of Repair</th>
                        <th>Repair Types</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in crew.item_list %}
                        <tr>
                            <td>{{ item.tag_id }}</td>
                            <td>{{ item.common_name }}</td>
                            <td>
                                <select id="status-{{ item.tag_id }}" onchange="updateStatusVisibility('{{ item.tag_id }}')">
                                    <option value="{{ item.status }}" selected>{{ item.status }}</option>
                                    <option value="Ready to Rent">Ready to Rent</option>
                                    <option value="Sold">Sold</option>
                                    <option value="Repair">Repair</option>
                                    <option value="Needs to be Inspected">Needs to be Inspected</option>
                                    <option value="Staged">Staged</option>
                                    <option value="Wash">Wash</option>
                                    <option value="Wet">Wet</option>
                                </select>
                            </td>
                            <td>{{ item.bin_location }}</td>
                            <td>{{ item.last_contract_num }}</td>
                            <td class="date-last-scanned">{{ item.date_last_scanned }}</td>
                            <td>{{ item.location_of_repair }}</td>
                            <td>{{ item.repair_types | join(', ') }}</td>
                            <td>
                                <button class="btn btn-sm btn-primary save-btn" onclick="updateStatus('{{ item.tag_id }}')">Save</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="pagination-controls" id="pagination-{{ crew.name | lower | replace(' ', '-') }}"></div>
            <div class="row-count" id="row-count-{{ crew.name | lower | replace(' ', '-') }}">
                Showing {{ crew.item_list | length }} of {{ crew.total_items }} items
            </div>
        {% else %}
            <p>No items currently in service for {{ crew.name }}.</p>
        {% endif %}
    </div>
</div>
{% endfor %}

<div class="print-tags-section mt-4">
    <h4>Print RFID Tags</h4>
    <div class="form-group">
        <label for="commonNameSelect">Select Common Name (Pack/Resale):</label>
        <select id="commonNameSelect" class="form-control">
            <option value="">Select Common Name</option>
        </select>
    </div>
    <div class="form-group">
        <label for="tagQuantity">Number of Tags to Print:</label>
        <input type="number" id="tagQuantity" class="form-control" min="1" value="1">
    </div>
    <button id="syncToPcBtn" class="btn btn-primary mt-2">Sync to PC</button>
    <button id="updateStatusBtn" class="btn btn-success mt-2" disabled>Update Status to Ready to Rent</button>
    <div id="syncMessage" class="mt-2"></div>
</div>

<script src="/static/js/tab3.js?v={{ cache_bust }}"></script>
{% endblock %}
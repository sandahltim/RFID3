{% extends "base.html" %}

{% block title %}Suggestion Management Dashboard{% endblock %}

{% block extra_css %}
<style>
.admin-dashboard {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    min-height: 100vh;
    padding: 20px 0;
}

.dashboard-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin: 20px auto;
    overflow: hidden;
}

.dashboard-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    text-align: center;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    padding: 30px;
    background-color: #f8f9fa;
}

.stat-card {
    background: white;
    border-radius: 10px;
    padding: 25px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-left: 5px solid #667eea;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-number {
    font-size: 3rem;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 10px;
}

.stat-label {
    color: #6c757d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.suggestions-table {
    background: white;
    margin: 0 30px 30px 30px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.table-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.filter-section {
    padding: 20px 30px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.suggestion-row {
    border-bottom: 1px solid #e9ecef;
    padding: 20px 30px;
    transition: background-color 0.3s ease;
}

.suggestion-row:hover {
    background-color: #f8f9fa;
}

.suggestion-row:last-child {
    border-bottom: none;
}

.priority-badge {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
    text-transform: uppercase;
}

.priority-1 { background-color: #d4edda; color: #155724; }
.priority-2 { background-color: #cce5ff; color: #004085; }
.priority-3 { background-color: #fff3cd; color: #856404; }
.priority-4 { background-color: #f8d7da; color: #721c24; }
.priority-5 { background-color: #f5c6cb; color: #721c24; }

.status-badge {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
    text-transform: uppercase;
}

.status-submitted { background-color: #e2e3e5; color: #383d41; }
.status-under_review { background-color: #cce5ff; color: #004085; }
.status-validated { background-color: #d4edda; color: #155724; }
.status-implemented { background-color: #d1ecf1; color: #0c5460; }
.status-rejected { background-color: #f8d7da; color: #721c24; }

.category-tag {
    background-color: #667eea;
    color: white;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.75em;
    margin-right: 5px;
}

.action-buttons {
    display: flex;
    gap: 10px;
    margin-top: 15px;
}

.btn-action {
    padding: 5px 15px;
    border: none;
    border-radius: 20px;
    font-size: 0.8em;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-review { background-color: #007bff; color: white; }
.btn-validate { background-color: #28a745; color: white; }
.btn-implement { background-color: #17a2b8; color: white; }
.btn-reject { background-color: #dc3545; color: white; }

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.suggestion-details {
    background-color: #f8f9fa;
    margin-top: 15px;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #667eea;
}

.validation-results {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
    border: 1px solid #28a745;
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
}

.correlation-strength {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 600;
}

.strength-very-weak { background-color: #f8d7da; color: #721c24; }
.strength-weak { background-color: #fff3cd; color: #856404; }
.strength-moderate { background-color: #cce5ff; color: #004085; }
.strength-strong { background-color: #d4edda; color: #155724; }
.strength-very-strong { background-color: #d1ecf1; color: #0c5460; }

.modal-xl {
    max-width: 90%;
}

.review-modal .modal-body {
    max-height: 70vh;
    overflow-y: auto;
}
</style>
{% endblock %}

{% block content %}
<div class="admin-dashboard">
    <div class="container-fluid">
        <div class="dashboard-container">
            
            <!-- Header -->
            <div class="dashboard-header">
                <h1 class="display-4 mb-3">
                    <i class="fas fa-cogs"></i>
                    Suggestion Management Dashboard
                </h1>
                <p class="lead">Review, validate, and implement user suggestions for analytics improvements</p>
            </div>

            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalSuggestions">0</div>
                    <div class="stat-label">Total Suggestions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingSuggestions">0</div>
                    <div class="stat-label">Pending Review</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="implementedSuggestions">0</div>
                    <div class="stat-label">Implemented</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="implementationRate">0%</div>
                    <div class="stat-label">Implementation Rate</div>
                </div>
            </div>

            <!-- Suggestions Table -->
            <div class="suggestions-table">
                <div class="table-header">
                    <h3><i class="fas fa-list"></i> Suggestions Queue</h3>
                    <div>
                        <button class="btn btn-light" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="btn btn-success" onclick="validateAllPending()">
                            <i class="fas fa-check-double"></i> Validate All Pending
                        </button>
                    </div>
                </div>

                <!-- Filters -->
                <div class="filter-section">
                    <div class="row">
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter" onchange="applyFilters()">
                                <option value="">All Statuses</option>
                                <option value="SUBMITTED">Submitted</option>
                                <option value="UNDER_REVIEW">Under Review</option>
                                <option value="VALIDATED">Validated</option>
                                <option value="IMPLEMENTED">Implemented</option>
                                <option value="REJECTED">Rejected</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="categoryFilter" onchange="applyFilters()">
                                <option value="">All Categories</option>
                                <option value="WEATHER_CORRELATION">Weather Correlation</option>
                                <option value="SEASONAL_PATTERN">Seasonal Pattern</option>
                                <option value="CUSTOMER_BEHAVIOR">Customer Behavior</option>
                                <option value="ECONOMIC_INDICATOR">Economic Indicator</option>
                                <option value="OPERATIONAL_INSIGHT">Operational Insight</option>
                                <option value="GEOGRAPHIC_PATTERN">Geographic Pattern</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="priorityFilter" onchange="applyFilters()">
                                <option value="">All Priorities</option>
                                <option value="5">Critical (5)</option>
                                <option value="4">High (4)</option>
                                <option value="3">Medium (3)</option>
                                <option value="2">Low (2)</option>
                                <option value="1">Very Low (1)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchFilter" placeholder="Search suggestions..." onkeyup="applyFilters()">
                        </div>
                    </div>
                </div>

                <!-- Suggestions List -->
                <div id="suggestionsList">
                    <!-- Suggestions will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content review-modal">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-eye"></i>
                    Review Suggestion
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="reviewContent">
                    <!-- Review content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <button type="button" class="btn btn-success" onclick="updateSuggestionStatus('VALIDATED')">
                        <i class="fas fa-check"></i> Validate
                    </button>
                    <button type="button" class="btn btn-info" onclick="updateSuggestionStatus('UNDER_REVIEW')">
                        <i class="fas fa-search"></i> Under Review
                    </button>
                    <button type="button" class="btn btn-warning" onclick="updateSuggestionStatus('IMPLEMENTED')">
                        <i class="fas fa-cog"></i> Mark Implemented
                    </button>
                    <button type="button" class="btn btn-danger" onclick="rejectSuggestion()">
                        <i class="fas fa-times"></i> Reject
                    </button>
                </div>
                <div>
                    <button type="button" class="btn btn-primary" onclick="runValidation()">
                        <i class="fas fa-robot"></i> Run ML Validation
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">Update Suggestion Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusUpdateForm">
                    <div class="mb-3">
                        <label for="adminNotes" class="form-label">Admin Notes</label>
                        <textarea class="form-control" id="adminNotes" rows="3" placeholder="Add your review notes..."></textarea>
                    </div>
                    <div class="mb-3" id="rejectionReasonDiv" style="display: none;">
                        <label for="rejectionReason" class="form-label">Rejection Reason</label>
                        <textarea class="form-control" id="rejectionReason" rows="2" placeholder="Why is this suggestion being rejected?"></textarea>
                    </div>
                    <div class="mb-3" id="implementationNotesDiv" style="display: none;">
                        <label for="implementationNotes" class="form-label">Implementation Notes</label>
                        <textarea class="form-control" id="implementationNotes" rows="2" placeholder="Implementation details and timeline..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="confirmStatusUpdate()">Update Status</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSuggestionId = null;
let currentStatus = null;
let allSuggestions = [];

document.addEventListener('DOMContentLoaded', function() {
    loadDashboard();
});

async function loadDashboard() {
    await Promise.all([
        loadStatistics(),
        loadSuggestions()
    ]);
}

async function loadStatistics() {
    try {
        const response = await fetch('/api/suggestions/analytics?days=30');
        const data = await response.json();
        
        document.getElementById('totalSuggestions').textContent = data.total_suggestions || 0;
        document.getElementById('implementedSuggestions').textContent = data.implemented_count || 0;
        document.getElementById('implementationRate').textContent = data.implementation_rate + '%' || '0%';
        
        // Calculate pending suggestions
        const statusBreakdown = data.status_breakdown || [];
        const pending = statusBreakdown
            .filter(s => ['SUBMITTED', 'UNDER_REVIEW'].includes(s.status))
            .reduce((sum, s) => sum + s.count, 0);
        document.getElementById('pendingSuggestions').textContent = pending;
        
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

async function loadSuggestions() {
    try {
        const response = await fetch('/api/suggestions/list?per_page=50&sort_by=priority&sort_order=desc');
        const data = await response.json();
        
        allSuggestions = data.suggestions || [];
        displaySuggestions(allSuggestions);
        
    } catch (error) {
        console.error('Error loading suggestions:', error);
        document.getElementById('suggestionsList').innerHTML = '<p class="text-center text-muted p-4">Error loading suggestions</p>';
    }
}

function displaySuggestions(suggestions) {
    const container = document.getElementById('suggestionsList');
    
    if (suggestions.length === 0) {
        container.innerHTML = '<p class="text-center text-muted p-4">No suggestions found</p>';
        return;
    }
    
    container.innerHTML = suggestions.map(suggestion => `
        <div class="suggestion-row" data-id="${suggestion.suggestion_id}">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-2">
                        <span class="category-tag">${formatCategory(suggestion.category)}</span>
                        <span class="priority-badge priority-${suggestion.priority_score}">
                            Priority ${suggestion.priority_score}
                        </span>
                        <span class="status-badge status-${suggestion.status.toLowerCase()}">
                            ${formatStatus(suggestion.status)}
                        </span>
                    </div>
                    
                    <h5 class="mb-2">${suggestion.title}</h5>
                    <p class="text-muted mb-2">${truncateText(suggestion.description, 150)}</p>
                    
                    <div class="row text-muted small">
                        <div class="col-md-3">
                            <i class="fas fa-user"></i> ${suggestion.user_name} (${suggestion.user_role || 'Unknown'})
                        </div>
                        <div class="col-md-3">
                            <i class="fas fa-map-marker-alt"></i> ${suggestion.store_location || 'All Stores'}
                        </div>
                        <div class="col-md-3">
                            <i class="fas fa-calendar"></i> ${formatDate(suggestion.submitted_date)}
                        </div>
                        <div class="col-md-3">
                            <i class="fas fa-thumbs-up"></i> ${suggestion.upvotes || 0} 
                            <i class="fas fa-thumbs-down ms-2"></i> ${suggestion.downvotes || 0}
                        </div>
                    </div>
                    
                    ${suggestion.analytics ? renderValidationResults(suggestion.analytics) : ''}
                </div>
                
                <div class="ms-3">
                    <div class="action-buttons">
                        <button class="btn-action btn-review" onclick="reviewSuggestion(${suggestion.suggestion_id})">
                            <i class="fas fa-eye"></i> Review
                        </button>
                        ${renderStatusActions(suggestion)}
                    </div>
                </div>
            </div>
            
            ${renderSuggestionDetails(suggestion)}
        </div>
    `).join('');
}

function renderValidationResults(analytics) {
    if (!analytics) return '';
    
    const correlation = analytics.correlation_coefficient;
    const pValue = analytics.p_value;
    const feasibility = analytics.overall_feasibility_score;
    
    return `
        <div class="validation-results mt-3">
            <h6><i class="fas fa-robot"></i> Validation Results</h6>
            <div class="row">
                ${correlation !== null ? `
                    <div class="col-md-4">
                        <strong>Correlation:</strong> ${correlation.toFixed(3)}<br>
                        <span class="correlation-strength strength-${getCorrelationStrengthClass(Math.abs(correlation))}">
                            ${getCorrelationStrength(Math.abs(correlation))}
                        </span>
                    </div>
                ` : ''}
                ${pValue !== null ? `
                    <div class="col-md-4">
                        <strong>Significance:</strong><br>
                        <span class="${pValue < 0.05 ? 'text-success' : 'text-warning'}">
                            p-value: ${pValue.toFixed(4)} ${pValue < 0.05 ? '✓' : '?'}
                        </span>
                    </div>
                ` : ''}
                ${feasibility !== null ? `
                    <div class="col-md-4">
                        <strong>Feasibility:</strong><br>
                        <span class="${feasibility >= 70 ? 'text-success' : feasibility >= 40 ? 'text-warning' : 'text-danger'}">
                            ${feasibility.toFixed(1)}% ${getFeasibilityIcon(feasibility)}
                        </span>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
}

function renderStatusActions(suggestion) {
    const status = suggestion.status;
    
    if (status === 'SUBMITTED') {
        return `
            <button class="btn-action btn-validate" onclick="updateSuggestionStatus('VALIDATED', ${suggestion.suggestion_id})">
                <i class="fas fa-check"></i> Validate
            </button>
        `;
    } else if (status === 'VALIDATED') {
        return `
            <button class="btn-action btn-implement" onclick="updateSuggestionStatus('IMPLEMENTED', ${suggestion.suggestion_id})">
                <i class="fas fa-cog"></i> Implement
            </button>
        `;
    } else if (status === 'UNDER_REVIEW') {
        return `
            <button class="btn-action btn-validate" onclick="updateSuggestionStatus('VALIDATED', ${suggestion.suggestion_id})">
                <i class="fas fa-check"></i> Validate
            </button>
        `;
    }
    
    return '';
}

function renderSuggestionDetails(suggestion) {
    const details = [];
    
    if (suggestion.correlation_factor_1 && suggestion.correlation_factor_2) {
        details.push(`<strong>Correlation:</strong> ${suggestion.correlation_factor_1} ↔ ${suggestion.correlation_factor_2}`);
    }
    
    if (suggestion.expected_business_impact) {
        details.push(`<strong>Expected Impact:</strong> ${suggestion.expected_business_impact}`);
    }
    
    if (suggestion.seasonal_relevance) {
        details.push(`<strong>Season:</strong> ${suggestion.seasonal_relevance}`);
    }
    
    if (details.length === 0) return '';
    
    return `
        <div class="suggestion-details mt-3">
            ${details.join(' • ')}
        </div>
    `;
}

async function reviewSuggestion(suggestionId) {
    try {
        currentSuggestionId = suggestionId;
        
        const response = await fetch(`/api/suggestions/${suggestionId}`);
        const suggestion = await response.json();
        
        document.getElementById('reviewContent').innerHTML = renderDetailedReview(suggestion);
        new bootstrap.Modal(document.getElementById('reviewModal')).show();
        
    } catch (error) {
        console.error('Error loading suggestion details:', error);
        alert('Error loading suggestion details');
    }
}

function renderDetailedReview(suggestion) {
    return `
        <div class="row">
            <div class="col-md-8">
                <h4>${suggestion.title}</h4>
                <div class="mb-3">
                    <span class="category-tag">${formatCategory(suggestion.category)}</span>
                    <span class="priority-badge priority-${suggestion.priority_score}">Priority ${suggestion.priority_score}</span>
                    <span class="status-badge status-${suggestion.status.toLowerCase()}">${formatStatus(suggestion.status)}</span>
                </div>
                
                <div class="mb-4">
                    <h6>Description</h6>
                    <p>${suggestion.description}</p>
                </div>
                
                <div class="mb-4">
                    <h6>Business Justification</h6>
                    <p>${suggestion.business_justification}</p>
                </div>
                
                ${suggestion.correlation_factor_1 ? `
                    <div class="mb-4">
                        <h6>Correlation Details</h6>
                        <p><strong>Factor 1:</strong> ${suggestion.correlation_factor_1}</p>
                        <p><strong>Factor 2:</strong> ${suggestion.correlation_factor_2}</p>
                        <p><strong>Expected Relationship:</strong> ${suggestion.expected_relationship || 'Not specified'}</p>
                        <p><strong>Strength Estimate:</strong> ${suggestion.correlation_strength_estimate || 'Not specified'}</p>
                    </div>
                ` : ''}
                
                ${suggestion.historical_examples ? `
                    <div class="mb-4">
                        <h6>Historical Examples</h6>
                        <p>${suggestion.historical_examples}</p>
                    </div>
                ` : ''}
                
                ${suggestion.analytics ? renderDetailedValidation(suggestion.analytics) : ''}
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Submission Info</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Submitted by:</strong> ${suggestion.user_name}</p>
                        <p><strong>Role:</strong> ${suggestion.user_role || 'Not specified'}</p>
                        <p><strong>Store:</strong> ${suggestion.store_location || 'All Stores'}</p>
                        <p><strong>Experience:</strong> ${suggestion.years_experience ? suggestion.years_experience + ' years' : 'Not specified'}</p>
                        <p><strong>Date:</strong> ${formatDate(suggestion.submitted_date)}</p>
                        <p><strong>Confidence:</strong> ${suggestion.confidence_level || 3}/5</p>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Business Impact</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Expected Impact:</strong> ${suggestion.expected_business_impact || 'Not specified'}</p>
                        ${suggestion.revenue_impact_estimate ? `<p><strong>Revenue Impact:</strong> $${suggestion.revenue_impact_estimate.toLocaleString()}</p>` : ''}
                        ${suggestion.cost_savings_estimate ? `<p><strong>Cost Savings:</strong> $${suggestion.cost_savings_estimate.toLocaleString()}</p>` : ''}
                        <p><strong>Complexity:</strong> ${suggestion.implementation_complexity || 'Medium'}</p>
                        ${suggestion.estimated_timeline ? `<p><strong>Timeline:</strong> ${suggestion.estimated_timeline}</p>` : ''}
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="fas fa-map"></i> Minnesota Context</h6>
                    </div>
                    <div class="card-body">
                        <p><strong>Season:</strong> ${suggestion.seasonal_relevance || 'Year-round'}</p>
                        <p><strong>Weather Dependency:</strong> ${suggestion.weather_dependency || 'None'}</p>
                        <p><strong>Geographic Scope:</strong> ${suggestion.geographic_scope || 'Single store'}</p>
                        <p><strong>Market Segment:</strong> ${suggestion.market_segment || 'All'}</p>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderDetailedValidation(analytics) {
    return `
        <div class="validation-results">
            <h6><i class="fas fa-robot"></i> Detailed Validation Results</h6>
            <div class="row">
                ${analytics.correlation_coefficient !== null ? `
                    <div class="col-md-6">
                        <strong>Correlation Coefficient:</strong><br>
                        ${analytics.correlation_coefficient.toFixed(4)}<br>
                        <span class="correlation-strength strength-${getCorrelationStrengthClass(Math.abs(analytics.correlation_coefficient))}">
                            ${getCorrelationStrength(Math.abs(analytics.correlation_coefficient))}
                        </span>
                    </div>
                ` : ''}
                ${analytics.p_value !== null ? `
                    <div class="col-md-6">
                        <strong>Statistical Significance:</strong><br>
                        p-value: ${analytics.p_value.toFixed(6)}<br>
                        <span class="${analytics.p_value < 0.05 ? 'text-success' : 'text-warning'}">
                            ${analytics.p_value < 0.05 ? 'Statistically significant ✓' : 'Not significant ⚠'}
                        </span>
                    </div>
                ` : ''}
            </div>
            
            ${analytics.overall_feasibility_score !== null ? `
                <div class="mt-3">
                    <strong>Overall Feasibility Score:</strong>
                    <div class="progress mt-2">
                        <div class="progress-bar ${getFeasibilityProgressClass(analytics.overall_feasibility_score)}" 
                             style="width: ${analytics.overall_feasibility_score}%">
                            ${analytics.overall_feasibility_score.toFixed(1)}%
                        </div>
                    </div>
                </div>
            ` : ''}
            
            ${analytics.recommendations ? `
                <div class="mt-3">
                    <strong>AI Recommendations:</strong>
                    <ul class="mt-2">
                        ${analytics.recommendations.split('\n').map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
        </div>
    `;
}

function updateSuggestionStatus(status, suggestionId = null) {
    currentStatus = status;
    currentSuggestionId = suggestionId || currentSuggestionId;
    
    // Show/hide relevant fields based on status
    document.getElementById('rejectionReasonDiv').style.display = status === 'REJECTED' ? 'block' : 'none';
    document.getElementById('implementationNotesDiv').style.display = status === 'IMPLEMENTED' ? 'block' : 'none';
    
    // Clear form
    document.getElementById('statusUpdateForm').reset();
    
    // Show modal
    new bootstrap.Modal(document.getElementById('statusUpdateModal')).show();
}

async function confirmStatusUpdate() {
    if (!currentSuggestionId || !currentStatus) return;
    
    const adminNotes = document.getElementById('adminNotes').value;
    const rejectionReason = document.getElementById('rejectionReason').value;
    const implementationNotes = document.getElementById('implementationNotes').value;
    
    try {
        const response = await fetch(`/api/suggestions/${currentSuggestionId}/update_status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                status: currentStatus,
                admin_notes: adminNotes,
                rejection_reason: rejectionReason,
                implementation_notes: implementationNotes,
                reviewed_by: 'admin' // In real implementation, get from auth
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Close modals
            bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal')).hide();
            if (document.getElementById('reviewModal').classList.contains('show')) {
                bootstrap.Modal.getInstance(document.getElementById('reviewModal')).hide();
            }
            
            // Refresh dashboard
            loadDashboard();
            
            alert(`Suggestion status updated to ${currentStatus}`);
        } else {
            throw new Error(result.error || 'Failed to update status');
        }
        
    } catch (error) {
        console.error('Error updating status:', error);
        alert('Error updating status: ' + error.message);
    }
}

async function runValidation(suggestionId = null) {
    const targetId = suggestionId || currentSuggestionId;
    if (!targetId) return;
    
    try {
        // This would call the validation service
        alert('ML validation initiated. Results will be available shortly.');
        
        // In real implementation, you would:
        // 1. Call the validation service API
        // 2. Show loading indicator
        // 3. Refresh results when complete
        
    } catch (error) {
        console.error('Error running validation:', error);
        alert('Error running validation: ' + error.message);
    }
}

function rejectSuggestion() {
    updateSuggestionStatus('REJECTED');
}

async function validateAllPending() {
    if (!confirm('Run validation on all pending suggestions? This may take a few minutes.')) {
        return;
    }
    
    try {
        // Show loading state
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        button.disabled = true;
        
        // In real implementation, call batch validation API
        await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate processing
        
        alert('Batch validation completed. Check individual suggestions for results.');
        loadDashboard();
        
    } catch (error) {
        console.error('Error in batch validation:', error);
        alert('Error in batch validation: ' + error.message);
    } finally {
        // Restore button
        const button = event.target;
        button.innerHTML = '<i class="fas fa-check-double"></i> Validate All Pending';
        button.disabled = false;
    }
}

function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const priorityFilter = document.getElementById('priorityFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    let filtered = allSuggestions.filter(suggestion => {
        if (statusFilter && suggestion.status !== statusFilter) return false;
        if (categoryFilter && suggestion.category !== categoryFilter) return false;
        if (priorityFilter && suggestion.priority_score.toString() !== priorityFilter) return false;
        if (searchFilter) {
            const searchText = `${suggestion.title} ${suggestion.description} ${suggestion.user_name}`.toLowerCase();
            if (!searchText.includes(searchFilter)) return false;
        }
        return true;
    });
    
    displaySuggestions(filtered);
}

function refreshDashboard() {
    loadDashboard();
}

// Helper functions
function formatCategory(category) {
    return category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatStatus(status) {
    return status.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleDateString();
}

function truncateText(text, length) {
    if (!text) return '';
    return text.length > length ? text.substring(0, length) + '...' : text;
}

function getCorrelationStrength(correlation) {
    if (correlation >= 0.8) return 'Very Strong';
    if (correlation >= 0.6) return 'Strong';
    if (correlation >= 0.4) return 'Moderate';
    if (correlation >= 0.2) return 'Weak';
    return 'Very Weak';
}

function getCorrelationStrengthClass(correlation) {
    if (correlation >= 0.8) return 'very-strong';
    if (correlation >= 0.6) return 'strong';
    if (correlation >= 0.4) return 'moderate';
    if (correlation >= 0.2) return 'weak';
    return 'very-weak';
}

function getFeasibilityIcon(score) {
    if (score >= 70) return '✅';
    if (score >= 40) return '⚠️';
    return '❌';
}

function getFeasibilityProgressClass(score) {
    if (score >= 70) return 'bg-success';
    if (score >= 40) return 'bg-warning';
    return 'bg-danger';
}
</script>
{% endblock %}
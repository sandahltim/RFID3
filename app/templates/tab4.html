{% extends "base.html" %}

{% block head %}
{{ super() }}
{% endblock %}

{% block content %}
    <h2>Laundry Contracts</h2>

    {% include 'global_filters.html' %}

    {% if error %}
        <div class="alert alert-danger" role="alert">
            Error loading contracts: {{ error }}
        </div>
    {% endif %}

    <!-- Clean Filter Controls (defaults to Active only) -->
    <div class="row mb-3">
        <div class="col-md-8">
            <div class="btn-group btn-group-sm" role="group" id="status-filter">
                <input type="checkbox" class="btn-check" id="filter-active" value="active" checked onclick="toggleStatusFilter('active', this.checked)">
                <label class="btn btn-outline-success" for="filter-active">
                    <span class="badge bg-success rounded-pill me-1">‚óè</span> PreWash Count
                </label>
                
                <input type="checkbox" class="btn-check" id="filter-finalized" value="finalized" checked onclick="toggleStatusFilter('finalized', this.checked)">
                <label class="btn btn-outline-warning" for="filter-finalized">
                    <span class="badge bg-warning rounded-pill me-1">‚óè</span> Sent to Laundry
                </label>
                
                <input type="checkbox" class="btn-check" id="filter-returned" value="returned" onclick="toggleStatusFilter('returned', this.checked)">
                <label class="btn btn-outline-info" for="filter-returned">
                    <span class="badge bg-info rounded-pill me-1">‚óè</span> Returned
                </label>
                
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showAllContracts()">Show All</button>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showActiveOnly()">Active Only</button>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <small class="text-muted"><span id="contract-count">{{ contracts|length }}</span> contracts shown</small>
        </div>
    </div>

    <table class="table table-bordered table-hover category-table" id="category-table">
        <thead class="thead-dark">
            <tr>
                <th>Contract Number</th>
                <th>Customer Name</th>
                <th>Items on Contract</th>
                <th>Total Items in Inventory</th>
                <th>Hand-Counted Entries</th>
                <th>Last Scanned Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="category-rows">
            {% if contracts %}
                {% for contract in contracts %}
                    <tr data-contract-status="{{ contract.status }}" class="contract-row">
                        <td>
                            <!-- Compact status indicator -->
                            {% if contract.status == 'active' %}
                                <span class="badge bg-success rounded-pill me-2" title="PreWash Count - Items being counted before sending to laundry">‚óè</span>
                            {% elif contract.status == 'finalized' %}
                                <span class="badge bg-warning rounded-pill me-2" title="Sent to Laundry - Final count taken, picked up by cleaning service">‚óè</span>
                            {% elif contract.status == 'returned' %}
                                <span class="badge bg-info rounded-pill me-2" title="Returned from cleaning service">‚óè</span>
                            {% else %}
                                <span class="badge bg-secondary rounded-pill me-2" title="Unknown status">‚óè</span>
                            {% endif %}
                            {{ contract.contract_number }}
                            <!-- Show finalized/returned dates subtly -->
                            {% if contract.finalized_date and contract.status == 'finalized' %}
                                <br><small class="text-muted">Sent: {{ contract.finalized_date[:10] }}</small>
                            {% elif contract.returned_date and contract.status == 'returned' %}
                                <br><small class="text-muted">Returned: {{ contract.returned_date[:10] }}</small>
                            {% endif %}
                        </td>
                        <td>{{ contract.client_name }}</td>
                        <td>{{ contract.items_on_contract }}</td>
                        <td>{{ contract.total_items_inventory }}</td>
                        <td>{{ contract.hand_counted_items }}</td>
                        <td>{{ contract.scan_date }}</td>
                        <td class="action-buttons">
                            <!-- Core actions always available -->
                            <button class="btn btn-sm btn-secondary expand-btn" data-target-id="common-{{ contract.contract_number|replace(' ', '_') }}" data-contract-number="{{ contract.contract_number }}">Expand</button>
                            <button class="btn btn-sm btn-secondary collapse-btn" data-collapse-target="common-{{ contract.contract_number|replace(' ', '_') }}" style="display:none;">Collapse</button>
                            
                            <!-- Contextual status actions (only show when relevant) -->
                            {% if contract.status == 'active' %}
                                <button class="btn btn-sm btn-warning finalize-btn" 
                                        data-contract-number="{{ contract.contract_number }}" 
                                        onclick="finalizeContract('{{ contract.contract_number }}')"
                                        title="Mark final count and send to laundry">
                                    Send to Laundry
                                </button>
                            {% elif contract.status == 'finalized' %}
                                <button class="btn btn-sm btn-info return-btn" 
                                        data-contract-number="{{ contract.contract_number }}"
                                        onclick="markReturned('{{ contract.contract_number }}')" 
                                        title="Mark as returned from cleaning service">
                                    Mark Returned
                                </button>
                            {% elif contract.status == 'returned' %}
                                <button class="btn btn-sm btn-outline-secondary reactivate-btn" 
                                        data-contract-number="{{ contract.contract_number }}"
                                        onclick="reactivateContract('{{ contract.contract_number }}')" 
                                        title="Reactivate contract">
                                    Reactivate
                                </button>
                            {% endif %}
                            
                            <!-- Print dropdown -->
                            <div class="dropdown d-inline">
                                <button class="btn btn-sm btn-info print-items-btn" data-print-level="Contract" data-print-id="common-{{ contract.contract_number|replace(' ', '_') }}" data-contract-number="{{ contract.contract_number }}">Print Items</button>
                                <button type="button" class="btn btn-sm btn-info dropdown-toggle dropdown-toggle-split" data-mdb-toggle="dropdown" aria-expanded="false">
                                    <span class="visually-hidden">Toggle Dropdown</span>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item print-contract-history" href="#" data-contract-number="{{ contract.contract_number }}">üìã Contract History</a></li>
                                    <li><a class="dropdown-item print-hand-counted-history" href="#" data-contract-number="{{ contract.contract_number }}">üìù Hand Counted History</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item print-btn" href="#" data-print-level="Contract" data-print-id="common-{{ contract.contract_number|replace(' ', '_') }}" data-contract-number="{{ contract.contract_number }}">üè∑Ô∏è Items List Only</a></li>
                                </ul>
                            </div>
                            <div id="loading-common-{{ contract.contract_number|replace(' ', '_') }}" style="display:none;" class="loading-indicator">Loading...</div>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="7">
                            <div id="common-{{ contract.contract_number|replace(' ', '_') }}" class="expandable collapsed subcategory-container"></div>
                        </td>
                    </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="7">No laundry contracts found. Please try refreshing or check data synchronization.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>

    <h4>Hand-Counted Items</h4>
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">üìã Print Contract Reports</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label for="print-contract-selector">Select Contract for Printing:</label>
                    <select id="print-contract-selector" class="form-control">
                        <option value="">Select Contract...</option>
                        {% if contracts %}
                            {% for contract in contracts %}
                                <option value="{{ contract.contract_number }}">{{ contract.contract_number }} - {{ contract.client_name }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <div class="btn-group">
                        <button type="button" class="btn btn-success print-selected-contract-history" disabled>üìã Contract History</button>
                        <button type="button" class="btn btn-info print-selected-hand-counted-history" disabled>üìù Hand Counted History</button>
                        <button type="button" class="btn btn-warning create-contract-snapshot" disabled>üì∏ Create Snapshot</button>
                        <button type="button" class="btn btn-secondary" onclick="showSnapshotStatus()">üìä Automation Status</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <form id="hand-counted-form">
                <div class="form-group">
                    <label for="hand-counted-contract-number">Select Contract Number:</label>
                    <select id="hand-counted-contract-number" class="form-control" onchange="updateItemDropdownHierarchical()">
                        <option value="">Select Contract...</option>
                    </select>
                    <input type="text" id="new-contract-number" class="form-control mt-2" placeholder="Enter New Contract" style="display:none;">
                    <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="toggleNewContractInput()">Toggle New Contract</button>
                </div>
                <div class="form-group">
                    <label for="hand-counted-category">Select Category:</label>
                    <select id="hand-counted-category" class="form-control" onchange="updateSubcategoryDropdown()">
                        <option value="">Select Category...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hand-counted-subcategory">Select Subcategory:</label>
                    <select id="hand-counted-subcategory" class="form-control" onchange="updateItemDropdownHierarchical()">
                        <option value="">Select Subcategory...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="hand-counted-item-name">Select Item:</label>
                    <select id="hand-counted-item-name" class="form-control" onchange="handleItemSelection()">
                        <option value="">Select Item...</option>
                    </select>
                    <input type="text" id="new-item-name" class="form-control mt-2" placeholder="Enter Item Name" style="display:none;">
                    <small class="form-text text-muted">Select category and subcategory first to see available items</small>
                </div>
                <div class="form-group">
                    <label for="hand-counted-quantity">Quantity:</label>
                    <input type="number" id="hand-counted-quantity" class="form-control" min="1" required>
                </div>
                <div class="form-group">
                    <label for="hand-counted-employee">Employee Name:</label>
                    <input type="text" id="hand-counted-employee" class="form-control" required>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-success" onclick="addHandCountedItem()">Add</button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeHandCountedItem()">Remove</button>
                </div>
            </form>
        </div>
    </div>

    <div id="hand-counted-items" class="mt-4" hx-get="/tab/4/hand_counted_items" hx-trigger="load">
        <table class="table table-bordered table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Contract Number</th>
                    <th>Item Name</th>
                    <th>Quantity</th>
                    <th>Action</th>
                    <th>Timestamp</th>
                    <th>User</th>
                </tr>
            </thead>
            <tbody>
                {% include '_hand_counted_item.html' %}
            </tbody>
        </table>
    </div>

{% endblock %}

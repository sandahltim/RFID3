{% extends "base.html" %}
{% block content %}

<h1>Full Inventory List</h1>

<form method="GET" class="mb-3 row g-2">
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="common_name" placeholder="Filter Common Name" value="{{ filter_common_name }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="tag_id" placeholder="Filter Tag ID" value="{{ filter_tag_id }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="bin_location" placeholder="Filter Bin Location" value="{{ filter_bin_location }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="last_contract_num" placeholder="Filter Last Contract" value="{{ filter_last_contract }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="status" placeholder="Filter Status" value="{{ filter_status }}" />
  </div>
  <div class="col-12 col-md-2">
    <button type="submit" class="btn btn-primary">Apply Filters</button>
  </div>
</form>

<nav aria-label="Page navigation" class="mb-3">
  <ul class="pagination justify-content-center flex-wrap" id="topPagination">
    <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('tab4_bp.show_tab4', page=current_page-1, common_name=filter_common_name, tag_id=filter_tag_id, bin_location=filter_bin_location, last_contract_num=filter_last_contract, status=filter_status) }}" aria-label="Previous">
        <span aria-hidden="true">&laquo; Prev</span>
      </a>
    </li>
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == current_page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('tab4_bp.show_tab4', page=p, common_name=filter_common_name, tag_id=filter_tag_id, bin_location=filter_bin_location, last_contract_num=filter_last_contract, status=filter_status) }}">{{ p }}</a>
    </li>
    {% endfor %}
    <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('tab4_bp.show_tab4', page=current_page+1, common_name=filter_common_name, tag_id=filter_tag_id, bin_location=filter_bin_location, last_contract_num=filter_last_contract, status=filter_status) }}" aria-label="Next">
        <span aria-hidden="true">Next &raquo;</span>
      </a>
    </li>
  </ul>
</nav>

<div class="table-responsive">
  <table class="table table-striped table-bordered" id="parentTable">
    <thead>
      <tr>
        <th style="width: 50px;"></th>
        <th class="sortable" data-col-name="common_name">Common Name</th>
        <th class="sortable" data-col-name="total">Total Items</th>
      </tr>
    </thead>
    <tbody id="parentTableBody">
      {% for parent in parent_data %}
      {% set parent_idx = loop.index + (current_page - 1) * 20 %}
      <tr class="table-active">
        <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#child-{{ parent_idx }}">+</span></td>
        <td>{{ parent.common_name }}</td>
        <td>{{ parent.total }}</td>
      </tr>
      <tr>
        <td colspan="3" class="p-0">
          <div id="child-{{ parent_idx }}" class="collapse">
            <table class="table mb-0 child-table" id="childTable-{{ parent_idx }}">
              <thead>
                <tr>
                  <th class="sortable" data-col-name="tag_id">Tag ID</th>
                  <th class="sortable" data-col-name="account_uuid">Account UUID</th>
                  <th class="sortable" data-col-name="serial_number">Serial Number</th>
                  <th class="sortable" data-col-name="client_name">Client Name</th>
                  <th class="sortable" data-col-name="rental_class">Rental Class</th>
                  <th class="sortable" data-col-name="quality">Quality</th>
                  <th class="sortable" data-col-name="bin_location">Bin Location</th>
                  <th class="sortable" data-col-name="status">Status</th>
                  <th class="sortable" data-col-name="last_contract">Last Contract</th>
                  <th class="sortable" data-col-name="last_scanned_by">Last Scanned By</th>
                  <th class="sortable" data-col-name="notes">Notes</th>
                  <th class="sortable" data-col-name="status_notes">Status Notes</th>
                  <th class="sortable" data-col-name="longitude">Longitude</th>
                  <th class="sortable" data-col-name="latitude">Latitude</th>
                  <th class="sortable" data-col-name="date_last_scanned">Date Last Scanned</th>
                  <th class="sortable" data-col-name="date_created">Date Created</th>
                  <th class="sortable" data-col-name="date_updated">Date Updated</th>
                </tr>
              </thead>
              <tbody>
                {% for item in item_map[parent.common_name] %}
                <tr class="{% if item.status in ['On Rent', 'Delivered'] %}on-rent{% elif item.status == 'Ready to Rent' %}ready{% else %}service{% endif %}">
                  <td>{{ item.tag_id }}</td>
                  <td>{{ item.uuid_accounts_fk }}</td>
                  <td>{{ item.serial_number }}</td>
                  <td>{{ item.client_name }}</td>
                  <td>{{ item.rental_class_num }}</td>
                  <td>{{ item.quality }}</td>
                  <td>{{ item.bin_location }}</td>
                  <td>{{ item.status }}</td>
                  <td>{{ item.last_contract_num }}</td>
                  <td>{{ item.last_scanned_by }}</td>
                  <td>{{ item.notes }}</td>
                  <td>{{ item.status_notes }}</td>
                  <td>{{ item.long }}</td>
                  <td>{{ item.lat }}</td>
                  <td>{{ item.date_last_scanned }}</td>
                  <td>{{ item.date_created }}</td>
                  <td>{{ item.date_updated }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<nav aria-label="Page navigation" class="mt-3">
  <ul class="pagination justify-content-center flex-wrap" id="bottomPagination">
    <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('tab4_bp.show_tab4', page=current_page-1, common_name=filter_common_name, tag_id=filter_tag_id, bin_location=filter_bin_location, last_contract_num=filter_last_contract, status=filter_status) }}" aria-label="Previous">
        <span aria-hidden="true">&laquo; Prev</span>
      </a>
    </li>
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == current_page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('tab4_bp.show_tab4', page=p, common_name=filter_common_name, tag_id=filter_tag_id, bin_location=filter_bin_location, last_contract_num=filter_last_contract, status=filter_status) }}">{{ p }}</a>
    </li>
    {% endfor %}
    <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('tab4_bp.show_tab4', page=current_page+1, common_name=filter_common_name, tag_id=filter_tag_id, bin_location=filter_bin_location, last_contract_num=filter_last_contract, status=filter_status) }}" aria-label="Next">
        <span aria-hidden="true">Next &raquo;</span>
      </a>
    </li>
  </ul>
</nav>

<script>
function sortTable(tableEl, colName) {
  let tbody = tableEl.querySelector("tbody");
  if (!tbody) return;

  let asc = tableEl.getAttribute("data-sort-col") === colName 
            ? tableEl.getAttribute("data-sort-dir") !== "asc" 
            : true;
  tableEl.setAttribute("data-sort-col", colName);
  tableEl.setAttribute("data-sort-dir", asc ? "asc" : "desc");

  let headers = Array.from(tableEl.querySelectorAll("th"));
  let colIndex = headers.findIndex(th => th.getAttribute("data-col-name") === colName);

  if (tableEl.classList.contains("child-table")) {
    let rows = Array.from(tbody.querySelectorAll("tr"));
    rows.sort((a, b) => {
      let cellA = a.cells[colIndex]?.innerText.trim() || "";
      let cellB = b.cells[colIndex]?.innerText.trim() || "";
      let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
  } else {
    let rows = Array.from(tbody.children);
    let pairs = [];
    for (let i = 0; i < rows.length; i += 2) {
      let parentRow = rows[i];
      let childRow = rows[i + 1] || null;
      if (parentRow && parentRow.classList.contains("table-active")) {
        pairs.push({ parent: parentRow, child: childRow });
      }
    }
    pairs.sort((a, b) => {
      let cellA = a.parent.cells[colIndex]?.innerText.trim() || "";
      let cellB = b.parent.cells[colIndex]?.innerText.trim() || "";
      let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    pairs.forEach(pair => {
      tbody.appendChild(pair.parent);
      if (pair.child) tbody.appendChild(pair.child);
    });
  }
}

function refreshTable() {
  console.log("Refreshing Tab 4 at " + new Date().toLocaleTimeString());
  const expandedIds = Array.from(document.querySelectorAll('.collapse.show')).map(el => el.id);
  const urlParams = new URLSearchParams(window.location.search);
  const url = `/tab4/data?${urlParams.toString()}`;

  fetch(url)
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      return response.json();
    })
    .then(data => {
      console.log("Refresh data received:", data);
      const tbody = document.getElementById('parentTableBody');
      tbody.innerHTML = '';
      const perPage = 20;
      const start = (data.current_page - 1) * perPage;
      const end = start + perPage;
      const paginatedData = data.parent_data.slice(start, end);

      paginatedData.forEach((parent, index) => {
        const parent_idx = index + (data.current_page - 1) * perPage;
        const parentRow = document.createElement('tr');
        parentRow.className = 'table-active';
        parentRow.innerHTML = `
          <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#child-${parent_idx}">+</span></td>
          <td>${parent.common_name}</td>
          <td>${parent.total}</td>
        `;
        const childRow = document.createElement('tr');
        childRow.innerHTML = `
          <td colspan="3" class="p-0">
            <div id="child-${parent_idx}" class="collapse">
              <table class="table mb-0 child-table" id="childTable-${parent_idx}">
                <thead>
                  <tr>
                    <th class="sortable" data-col-name="tag_id">Tag ID</th>
                    <th class="sortable" data-col-name="account_uuid">Account UUID</th>
                    <th class="sortable" data-col-name="serial_number">Serial Number</th>
                    <th class="sortable" data-col-name="client_name">Client Name</th>
                    <th class="sortable" data-col-name="rental_class">Rental Class</th>
                    <th class="sortable" data-col-name="quality">Quality</th>
                    <th class="sortable" data-col-name="bin_location">Bin Location</th>
                    <th class="sortable" data-col-name="status">Status</th>
                    <th class="sortable" data-col-name="last_contract">Last Contract</th>
                    <th class="sortable" data-col-name="last_scanned_by">Last Scanned By</th>
                    <th class="sortable" data-col-name="notes">Notes</th>
                    <th class="sortable" data-col-name="status_notes">Status Notes</th>
                    <th class="sortable" data-col-name="longitude">Longitude</th>
                    <th class="sortable" data-col-name="latitude">Latitude</th>
                    <th class="sortable" data-col-name="date_last_scanned">Date Last Scanned</th>
                    <th class="sortable" data-col-name="date_created">Date Created</th>
                    <th class="sortable" data-col-name="date_updated">Date Updated</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </td>
        `;
        tbody.appendChild(parentRow);
        tbody.appendChild(childRow);

        const childTbody = document.getElementById(`childTable-${parent_idx}`).querySelector('tbody');
        if (expandedIds.includes(`child-${parent_idx}`)) {
          data.item_map[parent.common_name].forEach(item => {
            const tr = document.createElement('tr');
            tr.className = item.status === 'On Rent' || item.status === 'Delivered' ? 'on-rent' :
                           item.status === 'Ready to Rent' ? 'ready' : 'service';
            tr.innerHTML = `
              <td>${item.tag_id}</td>
              <td>${item.uuid_accounts_fk || ''}</td>
              <td>${item.serial_number || ''}</td>
              <td>${item.client_name || ''}</td>
              <td>${item.rental_class_num || ''}</td>
              <td>${item.quality || ''}</td>
              <td>${item.bin_location || ''}</td>
              <td>${item.status || ''}</td>
              <td>${item.last_contract_num || ''}</td>
              <td>${item.last_scanned_by || ''}</td>
              <td>${item.notes || ''}</td>
              <td>${item.status_notes || ''}</td>
              <td>${item.long || ''}</td>
              <td>${item.lat || ''}</td>
              <td>${item.date_last_scanned || ''}</td>
              <td>${item.date_created || ''}</td>
              <td>${item.date_updated || ''}</td>
            `;
            childTbody.appendChild(tr);
          });
        }
      });

      ['topPagination', 'bottomPagination'].forEach(paginationId => {
        const pagination = document.getElementById(paginationId);
        pagination.innerHTML = '';
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${data.current_page === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="?page=${data.current_page - 1}&${urlParams.toString()}" aria-label="Previous"><span aria-hidden="true">&laquo; Prev</span></a>`;
        pagination.appendChild(prevLi);

        for (let p = 1; p <= data.total_pages; p++) {
          const li = document.createElement('li');
          li.className = `page-item ${p === data.current_page ? 'active' : ''}`;
          li.innerHTML = `<a class="page-link" href="?page=${p}&${urlParams.toString()}">${p}</a>`;
          pagination.appendChild(li);
        }

        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${data.current_page === data.total_pages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="?page=${data.current_page + 1}&${urlParams.toString()}" aria-label="Next"><span aria-hidden="true">Next &raquo;</span></a>`;
        pagination.appendChild(nextLi);
      });

      expandedIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          new bootstrap.Collapse(element, { toggle: false }).show();
          const toggle = document.querySelector(`[data-bs-target="#${id}"]`);
          if (toggle) toggle.textContent = '-';
        }
      });
    })
    .catch(error => console.error('Error refreshing table:', error));
}

function updateWithNewData(newData) {
  console.log("Updating Tab 4 with new data:", newData);
  const urlParams = new URLSearchParams(window.location.search);
  const filters = {
    common_name: urlParams.get('common_name')?.toLowerCase() || '',
    tag_id: urlParams.get('tag_id')?.toLowerCase() || '',
    bin_location: urlParams.get('bin_location')?.toLowerCase() || '',
    last_contract_num: urlParams.get('last_contract_num')?.toLowerCase() || '',
    status: urlParams.get('status')?.toLowerCase() || ''
  };

  const filteredItems = newData.items.filter(item => 
    (!filters.common_name || item.common_name.toLowerCase().includes(filters.common_name)) &&
    (!filters.tag_id || item.tag_id.toLowerCase().includes(filters.tag_id)) &&
    (!filters.bin_location || (item.bin_location || '').toLowerCase().includes(filters.bin_location)) &&
    (!filters.last_contract_num || (item.last_contract_num || '').toLowerCase().includes(filters.last_contract_num)) &&
    (!filters.status || (item.status || '').toLowerCase().includes(filters.status))
  );

  const tbody = document.getElementById('parentTableBody');
  const commonTotals = {};
  filteredItems.forEach(item => {
    const common = item.common_name;
    if (!commonTotals[common]) commonTotals[common] = { total: 0, items: [] };
    commonTotals[common].total++;
    commonTotals[common].items.push(item);
  });

  Object.entries(commonTotals).forEach(([common, data]) => {
    let parentRow = Array.from(tbody.querySelectorAll('.table-active'))
      .find(row => row.cells[1].innerText === common);
    const parent_idx = Array.from(tbody.querySelectorAll('.table-active')).length + 1;
    if (!parentRow) {
      parentRow = document.createElement('tr');
      parentRow.className = 'table-active';
      parentRow.innerHTML = `
        <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#child-${parent_idx}">+</span></td>
        <td>${common}</td>
        <td>${data.total}</td>
      `;
      const childRow = document.createElement('tr');
      childRow.innerHTML = `
        <td colspan="3" class="p-0">
          <div id="child-${parent_idx}" class="collapse">
            <table class="table mb-0 child-table" id="childTable-${parent_idx}">
              <thead>
                <tr>
                  <th class="sortable" data-col-name="tag_id">Tag ID</th>
                  <th class="sortable" data-col-name="account_uuid">Account UUID</th>
                  <th class="sortable" data-col-name="serial_number">Serial Number</th>
                  <th class="sortable" data-col-name="client_name">Client Name</th>
                  <th class="sortable" data-col-name="rental_class">Rental Class</th>
                  <th class="sortable" data-col-name="quality">Quality</th>
                  <th class="sortable" data-col-name="bin_location">Bin Location</th>
                  <th class="sortable" data-col-name="status">Status</th>
                  <th class="sortable" data-col-name="last_contract">Last Contract</th>
                  <th class="sortable" data-col-name="last_scanned_by">Last Scanned By</th>
                  <th class="sortable" data-col-name="notes">Notes</th>
                  <th class="sortable" data-col-name="status_notes">Status Notes</th>
                  <th class="sortable" data-col-name="longitude">Longitude</th>
                  <th class="sortable" data-col-name="latitude">Latitude</th>
                  <th class="sortable" data-col-name="date_last_scanned">Date Last Scanned</th>
                  <th class="sortable" data-col-name="date_created">Date Created</th>
                  <th class="sortable" data-col-name="date_updated">Date Updated</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </td>
      `;
      tbody.appendChild(parentRow);
      tbody.appendChild(childRow);
    } else {
      parentRow.cells[2].innerText = parseInt(parentRow.cells[2].innerText) + data.total;
    }

    const childTbody = document.getElementById(`childTable-${parent_idx}`).querySelector('tbody');
    if (childTbody.closest('.collapse').classList.contains('show')) {
      data.items.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = item.status === 'On Rent' || item.status === 'Delivered' ? 'on-rent' :
                       item.status === 'Ready to Rent' ? 'ready' : 'service';
        tr.innerHTML = `
          <td>${item.tag_id}</td>
          <td>${item.uuid_accounts_fk || ''}</td>
          <td>${item.serial_number || ''}</td>
          <td>${item.client_name || ''}</td>
          <td>${item.rental_class_num || ''}</td>
          <td>${item.quality || ''}</td>
          <td>${item.bin_location || ''}</td>
          <td>${item.status || ''}</td>
          <td>${item.last_contract_num || ''}</td>
          <td>${item.last_scanned_by || ''}</td>
          <td>${item.notes || ''}</td>
          <td>${item.status_notes || ''}</td>
          <td>${item.long || ''}</td>
          <td>${item.lat || ''}</td>
          <td>${item.date_last_scanned || ''}</td>
          <td>${item.date_created || ''}</td>
          <td>${item.date_updated || ''}</td>
        `;
        childTbody.appendChild(tr);
      });
    }
  });
}

document.addEventListener("DOMContentLoaded", () => {
  console.log("DOM Content Loaded - Tab 4");

  document.getElementById("parentTable").addEventListener("click", function(event) {
    const target = event.target;
    if (target.classList.contains("sortable")) {
      const table = target.closest("table");
      const colName = target.getAttribute("data-col-name");
      sortTable(table, colName);
    }
  });

  document.addEventListener('newData', (e) => {
    updateWithNewData(e.detail);
  });

  setInterval(refreshTable, 60000);
});
</script>

<style>
  .on-rent { background-color: #ffff99; }
  .ready { background-color: #ccffcc; }
  .service { background-color: #ffcccc; }
  @media (max-width: 768px) {
    .pagination .page-link { padding: 0.25rem 0.5rem; font-size: 0.9rem; }
  }
</style>

{% endblock %}
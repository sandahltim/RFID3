{% extends "base.html" %}

{% block content %}
<div class="mt-0"> <!-- Removed mt-4 to reduce gap -->
    <h2>Laundry Contracts</h2>
    <!-- Table for displaying contracts -->
    <table class="category-table" id="category-table">
        <thead id="category-table-header">
            <tr>
                <th>Contract Number <span class="sort-arrow"></span></th>
                <th>Customer Name <span class="sort-arrow"></span></th>
                <th>Items on Contract <span class="sort-arrow"></span></th>
                <th>Total Items in Inventory <span class="sort-arrow"></span></th>
                <th>Hand-Counted Entries <span class="sort-arrow"></span></th>
                <th>Last Scanned Date <span class="sort-arrow"></span></th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="category-rows">
            {% for contract in contracts %}
            <tr>
                <td class="expandable-cell" onclick="window.expandCategory('{{ contract.contract_number | urlencode | replace('\'', '\\\'') | replace('"', '\\"') }}', 'common-{{ contract.contract_number }}', '{{ contract.contract_number }}')">
                    {{ contract.contract_number }}
                </td>
                <td>{{ contract.client_name }}</td>
                <td id="items-on-contract-{{ contract.contract_number }}">{{ contract.items_on_contract }}</td>
                <td>{{ contract.total_items_inventory }}</td>
                <td id="hand-counted-entries-{{ contract.contract_number }}">{{ contract.hand_counted_items }}</td>
                <td class="date-last-scanned">{{ contract.scan_date }}</td>
                <td>
                    <button class="btn btn-sm btn-secondary expand-btn" data-contract-number="{{ contract.contract_number }}" data-target-id="common-{{ contract.contract_number }}">Expand</button>
                    <button class="btn btn-sm btn-secondary collapse-btn" data-collapse-target="common-{{ contract.contract_number }}" style="display:none;">Collapse</button>
                    <button class="btn btn-sm btn-info print-btn" data-print-level="Contract" data-print-id="common-{{ contract.contract_number }}" data-contract-number="{{ contract.contract_number }}">Print</button>
                    <div id="loading-{{ contract.contract_number }}" style="display:none;" class="loading">Loading...</div>
                </td>
            </tr>
            <tr>
                <td colspan="7">
                    <div id="common-{{ contract.contract_number }}" class="expandable collapsed"></div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Hand-Counted Items Section (always visible) -->
    <h4>Hand-Counted Items</h4>
    <div class="row mb-3">
        <div class="col">
            <select class="form-control" id="hand-counted-contract-number" onchange="updateItemDropdown()">
                <option value="">Select Contract Number...</option>
                <!-- Populated dynamically -->
            </select>
            <input type="text" class="form-control mt-2" id="new-contract-number" placeholder="Or enter new contract number" style="display: none;">
            <button class="btn btn-sm btn-secondary mt-1" onclick="toggleNewContractInput()">Enter New Contract</button>
        </div>
        <div class="col">
            <select class="form-control" id="hand-counted-item-name">
                <option value="">Select Item...</option>
                <!-- Populated dynamically -->
            </select>
            <input type="text" class="form-control mt-2" id="new-item-name" placeholder="Or enter new item name" style="display: none;">
            <button class="btn btn-sm btn-secondary mt-1" onclick="toggleNewItemInput()">Enter New Item</button>
        </div>
        <div class="col">
            <input type="number" class="form-control" id="hand-counted-quantity" placeholder="Quantity" min="1">
        </div>
        <div class="col">
            <input type="text" class="form-control" id="hand-counted-employee" placeholder="Employee Name">
        </div>
        <div class="col">
            <button class="btn btn-success" onclick="addHandCountedItem()">Add</button>
            <button class="btn btn-danger" onclick="removeHandCountedItem()">Remove</button>
        </div>
    </div>
    <div class="row mb-3">
        <div class="col">
            <input type="text" class="form-control" placeholder="Filter by Contract Number" id="hand-counted-filter" oninput="filterHandCountedItems()">
        </div>
    </div>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Contract Number</th>
                <th>Item Name</th>
                <th>Quantity</th>
                <th>Action</th>
                <th>Timestamp</th>
                <th>User</th>
            </tr>
        </thead>
        <tbody id="hand-counted-items" 
               hx-get="{{ url_for('tab4.tab4_hand_counted_items') }}"
               hx-trigger="load, refreshTab from:body">
        </tbody>
    </table>
</div>

<!-- JavaScript for refreshing the table, filtering, and managing hand-counted items -->
<script>
// Function to format dates as "Thurs, Aug 21 2025 4:55 pm"
function formatDate(isoDateString) {
    if (!isoDateString || isoDateString === 'N/A') return 'N/A';
    try {
        const date = new Date(isoDateString);
        if (isNaN(date.getTime())) return isoDateString; // Return as-is if invalid date

        const days = ['Sun', 'Mon', 'Tues', 'Wed', 'Thurs', 'Fri', 'Sat'];
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sept', 'Oct', 'Nov', 'Dec'];

        const dayName = days[date.getDay()];
        const monthName = months[date.getMonth()];
        const day = date.getDate();
        const year = date.getFullYear();
        let hours = date.getHours();
        const minutes = date.getMinutes().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12 || 12; // Convert 0 or 12 to 12 for 12-hour format

        return `${dayName}, ${monthName} ${day} ${year} ${hours}:${minutes} ${ampm}`;
    } catch (error) {
        console.error('Error formatting date:', error);
        return isoDateString;
    }
}

function refreshTab() {
    window.location.reload();
}

function filterHandCountedItems() {
    const contractNumber = document.getElementById('hand-counted-filter').value;
    const url = contractNumber ? `/tab/4/hand_counted_items?contract_number=${encodeURIComponent(contractNumber)}` : '/tab/4/hand_counted_items';
    htmx.ajax('GET', url, '#hand-counted-items');
}

// Toggle visibility of new contract number input
function toggleNewContractInput() {
    const contractDropdown = document.getElementById('hand-counted-contract-number');
    const newContractInput = document.getElementById('new-contract-number');
    if (newContractInput.style.display === 'none') {
        newContractInput.style.display = 'block';
        contractDropdown.disabled = true;
    } else {
        newContractInput.style.display = 'none';
        newContractInput.value = '';
        contractDropdown.disabled = false;
        updateItemDropdown();
    }
}

// Toggle visibility of new item name input
function toggleNewItemInput() {
    const itemDropdown = document.getElementById('hand-counted-item-name');
    const newItemInput = document.getElementById('new-item-name');
    if (newItemInput.style.display === 'none') {
        newItemInput.style.display = 'block';
        itemDropdown.disabled = true;
    } else {
        newItemInput.style.display = 'none';
        newItemInput.value = '';
        itemDropdown.disabled = false;
    }
}

// Populate contract dropdown on page load
document.addEventListener('DOMContentLoaded', function() {
    fetch('/tab/4/hand_counted_contracts')
        .then(response => response.json())
        .then(data => {
            const contractDropdown = document.getElementById('hand-counted-contract-number');
            data.contracts.forEach(contract => {
                const option = document.createElement('option');
                option.value = contract;
                option.textContent = contract;
                contractDropdown.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error fetching hand-counted contracts:', error);
        });

    // Format scan dates in the contracts table
    const contractRows = document.querySelectorAll('#category-rows tr');
    contractRows.forEach(row => {
        const scanDateCell = row.querySelector('td.date-last-scanned');
        if (scanDateCell) {
            const rawDate = scanDateCell.textContent.trim();
            const formattedDate = formatDate(rawDate);
            scanDateCell.textContent = formattedDate;
        }
    });
});

// Update item dropdown when contract is selected
function updateItemDropdown() {
    const contractDropdown = document.getElementById('hand-counted-contract-number');
    const itemDropdown = document.getElementById('hand-counted-item-name');
    const newContractInput = document.getElementById('new-contract-number');
    const contractNumber = newContractInput.style.display === 'block' ? newContractInput.value : contractDropdown.value;

    // Clear existing items
    itemDropdown.innerHTML = '<option value="">Select Item...</option>';

    if (contractNumber) {
        fetch(`/tab/4/hand_counted_items_by_contract?contract_number=${encodeURIComponent(contractNumber)}`)
            .then(response => response.json())
            .then(data => {
                data.items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.item_name;
                    option.textContent = `${item.item_name} (Qty: ${item.quantity})`;
                    itemDropdown.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching hand-counted items:', error);
            });
    }
}

function addHandCountedItem() {
    const contractDropdown = document.getElementById('hand-counted-contract-number');
    const newContractInput = document.getElementById('new-contract-number');
    const itemDropdown = document.getElementById('hand-counted-item-name');
    const newItemInput = document.getElementById('new-item-name');
    const quantityInput = document.getElementById('hand-counted-quantity');
    const employeeInput = document.getElementById('hand-counted-employee');

    const contractNumber = newContractInput.style.display === 'block' ? newContractInput.value : contractDropdown.value;
    const itemName = newItemInput.style.display === 'block' ? newItemInput.value : itemDropdown.value;
    const quantity = parseInt(quantityInput.value);
    const employeeName = employeeInput.value;

    // Validation
    if (!contractNumber || !itemName || !quantity || quantity < 1 || !employeeName) {
        alert('Please fill in all fields: Contract Number, Item Name, Quantity (positive number), and Employee Name.');
        return;
    }

    if (!contractNumber.startsWith('L')) {
        alert('Contract Number must start with "L" for Laundry Contracts.');
        return;
    }

    fetch('/tab/4/add_hand_counted_item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            contract_number: contractNumber,
            item_name: itemName,
            quantity: quantity,
            action: 'Added',
            employee_name: employeeName
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(data.message);
            // Clear the form
            if (newContractInput.style.display === 'block') {
                toggleNewContractInput();
            }
            if (newItemInput.style.display === 'block') {
                toggleNewItemInput();
            }
            contractDropdown.value = '';
            itemDropdown.value = '';
            quantityInput.value = '';
            employeeInput.value = '';
            // Refresh the hand-counted items table
            filterHandCountedItems();
            // Update the contract counts and common names list
            updateContractCounts(contractNumber);
            refreshCommonNames(contractNumber);
        }
    })
    .catch(error => {
        console.error('Error adding hand-counted item:', error);
        alert('Failed to add item. Please try again.');
        // Still attempt to update counts and common names in case of partial success
        updateContractCounts(contractNumber);
        refreshCommonNames(contractNumber);
    });
}

function removeHandCountedItem() {
    const contractDropdown = document.getElementById('hand-counted-contract-number');
    const newContractInput = document.getElementById('new-contract-number');
    const itemDropdown = document.getElementById('hand-counted-item-name');
    const newItemInput = document.getElementById('new-item-name');
    const quantityInput = document.getElementById('hand-counted-quantity');
    const employeeInput = document.getElementById('hand-counted-employee');

    const contractNumber = newContractInput.style.display === 'block' ? newContractInput.value : contractDropdown.value;
    const itemName = newItemInput.style.display === 'block' ? newItemInput.value : itemDropdown.value;
    const quantity = parseInt(quantityInput.value);
    const employeeName = employeeInput.value;

    // Validation
    if (!contractNumber || !itemName || !quantity || quantity < 1 || !employeeName) {
        alert('Please fill in all fields: Contract Number, Item Name, Quantity (positive number), and Employee Name.');
        return;
    }

    fetch('/tab/4/remove_hand_counted_item', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            contract_number: contractNumber,
            item_name: itemName,
            quantity: quantity,
            action: 'Removed',
            employee_name: employeeName
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            alert('Error: ' + data.error);
        } else {
            alert(data.message);
            // Clear the form
            if (newContractInput.style.display === 'block') {
                toggleNewContractInput();
            }
            if (newItemInput.style.display === 'block') {
                toggleNewItemInput();
            }
            contractDropdown.value = '';
            itemDropdown.value = '';
            quantityInput.value = '';
            employeeInput.value = '';
            // Refresh the hand-counted items table
            filterHandCountedItems();
            // Update the contract counts and common names list
            updateContractCounts(contractNumber);
            refreshCommonNames(contractNumber);
        }
    })
    .catch(error => {
        console.error('Error removing hand-counted item:', error);
        alert('Failed to remove item. Please try again.');
        // Still attempt to update counts and common names in case of partial success
        updateContractCounts(contractNumber);
        refreshCommonNames(contractNumber);
    });
}

// Update the Items on Contract and Hand-Counted Entries counts dynamically
function updateContractCounts(contractNumber) {
    console.log(`Updating contract counts for contract: ${contractNumber}`);

    // Update Items on Contract
    fetch(`/tab/4/contract_items_count?contract_number=${encodeURIComponent(contractNumber)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch Items on Contract');
            }
            return response.json();
        })
        .then(data => {
            const currentCountElement = document.getElementById(`items-on-contract-${contractNumber}`);
            if (currentCountElement) {
                const newCount = data.total_items || 0;
                currentCountElement.textContent = newCount;
                console.log(`Updated Items on Contract for ${contractNumber} to ${newCount}`);
            } else {
                console.warn(`Items on Contract element not found for ${contractNumber}`);
            }
        })
        .catch(error => {
            console.error('Error updating Items on Contract count:', error);
        });

    // Update Hand-Counted Entries
    fetch(`/tab/4/hand_counted_entries?contract_number=${encodeURIComponent(contractNumber)}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch Hand-Counted Entries');
            }
            return response.json();
        })
        .then(data => {
            const handCountedElement = document.getElementById(`hand-counted-entries-${contractNumber}`);
            if (handCountedElement) {
                const newHandCountedCount = data.hand_counted_entries || 0;
                handCountedElement.textContent = newHandCountedCount;
                console.log(`Updated Hand-Counted Entries for ${contractNumber} to ${newHandCountedCount}`);
            } else {
                console.warn(`Hand-Counted Entries element not found for ${contractNumber}`);
            }
        })
        .catch(error => {
            console.error('Error updating Hand-Counted Entries count:', error);
        });
}

// Refresh the common names list for a contract if it's expanded
function refreshCommonNames(contractNumber) {
    console.log(`Refreshing common names for contract: ${contractNumber}`);
    const commonDiv = document.getElementById(`common-${contractNumber}`);
    if (commonDiv && !commonDiv.classList.contains('collapsed')) {
        console.log(`Common names section for ${contractNumber} is expanded, refreshing...`);
        window.expandCategory(
            encodeURIComponent(contractNumber),
            `common-${contractNumber}`,
            contractNumber
        );
    } else {
        console.log(`Common names section for ${contractNumber} is not expanded, skipping refresh.`);
    }
}

// Format timestamps in the Hand-Counted Items table after HTMX load
document.body.addEventListener('htmx:afterSwap', function(event) {
    const target = event.target;
    if (target.id === 'hand-counted-items') {
        const rows = target.querySelectorAll('tr');
        rows.forEach(row => {
            const timestampCell = row.querySelector('td:nth-child(5)'); // Timestamp column
            if (timestampCell) {
                const rawDate = timestampCell.textContent.trim();
                const formattedDate = formatDate(rawDate);
                timestampCell.textContent = formattedDate;
            }
        });
    }
});
</script>
{% endblock %}
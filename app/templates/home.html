{% extends "base.html" %}

{% block title %}RFID Dashboard{% endblock %}

{% block content %}
    <h2>RFID Dashboard</h2>

    <!-- Action Buttons with Mobile-First Layout -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-sm-row gap-2 justify-content-center">
                <button class="btn btn-primary" onclick="triggerFullRefresh()">
                    <i class="fas fa-sync-alt me-2"></i>Full Refresh
                </button>
                <button class="btn btn-danger" onclick="clearApiData()">
                    <i class="fas fa-trash-alt me-2"></i>Clear API Data & Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- RFID Scanner Interface Link -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-wifi"></i> RFID Scanner Interface</span>
                        <span class="badge bg-success">New Standalone Interface</span>
                    </div>
                </div>
                <div class="card-body text-center">
                    <h5 class="card-title">Professional RFID Scanner</h5>
                    <p class="card-text">
                        Access the dedicated RFID scanner interface for rental flow management,
                        item tracking, and inventory operations with full HTTPS support.
                    </p>
                    <div class="d-grid gap-2 d-md-block">
                        <a href="https://dev.tail752777.ts.net:8443/rental" target="_blank" class="btn btn-primary btn-lg">
                            <i class="fas fa-external-link-alt me-2"></i>Open RFID Scanner
                        </a>
                        <a href="https://dev.tail752777.ts.net:8443/" target="_blank" class="btn btn-outline-secondary">
                            <i class="fas fa-home me-2"></i>Scanner Home
                        </a>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Secure HTTPS interface running on port 8443 with full rental flow capabilities
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Content with Mobile-First Responsive Layout -->
    <div class="row">
        <!-- Inventory Summary - Full width on mobile, sidebar on desktop -->
        <div class="col-12 col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-2"></i>Inventory Summary
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6 col-sm-3 col-lg-6">
                            <div class="text-center p-2 bg-light rounded">
                                <div class="h4 mb-0 text-primary">{{ total_items or 0 }}</div>
                                <small class="text-muted">Total Items</small>
                            </div>
                        </div>
                        <div class="col-6 col-sm-3 col-lg-6">
                            <div class="text-center p-2 bg-light rounded">
                                <div class="h4 mb-0 text-warning">{{ items_on_rent or 0 }}</div>
                                <small class="text-muted">On Rent</small>
                            </div>
                        </div>
                        <div class="col-6 col-sm-3 col-lg-6">
                            <div class="text-center p-2 bg-light rounded">
                                <div class="h4 mb-0 text-danger">{{ items_in_service or 0 }}</div>
                                <small class="text-muted">In Service</small>
                            </div>
                        </div>
                        <div class="col-6 col-sm-3 col-lg-6">
                            <div class="text-center p-2 bg-light rounded">
                                <div class="h4 mb-0 text-success">{{ items_available or 0 }}</div>
                                <small class="text-muted">Available</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Breakdown - Collapsed on mobile -->
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-secondary d-lg-none w-100" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#statusBreakdown" aria-expanded="false">
                            <i class="fas fa-list me-2"></i>View Status Breakdown
                        </button>
                        <div class="collapse d-lg-block" id="statusBreakdown">
                            <h6 class="mt-3 mb-2">Status Breakdown:</h6>
                            <div class="small">
                                {% for status, count in status_counts %}
                                    <div class="d-flex justify-content-between py-1">
                                        <span>{{ status or 'Unknown' }}:</span>
                                        <strong>{{ count or 0 }}</strong>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Recent Scans - Main content area -->
        <div class="col-12 col-lg-8">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-history me-2"></i>Recent Scans (Last 50)
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <span id="scan-status" class="badge bg-secondary">Connecting...</span>
                            <button id="pause-btn" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-pause me-1"></i><span class="d-none d-sm-inline">Pause</span>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Responsive table wrapper -->
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-hover mb-0" id="recent-scans-table">
                            <thead class="sticky-top">
                                <tr>
                                    <th class="mobile-hide">Tag ID</th>
                                    <th>Item</th>
                                    <th>Status</th>
                                    <th class="desktop-only">Contract</th>
                                    <th class="mobile-hide">Scan Date</th>
                                </tr>
                            </thead>
                            <tbody id="recent-scans-tbody">
                                {% if recent_scans %}
                                    {% for scan in recent_scans %}
                                        <tr data-timestamp="{{ scan.date_last_scanned | datetimeformat if scan.date_last_scanned else '' }}">
                                            <td class="mobile-hide">{{ scan.tag_id or 'N/A' }}</td>
                                            <td>
                                                <div class="fw-semibold">{{ scan.common_name or 'N/A' }}</div>
                                                <small class="text-muted mobile-only">{{ scan.tag_id or 'N/A' }}</small>
                                            </td>
                                            <td><span class="badge bg-info">{{ scan.status or 'N/A' }}</span></td>
                                            <td class="desktop-only">{{ scan.last_contract_num or 'N/A' }}</td>
                                            <td class="mobile-hide">{{ scan.date_last_scanned | datetimeformat if scan.date_last_scanned else 'No Scan Date' }}</td>
                                        </tr>
                                    {% endfor %}
                                {% else %}
                                    <tr id="no-scans-row">
                                        <td colspan="5" class="text-center text-muted py-4">No recent scans available.</td>
                                    </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-warning" role="alert" style="display: none;" id="jsDisabledWarning">
        JavaScript is disabled or failed to load. Please enable JavaScript to use the refresh functionality.
    </div>

    <script>
    // Real-time scanning system
    let pollingInterval = null;
    let latestTimestamp = null;
    let isPaused = false;
    let errorCount = 0;
    const MAX_ERRORS = 5;
    const POLL_INTERVAL = 3000; // 3 seconds

    // Initialize real-time scanning on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeScans();
        startPolling();
        setupEventHandlers();
    });

    function initializeScans() {
        // Get initial latest timestamp from existing data
        const tbody = document.getElementById('recent-scans-tbody');
        const firstRow = tbody.querySelector('tr[data-timestamp]');
        if (firstRow) {
            latestTimestamp = firstRow.getAttribute('data-timestamp');
            // Convert display format back to ISO format for API
            if (latestTimestamp && latestTimestamp !== '') {
                try {
                    const date = new Date(latestTimestamp);
                    latestTimestamp = date.toISOString();
                } catch (e) {
                    console.warn('Could not parse initial timestamp:', latestTimestamp);
                    latestTimestamp = null;
                }
            }
        }
        console.log('Initialized with latest timestamp:', latestTimestamp);
    }

    function setupEventHandlers() {
        const pauseBtn = document.getElementById('pause-btn');
        pauseBtn.addEventListener('click', function() {
            if (isPaused) {
                resumePolling();
            } else {
                pausePolling();
            }
        });
    }

    function startPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }
        
        updateStatus('🟢 Live', 'bg-success');
        errorCount = 0;
        
        // Poll immediately, then set interval
        pollForNewScans();
        pollingInterval = setInterval(pollForNewScans, POLL_INTERVAL);
    }

    function pausePolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
        isPaused = true;
        updateStatus('⏸️ Paused', 'bg-warning');
        document.getElementById('pause-btn').innerHTML = '▶️ Resume';
    }

    function resumePolling() {
        isPaused = false;
        document.getElementById('pause-btn').innerHTML = '⏸️ Pause';
        startPolling();
    }

    function updateStatus(text, badgeClass) {
        const statusBadge = document.getElementById('scan-status');
        statusBadge.textContent = text;
        statusBadge.className = `badge ${badgeClass}`;
    }

    async function pollForNewScans() {
        if (isPaused) return;

        try {
            const url = latestTimestamp 
                ? `/api/recent_scans?limit=50&since=${encodeURIComponent(latestTimestamp)}`
                : '/api/recent_scans?limit=50';
                
            const response = await fetch(url);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            
            if (data.scans && data.scans.length > 0) {
                addNewScans(data.scans);
                latestTimestamp = data.latest_timestamp;
                console.log(`Added ${data.scans.length} new scans, latest: ${latestTimestamp}`);
            }

            // Reset error count on success
            errorCount = 0;
            updateStatus('🟢 Live', 'bg-success');

        } catch (error) {
            console.error('Polling error:', error);
            errorCount++;
            
            if (errorCount >= MAX_ERRORS) {
                updateStatus('🔴 Error', 'bg-danger');
                pausePolling();
                console.error('Too many errors, polling stopped');
            } else {
                updateStatus(`🟡 Retry ${errorCount}/${MAX_ERRORS}`, 'bg-warning');
            }
        }
    }

    function addNewScans(newScans) {
        const tbody = document.getElementById('recent-scans-tbody');
        const noScansRow = document.getElementById('no-scans-row');
        
        // Remove "no scans" row if it exists
        if (noScansRow) {
            noScansRow.remove();
        }

        // Add new scans to the top with animation
        newScans.forEach((scan, index) => {
            const row = createScanRow(scan);
            row.style.backgroundColor = '#d4edda'; // Highlight new scans
            tbody.insertBefore(row, tbody.firstChild);
            
            // Remove highlight after animation
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);
        });

        // Keep only the most recent 50 rows
        const rows = tbody.querySelectorAll('tr');
        for (let i = 50; i < rows.length; i++) {
            rows[i].remove();
        }
    }

    function createScanRow(scan) {
        const row = document.createElement('tr');
        row.setAttribute('data-timestamp', scan.date_last_scanned || '');
        
        const formatDate = (dateStr) => {
            if (!dateStr) return 'No Scan Date';
            try {
                return new Date(dateStr).toLocaleString();
            } catch (e) {
                return dateStr;
            }
        };

        const getStatusBadgeClass = (status) => {
            switch (status?.toLowerCase()) {
                case 'ready to rent': return 'bg-success';
                case 'on rent': case 'delivered': return 'bg-primary';
                case 'repair': case 'needs to be inspected': return 'bg-danger';
                case 'wash': case 'wet': return 'bg-warning';
                default: return 'bg-info';
            }
        };

        row.innerHTML = `
            <td class="mobile-hide">${scan.tag_id || 'N/A'}</td>
            <td>
                <div class="fw-semibold">${scan.common_name || 'N/A'}</div>
                <small class="text-muted mobile-only">${scan.tag_id || 'N/A'}</small>
            </td>
            <td><span class="badge ${getStatusBadgeClass(scan.status)}">${scan.status || 'N/A'}</span></td>
            <td class="desktop-only">${scan.last_contract_num || 'N/A'}</td>
            <td class="mobile-hide">${formatDate(scan.date_last_scanned)}</td>
        `;
        
        return row;
    }

    // Legacy functions for full refresh buttons
    function triggerFullRefresh() {
        fetch('/refresh/full', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                window.location.reload();
            })
            .catch(error => {
                console.error('Error triggering full refresh:', error);
                alert('Failed to trigger full refresh');
            });
    }

    function clearApiData() {
        if (confirm('Are you sure you want to clear API data and perform a full refresh?')) {
            fetch('/refresh/clear', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Error clearing API data:', error);
                    alert('Failed to clear API data');
                });
        }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }
    });
    </script>
{% endblock %}

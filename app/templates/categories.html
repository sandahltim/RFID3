{% extends 'base.html' %}

{% block title %}Manage Categories{% endblock %}

{% block extra_head %}
<style>
    .form-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .form-row input, .form-row select { flex: 1; }
    .alert { display: none; }
</style>
{% endblock %}

{% block content %}
<h1>Manage Categories</h1>
<div id="alert" class="alert"></div>
{% for rc in rental_classes %}
<div class="form-row">
    <select class="form-control rental-class" onchange="loadMapping(this)">
        <option value="{{ rc }}">{{ rc }}</option>
    </select>
    <input type="text" class="form-control category" placeholder="Category (e.g., Linen)">
    <input type="text" class="form-control subcategory" placeholder="Subcategory (e.g., Round Linen)">
    <button class="btn btn-primary" onclick="updateMapping(this)">Update</button>
</div>
{% endfor %}

<script>
    function loadMapping(select) {
        const rentalClass = select.value;
        const row = select.closest('.form-row');
        const categoryInput = row.querySelector('.category');
        const subcategoryInput = row.querySelector('.subcategory');
        
        fetch(`/categories/mapping?rental_class_id=${rentalClass}`)
            .then(response => response.json())
            .then(data => {
                categoryInput.value = data.category || '';
                subcategoryInput.value = data.subcategory || '';
            })
            .catch(error => console.error('Error loading mapping:', error));
    }

    function updateMapping(button) {
        const row = button.closest('.form-row');
        const rentalClass = row.querySelector('.rental-class').value;
        const category = row.querySelector('.category').value;
        const subcategory = row.querySelector('.subcategory').value;
        const alert = document.getElementById('alert');
        
        const formData = new FormData();
        formData.append('rental_class_id', rentalClass);
        formData.append('category', category);
        formData.append('subcategory', subcategory);
        
        fetch('/categories/update', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            alert.className = `alert alert-${data.status === 'success' ? 'success' : 'danger'}`;
            alert.textContent = data.message;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 3000);
        })
        .catch(error => {
            alert.className = 'alert alert-danger';
            alert.textContent = 'Failed to update mapping';
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 3000);
        });
    }

    // Load mappings for all rental classes on page load
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.rental-class').forEach(select => loadMapping(select));
    });
</script>
{% endblock %}
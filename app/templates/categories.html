{% extends "base.html" %}

{% block title %}Manage Categories{% endblock %}

{% block content %}
<h1>Manage Categories</h1>
<div id="category-mappings">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Category</th>
                <th>Subcategory</th>
                <th>Rental Class ID</th>
                <th>Common Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="mappings-table">
            {% for category in categories %}
            <tr>
                <td><input type="text" class="form-control category-input" value="{{ category.category }}"></td>
                <td><input type="text" class="form-control subcategory-input" value="{{ category.subcategory }}"></td>
                <td><input type="text" class="form-control rental-class-id-input" value="{{ category.rental_class_id }}"></td>
                <td>{{ category.common_name }}</td>
                <td><button class="btn btn-danger" onclick="removeMappingRow(this)">Remove</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button class="btn btn-primary" onclick="addMappingRow()">Add Mapping</button>
    <button class="btn btn-success" onclick="saveMappings()">Save Mappings</button>
</div>

<script>
    let mappings = [];

    function addMappingRow(mapping = {category: '', subcategory: '', rental_class_id: '', common_name: 'N/A'}) {
        const tableBody = document.getElementById('mappings-table');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" class="form-control category-input" value="${mapping.category}"></td>
            <td><input type="text" class="form-control subcategory-input" value="${mapping.subcategory}"></td>
            <td><input type="text" class="form-control rental-class-id-input" value="${mapping.rental_class_id}"></td>
            <td>${mapping.common_name}</td>
            <td><button class="btn btn-danger" onclick="removeMappingRow(this)">Remove</button></td>
        `;
        tableBody.appendChild(row);
    }

    function removeMappingRow(button) {
        button.parentElement.parentElement.remove();
    }

    function saveMappings() {
        const rows = document.querySelectorAll('#mappings-table tr');
        const mappings = Array.from(rows).map(row => {
            return {
                category: row.querySelector('.category-input').value.trim(),
                subcategory: row.querySelector('.subcategory-input').value.trim(),
                rental_class_id: row.querySelector('.rental-class-id-input').value.trim()
            };
        });

        // Deduplicate rental_class_id entries, keeping the last occurrence
        const deduplicatedMappings = [];
        const seenIds = new Set();
        for (let i = mappings.length - 1; i >= 0; i--) {
            const mapping = mappings[i];
            if (mapping.rental_class_id && !seenIds.has(mapping.rental_class_id)) {
                seenIds.add(mapping.rental_class_id);
                deduplicatedMappings.unshift(mapping);
            }
        }

        // Remove entries with empty rental_class_id
        const validMappings = deduplicatedMappings.filter(mapping => mapping.rental_class_id !== '');

        if (validMappings.length === 0) {
            alert('Error: No valid mappings to save. Please ensure all rows have a Rental Class ID.');
            return;
        }

        fetch('/categories/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(validMappings)
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert(data.message);
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error saving mappings:', error);
            alert('Failed to save mappings');
        });
    }

    // Load existing mappings
    fetch('/categories/mapping')
        .then(response => response.json())
        .then(data => {
            data.forEach(mapping => addMappingRow(mapping));
        })
        .catch(error => {
            console.error('Error loading mappings:', error);
            alert('Failed to load mappings');
        });
</script>
{% endblock %}
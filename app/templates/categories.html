{% extends "base.html" %}

{% block title %}Manage Categories{% endblock %}

{% block content %}
<h1>Manage Categories</h1>
<div id="category-mappings">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Category</th>
                <th>Subcategory</th>
                <th>Rental Class ID</th>
                <th>Common Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="mappings-table">
            {% for category in categories %}
            <tr data-rental-class-id="{{ category.rental_class_id }}" data-original-category="{{ category.category }}" data-original-subcategory="{{ category.subcategory }}">
                <td><input type="text" class="form-control category-input" value="{{ category.category }}"></td>
                <td><input type="text" class="form-control subcategory-input" value="{{ category.subcategory }}"></td>
                <td><input type="text" class="form-control rental-class-id-input" value="{{ category.rental_class_id }}"></td>
                <td>{{ category.common_name }}</td>
                <td><button class="btn btn-danger" onclick="removeMappingRow(this)">Remove</button></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <button class="btn btn-primary" onclick="addMappingRow()">Add Mapping</button>
    <button class="btn btn-success" onclick="confirmSaveMappings()">Save Mappings</button>
</div>

<script>
    let mappings = [];

    function addMappingRow(mapping = {category: '', subcategory: '', rental_class_id: '', common_name: 'N/A'}) {
        const tableBody = document.getElementById('mappings-table');
        const existingRow = tableBody.querySelector(`tr[data-rental-class-id="${mapping.rental_class_id}"]`);
        if (existingRow) {
            console.log(`Skipping duplicate rental_class_id: ${mapping.rental_class_id}`);
            return;
        }

        const row = document.createElement('tr');
        row.setAttribute('data-rental-class-id', mapping.rental_class_id);
        row.setAttribute('data-original-category', mapping.category);
        row.setAttribute('data-original-subcategory', mapping.subcategory);
        row.innerHTML = `
            <td><input type="text" class="form-control category-input" value="${mapping.category}"></td>
            <td><input type="text" class="form-control subcategory-input" value="${mapping.subcategory}"></td>
            <td><input type="text" class="form-control rental-class-id-input" value="${mapping.rental_class_id}"></td>
            <td>${mapping.common_name}</td>
            <td><button class="btn btn-danger" onclick="removeMappingRow(this)">Remove</button></td>
        `;
        tableBody.appendChild(row);
    }

    function removeMappingRow(button) {
        const row = button.parentElement.parentElement;
        const rentalClassId = row.getAttribute('data-rental-class-id');
        if (!rentalClassId) {
            row.remove();
            return;
        }

        fetch('/categories/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ rental_class_id: rentalClassId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert(data.message);
                row.remove();
            }
        })
        .catch(error => {
            console.error('Error deleting mapping:', error);
            alert('Failed to delete mapping');
        });
    }

    function collectMappings() {
        const rows = document.querySelectorAll('#mappings-table tr');
        console.log(`Found ${rows.length} rows in mappings table`);

        const rentalClassIds = new Set();
        const mappings = [];
        rows.forEach((row, index) => {
            const rentalClassId = row.querySelector('.rental-class-id-input')?.value.trim();
            if (!rentalClassId) return;

            if (rentalClassIds.has(rentalClassId)) {
                console.warn(`Duplicate rental_class_id found: ${rentalClassId} at row ${index}`);
            }
            rentalClassIds.add(rentalClassId);

            const categoryInput = row.querySelector('.category-input');
            const subcategoryInput = row.querySelector('.subcategory-input');

            const categoryValue = categoryInput ? categoryInput.value : '';
            const subcategoryValue = subcategoryInput ? subcategoryInput.value : '';

            console.log(`Row ${index} (rental_class_id=${rentalClassId}): raw category='${categoryValue}', raw subcategory='${subcategoryValue}'`);

            mappings.push({
                category: categoryValue.trim(),
                subcategory: subcategoryValue.trim(),
                rental_class_id: rentalClassId
            });
        });

        const deduplicatedMappings = [];
        const seenIds = new Set();
        for (let i = mappings.length - 1; i >= 0; i--) {
            const mapping = mappings[i];
            if (mapping.rental_class_id && !seenIds.has(mapping.rental_class_id)) {
                seenIds.add(mapping.rental_class_id);
                deduplicatedMappings.unshift(mapping);
            }
        }

        return deduplicatedMappings.filter(mapping => mapping.rental_class_id !== '');
    }

    function confirmSaveMappings() {
        const validMappings = collectMappings();
        console.log('Mappings to be saved:', validMappings);

        if (validMappings.length === 0) {
            alert('Error: No valid mappings to save. Please ensure all rows have a Rental Class ID.');
            return;
        }

        const changedMappings = [];
        validMappings.forEach(mapping => {
            const rows = document.querySelectorAll(`tr[data-rental-class-id="${mapping.rental_class_id}"]`);
            if (rows.length > 1) {
                console.error(`Multiple rows found for rental_class_id=${mapping.rental_class_id}: ${rows.length} rows`);
            }

            const row = rows[0];
            if (!row) {
                changedMappings.push(mapping);
                console.log(`New mapping added:`, mapping);
                return;
            }

            const originalCategory = (row.getAttribute('data-original-category') || '').trim();
            const originalSubcategory = (row.getAttribute('data-original-subcategory') || '').trim();
            const currentCategory = (mapping.category || '').trim();
            const currentSubcategory = (mapping.subcategory || '').trim();

            console.log(`Comparing rental_class_id=${mapping.rental_class_id}: originalCategory='${originalCategory}', currentCategory='${currentCategory}', originalSubcategory='${originalSubcategory}', currentSubcategory='${currentSubcategory}'`);

            if (currentCategory !== originalCategory || currentSubcategory !== originalSubcategory) {
                changedMappings.push(mapping);
                console.log(`Change detected for rental_class_id=${mapping.rental_class_id}:`, { originalCategory, currentCategory, originalSubcategory, currentSubcategory });
            }
        });

        console.log('Changed mappings:', changedMappings);

        if (changedMappings.length === 0) {
            alert('No changes detected to save.');
            return;
        }

        if (confirm(`You are about to save ${changedMappings.length} changes. Continue?`)) {
            saveMappings(validMappings);
        }
    }

    function saveMappings(validMappings) {
        fetch('/categories/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(validMappings)
        })
        .then(response => {
            console.log('Save response:', response);
            return response.json();
        })
        .then(data => {
            console.log('Save response data:', data);
            if (data.error) {
                alert('Error: ' + data.error);
            } else {
                alert(data.message);
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error saving mappings:', error);
            alert('Failed to save mappings');
        });
    }

    // Clear the table before loading mappings to prevent duplicates
    document.getElementById('mappings-table').innerHTML = '';

    fetch('/categories/mapping')
        .then(response => response.json())
        .then(data => {
            console.log('Loaded mappings:', data);
            data.forEach(mapping => addMappingRow(mapping));
        })
        .catch(error => {
            console.error('Error loading mappings:', error);
            alert('Failed to load mappings');
        });

    document.addEventListener('DOMContentLoaded', () => {
        if (typeof window.applyFilters === 'function') {
            window.applyFilters();
        } else {
            console.warn('applyFilters function is not available after DOM load');
        }
    });
</script>
{% endblock %}
{% extends "base.html" %}
{% block title %}Inventory & Analytics{% endblock %}
{% block extra_head %}
<style>
    .dashboard-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        color: white;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: #7f8c8d;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .health-score {
        font-size: 3rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .alert-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 0.25rem;
        text-transform: uppercase;
    }
    
    .alert-critical { background-color: #dc3545; color: white; }
    .alert-high { background-color: #fd7e14; color: white; }
    .alert-medium { background-color: #ffc107; color: black; }
    .alert-low { background-color: #28a745; color: white; }
    
    .stale-item {
        padding: 10px;
        border-left: 4px solid #e74c3c;
        background-color: #fdf2f2;
        margin-bottom: 8px;
        border-radius: 4px;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .tab-content {
        margin-top: 20px;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #667eea;
        color: white;
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card text-center">
                <h1><i class="fas fa-chart-line"></i> Inventory & Analytics Dashboard</h1>
                <p class="mb-0">Real-time inventory health monitoring and usage analysis</p>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="health-score" id="health-score">--</div>
                        <div>Overall Health Score</div>
                    </div>
                    <div class="col-md-4">
                        <div class="health-score" id="total-items">--</div>
                        <div>Total Items</div>
                    </div>
                    <div class="col-md-4">
                        <div class="health-score" id="active-alerts">--</div>
                        <div>Active Alerts</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Key Metrics Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value text-success" id="items-on-rent">--</div>
                <div class="metric-label">On Rent</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value text-primary" id="items-available">--</div>
                <div class="metric-label">Available</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value text-warning" id="items-in-service">--</div>
                <div class="metric-label">In Service</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value text-info" id="utilization-rate">--%</div>
                <div class="metric-label">Utilization Rate</div>
            </div>
        </div>
    </div>
    
    <!-- Tabs for Different Views -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="analyticsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="alerts-tab" data-mdb-toggle="tab" data-mdb-target="#alerts" type="button" role="tab" aria-controls="alerts" aria-selected="true">
                        <i class="fas fa-exclamation-triangle"></i> Health Alerts
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stale-items-tab" data-mdb-toggle="tab" data-mdb-target="#stale-items" type="button" role="tab" aria-controls="stale-items" aria-selected="false">
                        <i class="fas fa-clock"></i> Stale Items
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="usage-analysis-tab" data-mdb-toggle="tab" data-mdb-target="#usage-analysis" type="button" role="tab" aria-controls="usage-analysis" aria-selected="false">
                        <i class="fas fa-chart-bar"></i> Usage Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="resale-tracking-tab" data-mdb-toggle="tab" data-mdb-target="#resale-tracking" type="button" role="tab" aria-controls="resale-tracking" aria-selected="false">
                        <i class="fas fa-shopping-cart"></i> Resale Tracking
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="configuration-tab" data-mdb-toggle="tab" data-mdb-target="#configuration" type="button" role="tab" aria-controls="configuration" aria-selected="false">
                        <i class="fas fa-cog"></i> Configuration
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="analyticsTabContent">
                <!-- Health Alerts Tab -->
                <div class="tab-pane fade show active" id="alerts" role="tabpanel" aria-labelledby="alerts-tab">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5><i class="fas fa-bell"></i> Active Health Alerts</h5>
                                        <button class="btn btn-primary btn-sm" id="generate-alerts-btn" onclick="generateAlerts()" 
                                                title="Scans stale items and creates health alerts based on current configuration thresholds. This creates alert records in the database for proactive inventory management.">
                                            <i class="fas fa-sync"></i> Generate Alerts
                                        </button>
                                    </div>
                                    <div class="d-flex gap-2 mt-2">
                                        <select class="form-select form-select-sm" id="alert-category-filter" onchange="filterHealthAlerts()">
                                            <option value="">All Categories</option>
                                        </select>
                                        <select class="form-select form-select-sm" id="alert-severity-filter" onchange="filterHealthAlerts()">
                                            <option value="">All Severities</option>
                                            <option value="critical">Critical</option>
                                            <option value="high">High</option>
                                            <option value="medium">Medium</option>
                                            <option value="low">Low</option>
                                        </select>
                                        <select class="form-select form-select-sm" id="alert-type-filter" onchange="filterHealthAlerts()">
                                            <option value="">All Types</option>
                                            <option value="stale_item">Stale Items</option>
                                            <option value="high_usage">High Usage</option>
                                            <option value="low_usage">Low Usage</option>
                                            <option value="missing">Missing</option>
                                            <option value="quality_decline">Quality Decline</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="alerts-loading" class="text-center">
                                        <div class="loading-spinner"></div> Loading alerts...
                                    </div>
                                    <div id="alerts-content" style="display: none;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <div id="alerts-count" class="text-muted">Loading...</div>
                                            <div class="d-flex align-items-center gap-2">
                                                <label class="form-label mb-0">Items per page:</label>
                                                <select class="form-select form-select-sm" id="alerts-per-page" onchange="updateAlertsPagination()" style="width: auto;">
                                                    <option value="10">10</option>
                                                    <option value="25" selected>25</option>
                                                    <option value="50">50</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div id="alerts-list"></div>
                                        <div id="alerts-pagination" class="d-flex justify-content-center mt-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie"></i> Alert Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <span class="alert-badge alert-critical" id="critical-count">0</span> Critical
                                    </div>
                                    <div class="mb-2">
                                        <span class="alert-badge alert-high" id="high-count">0</span> High
                                    </div>
                                    <div class="mb-2">
                                        <span class="alert-badge alert-medium" id="medium-count">0</span> Medium
                                    </div>
                                    <div class="mb-2">
                                        <span class="alert-badge alert-low" id="low-count">0</span> Low
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stale Items Tab -->
                <div class="tab-pane fade" id="stale-items" role="tabpanel" aria-labelledby="stale-items-tab">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5><i class="fas fa-clock"></i> Items Not Recently Scanned</h5>
                                    <small class="text-muted">Items that haven't been scanned recently based on category-specific thresholds</small>
                                </div>
                                <div class="d-flex gap-2">
                                    <select class="form-select form-select-sm" id="stale-category-filter" onchange="filterStaleItems()">
                                        <option value="">All Categories</option>
                                    </select>
                                    <select class="form-select form-select-sm" id="stale-subcategory-filter" onchange="filterStaleItems()">
                                        <option value="">All Subcategories</option>
                                    </select>
                                    <select class="form-select form-select-sm" id="stale-days-filter" onchange="filterStaleItems()">
                                        <option value="">All Days</option>
                                        <option value="7">7+ Days</option>
                                        <option value="30">30+ Days</option>
                                        <option value="90">90+ Days</option>
                                        <option value="180">180+ Days</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="stale-items-loading" class="text-center">
                                <div class="loading-spinner"></div> Analyzing scan history...
                            </div>
                            <div id="stale-items-content" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div id="stale-items-count" class="text-muted">Loading...</div>
                                    <div class="d-flex align-items-center gap-2">
                                        <label class="form-label mb-0">Items per page:</label>
                                        <select class="form-select form-select-sm" id="stale-items-per-page" onchange="updateStaleItemsPagination()" style="width: auto;">
                                            <option value="10">10</option>
                                            <option value="25" selected>25</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                    </div>
                                </div>
                                <div id="stale-items-list"></div>
                                <div id="stale-items-pagination" class="d-flex justify-content-center mt-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Usage Analysis Tab -->
                <div class="tab-pane fade" id="usage-analysis" role="tabpanel" aria-labelledby="usage-analysis-tab">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-line"></i> Usage Patterns</h5>
                                </div>
                                <div class="card-body">
                                    <div id="usage-patterns-loading" class="text-center">
                                        <div class="loading-spinner"></div> Loading usage patterns...
                                    </div>
                                    <div id="usage-patterns-content" style="display: none;">
                                        <div id="usage-patterns-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5><i class="fas fa-exclamation-circle"></i> Data Discrepancies</h5>
                                </div>
                                <div class="card-body">
                                    <div id="discrepancies-loading" class="text-center">
                                        <div class="loading-spinner"></div> Analyzing data discrepancies...
                                    </div>
                                    <div id="discrepancies-content" style="display: none;">
                                        <div id="discrepancies-summary"></div>
                                        <div id="discrepancies-list" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-database"></i> Database Health Summary</h5>
                                    <button class="btn btn-primary btn-sm" onclick="refreshAnalysisData()">
                                        <i class="fas fa-refresh"></i> Refresh Analysis
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <div class="metric-card">
                                                <div class="metric-value text-info" id="total-master-items">--</div>
                                                <div class="metric-label">Items in Master</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="metric-card">
                                                <div class="metric-value text-success" id="items-with-transactions">--</div>
                                                <div class="metric-label">Items with Transactions</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="metric-card">
                                                <div class="metric-value text-warning" id="orphaned-transactions">--</div>
                                                <div class="metric-label">Orphaned Transactions</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="metric-card">
                                                <div class="metric-value text-danger" id="data-sync-issues">--</div>
                                                <div class="metric-label">Data Sync Issues</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Resale Tracking Tab -->
                <div class="tab-pane fade" id="resale-tracking" role="tabpanel" aria-labelledby="resale-tracking-tab">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-shopping-cart"></i> Resale & Pack Status Tracking</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Specialized tracking for resale items and pack status management coming in Phase 2...</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Resale Item Features:</h6>
                                    <ul>
                                        <li>Automatic restock alerts (7-day threshold)</li>
                                        <li>Consumption rate tracking</li>
                                        <li>Low inventory warnings</li>
                                        <li>Supplier order suggestions</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Pack Status Management:</h6>
                                    <ul>
                                        <li>Pack/unpack recommendations based on demand</li>
                                        <li>Storage optimization alerts</li>
                                        <li>Bulk item tracking</li>
                                        <li>Space utilization analysis</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Configuration Tab -->
                <div class="tab-pane fade" id="configuration" role="tabpanel" aria-labelledby="configuration-tab">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cog"></i> Inventory Analytics Configuration</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-bell"></i> Alert Thresholds</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Stale Item Days (Default Categories)</label>
                                        <input type="number" class="form-control config-input" id="stale-default" value="30" min="1" max="365">
                                        <small class="form-text text-muted">Days without scan before item is flagged as stale</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Stale Item Days (Resale Categories)</label>
                                        <input type="number" class="form-control config-input" id="stale-resale" value="7" min="1" max="90">
                                        <small class="form-text text-muted">Shorter threshold for resale items</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Stale Item Days (Pack Location)</label>
                                        <input type="number" class="form-control config-input" id="stale-pack" value="14" min="1" max="180">
                                        <small class="form-text text-muted">Threshold for items in pack locations</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-chart-line"></i> Usage Thresholds</h6>
                                    <div class="mb-3">
                                        <label class="form-label">High Usage Threshold</label>
                                        <input type="number" class="form-control config-input" id="high-usage" value="0.8" min="0.1" max="1.0" step="0.1">
                                        <small class="form-text text-muted">Utilization rate above this triggers high usage alerts</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Low Usage Threshold</label>
                                        <input type="number" class="form-control config-input" id="low-usage" value="0.2" min="0.0" max="0.9" step="0.1">
                                        <small class="form-text text-muted">Utilization rate below this triggers low usage alerts</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Quality Decline Threshold</label>
                                        <input type="number" class="form-control config-input" id="quality-decline" value="2" min="1" max="5">
                                        <small class="form-text text-muted">Grade drops triggering quality decline alerts</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6><i class="fas fa-save"></i> Configuration Management</h6>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success" id="save-config-btn" onclick="saveConfiguration()">
                                            <i class="fas fa-save"></i> Save Configuration
                                        </button>
                                        <button class="btn btn-secondary" id="reset-config-btn" onclick="resetConfiguration()">
                                            <i class="fas fa-undo"></i> Reset to Defaults
                                        </button>
                                        <button class="btn btn-info" id="load-config-btn" onclick="loadConfiguration()">
                                            <i class="fas fa-refresh"></i> Reload Current
                                        </button>
                                    </div>
                                    <div class="mt-2">
                                        <div class="alert alert-info" id="config-status" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class InventoryAnalytics {
    constructor() {
        this.refreshInterval = null;
        this.init();
    }
    
    init() {
        console.log('Initializing Inventory Analytics dashboard');
        this.loadDashboardData();
        this.setupEventHandlers();
        this.startAutoRefresh();
    }
    
    async loadDashboardData() {
        try {
            console.log('Loading dashboard summary data');
            const response = await fetch('/api/inventory/dashboard_summary');
            const data = await response.json();
            
            if (response.ok) {
                this.updateDashboardMetrics(data);
            } else {
                console.error('Failed to load dashboard data:', data.error);
                this.showError('Failed to load dashboard data');
            }
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            this.showError('Error loading dashboard data');
        }
    }
    
    updateDashboardMetrics(data) {
        const inventory = data.inventory_overview;
        const health = data.health_metrics;
        
        // Update main dashboard cards
        document.getElementById('health-score').textContent = health.health_score;
        document.getElementById('total-items').textContent = inventory.total_items.toLocaleString();
        document.getElementById('active-alerts').textContent = health.active_alerts;
        
        // Update metric cards
        document.getElementById('items-on-rent').textContent = inventory.items_on_rent.toLocaleString();
        document.getElementById('items-available').textContent = inventory.items_available.toLocaleString();
        document.getElementById('items-in-service').textContent = inventory.items_in_service.toLocaleString();
        document.getElementById('utilization-rate').textContent = inventory.utilization_rate + '%';
        
        // Update alert counts
        document.getElementById('critical-count').textContent = health.critical_alerts;
        document.getElementById('high-count').textContent = health.high_alerts;
        document.getElementById('medium-count').textContent = health.medium_alerts;
        document.getElementById('low-count').textContent = health.low_alerts;
        
        // Apply health score color coding
        const healthScoreEl = document.getElementById('health-score');
        if (health.health_score >= 90) {
            healthScoreEl.style.color = '#28a745'; // Green
        } else if (health.health_score >= 70) {
            healthScoreEl.style.color = '#ffc107'; // Yellow
        } else {
            healthScoreEl.style.color = '#dc3545'; // Red
        }
        
        console.log('Dashboard metrics updated successfully');
    }
    
    async loadHealthAlerts() {
        try {
            document.getElementById('alerts-loading').style.display = 'block';
            document.getElementById('alerts-content').style.display = 'none';
            
            const response = await fetch('/api/inventory/alerts');
            const data = await response.json();
            
            if (response.ok) {
                // Store all alerts globally
                allHealthAlerts = data.alerts || [];
                
                // Populate category filter
                const categories = [...new Set(allHealthAlerts.map(alert => alert.category).filter(Boolean))];
                const categorySelect = document.getElementById('alert-category-filter');
                categorySelect.innerHTML = '<option value="">All Categories</option>';
                categories.forEach(cat => {
                    categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                });
                
                // Display filtered alerts
                filterHealthAlerts();
            } else {
                console.error('Failed to load alerts:', data.error);
                this.showError('Failed to load alerts', 'alerts-list');
            }
        } catch (error) {
            console.error('Error loading health alerts:', error);
            this.showError('Error loading health alerts', 'alerts-list');
        } finally {
            document.getElementById('alerts-loading').style.display = 'none';
            document.getElementById('alerts-content').style.display = 'block';
        }
    }
    
    // Class method removed - using standalone function instead
    
    async loadStaleItems() {
        // Redirect to standalone function
        return loadAllStaleItems().then(() => {
            // Populate filters after loading
            const categories = [...new Set(allStaleItems.map(item => item.category).filter(Boolean))];
            const categorySelect = document.getElementById('stale-category-filter');
            categorySelect.innerHTML = '<option value="">All Categories</option>';
            categories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            
            const subcategories = [...new Set(allStaleItems.map(item => item.subcategory).filter(Boolean))];
            const subcategorySelect = document.getElementById('stale-subcategory-filter');
            subcategorySelect.innerHTML = '<option value="">All Subcategories</option>';
            subcategories.forEach(sub => {
                subcategorySelect.innerHTML += `<option value="${sub}">${sub}</option>`;
            });
            
            filterStaleItems();
        });
    }
    
    // Class method removed - using standalone function instead
    
    setupEventHandlers() {
        // Tab change handlers
        document.addEventListener('shown.bs.tab', (event) => {
            const targetTab = event.target.getAttribute('data-bs-target');
            console.log('Tab changed to:', targetTab);
            
            if (targetTab === '#alerts') {
                loadAllHealthAlerts();
            } else if (targetTab === '#stale-items') {
                loadAllStaleItems().then(() => {
                    // Populate filters after loading
                    const categories = [...new Set(allStaleItems.map(item => item.category).filter(Boolean))];
                    const categorySelect = document.getElementById('stale-category-filter');
                    categorySelect.innerHTML = '<option value="">All Categories</option>';
                    categories.forEach(cat => {
                        categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                    });
                    
                    const subcategories = [...new Set(allStaleItems.map(item => item.subcategory).filter(Boolean))];
                    const subcategorySelect = document.getElementById('stale-subcategory-filter');
                    subcategorySelect.innerHTML = '<option value="">All Subcategories</option>';
                    subcategories.forEach(sub => {
                        subcategorySelect.innerHTML += `<option value="${sub}">${sub}</option>`;
                    });
                    
                    filterStaleItems();
                });
            }
        });
        
        // Alternative tab click handler for better compatibility
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('click', (event) => {
                const targetTab = event.target.getAttribute('data-bs-target');
                console.log('Tab clicked:', targetTab);
                
                // Small delay to ensure tab is shown
                setTimeout(() => {
                    if (targetTab === '#alerts') {
                        loadAllHealthAlerts();
                    } else if (targetTab === '#stale-items') {
                        loadAllStaleItems().then(() => {
                            // Populate filters after loading
                            const categories = [...new Set(allStaleItems.map(item => item.category).filter(Boolean))];
                            const categorySelect = document.getElementById('stale-category-filter');
                            categorySelect.innerHTML = '<option value="">All Categories</option>';
                            categories.forEach(cat => {
                                categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
                            });
                            
                            const subcategories = [...new Set(allStaleItems.map(item => item.subcategory).filter(Boolean))];
                            const subcategorySelect = document.getElementById('stale-subcategory-filter');
                            subcategorySelect.innerHTML = '<option value="">All Subcategories</option>';
                            subcategories.forEach(sub => {
                                subcategorySelect.innerHTML += `<option value="${sub}">${sub}</option>`;
                            });
                            
                            filterStaleItems();
                        });
                    }
                }, 100);
            });
        });
        
        // Alert filter change handled by HTML onchange attribute
        
        // Load initial tab content
        setTimeout(() => {
            if (document.querySelector('#alerts.show.active')) {
                loadAllHealthAlerts();
            }
        }, 100);
    }
    
    async generateAlerts() {
        try {
            const button = document.getElementById('generate-alerts-btn');
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="loading-spinner"></div> Generating...';
            button.disabled = true;
            
            const response = await fetch('/api/inventory/generate_alerts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const data = await response.json();
            
            if (response.ok) {
                console.log('Alerts generated successfully:', data);
                // Refresh the dashboard and alerts
                this.loadDashboardData();
                this.loadHealthAlerts();
                
                // Show detailed success message
                let message = `Alert Generation Complete: ${data.alerts_created} alerts created`;
                if (data.stale_items_processed) {
                    message += ` from ${data.stale_items_processed} stale items analyzed`;
                }
                if (data.existing_alerts_updated) {
                    message += `, ${data.existing_alerts_updated} existing alerts updated`;
                }
                this.showSuccess(message);
            } else {
                console.error('Failed to generate alerts:', data.error);
                this.showError('Failed to generate alerts: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error generating alerts:', error);
            this.showError('Error generating alerts');
        } finally {
            const button = document.getElementById('generate-alerts-btn');
            button.innerHTML = '<i class="fas fa-sync"></i> Generate Alerts';
            button.disabled = false;
        }
    }
    
    startAutoRefresh() {
        // Refresh dashboard data every 5 minutes
        this.refreshInterval = setInterval(() => {
            console.log('Auto-refreshing dashboard data');
            this.loadDashboardData();
        }, 5 * 60 * 1000);
    }
    
    showError(message, containerId = null) {
        const errorHtml = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
        
        if (containerId) {
            document.getElementById(containerId).innerHTML = errorHtml;
        } else {
            // Show in a toast or modal
            console.error(message);
        }
    }
    
    showSuccess(message) {
        // Create a temporary success message
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
        successDiv.style.top = '20px';
        successDiv.style.right = '20px';
        successDiv.style.zIndex = '9999';
        successDiv.innerHTML = `
            <i class="fas fa-check-circle"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(successDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 5000);
    }
}

// Make generateAlerts globally available
function generateAlerts() {
    if (window.inventoryAnalytics) {
        window.inventoryAnalytics.generateAlerts();
    }
}

// Configuration management functions
async function loadConfiguration() {
    try {
        const response = await fetch('/api/inventory/configuration');
        if (response.ok) {
            const config = await response.json();
            
            // Load alert thresholds
            const alertThresholds = config.alert_thresholds || {};
            document.getElementById('stale-default').value = alertThresholds.stale_item_days?.default || 30;
            document.getElementById('stale-resale').value = alertThresholds.stale_item_days?.resale || 7;
            document.getElementById('stale-pack').value = alertThresholds.stale_item_days?.pack || 14;
            document.getElementById('high-usage').value = alertThresholds.high_usage_threshold || 0.8;
            document.getElementById('low-usage').value = alertThresholds.low_usage_threshold || 0.2;
            document.getElementById('quality-decline').value = alertThresholds.quality_decline_threshold || 2;
            
            showConfigStatus('Configuration loaded successfully', 'success');
        } else {
            showConfigStatus('Failed to load configuration', 'error');
        }
    } catch (error) {
        console.error('Error loading configuration:', error);
        showConfigStatus('Error loading configuration', 'error');
    }
}

async function saveConfiguration() {
    try {
        const config = {
            alert_thresholds: {
                stale_item_days: {
                    default: parseInt(document.getElementById('stale-default').value),
                    resale: parseInt(document.getElementById('stale-resale').value),
                    pack: parseInt(document.getElementById('stale-pack').value)
                },
                high_usage_threshold: parseFloat(document.getElementById('high-usage').value),
                low_usage_threshold: parseFloat(document.getElementById('low-usage').value),
                quality_decline_threshold: parseInt(document.getElementById('quality-decline').value)
            }
        };
        
        const response = await fetch('/api/inventory/configuration', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        
        if (response.ok) {
            showConfigStatus('Configuration saved successfully', 'success');
        } else {
            const error = await response.json();
            showConfigStatus('Failed to save: ' + (error.message || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error saving configuration:', error);
        showConfigStatus('Error saving configuration', 'error');
    }
}

function resetConfiguration() {
    // Reset to default values
    document.getElementById('stale-default').value = 30;
    document.getElementById('stale-resale').value = 7;
    document.getElementById('stale-pack').value = 14;
    document.getElementById('high-usage').value = 0.8;
    document.getElementById('low-usage').value = 0.2;
    document.getElementById('quality-decline').value = 2;
    showConfigStatus('Configuration reset to defaults', 'info');
}

function showConfigStatus(message, type) {
    const statusDiv = document.getElementById('config-status');
    statusDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}`;
    statusDiv.textContent = message;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 3000);
}

// Usage Analysis functions
async function loadUsagePatterns() {
    try {
        document.getElementById('usage-patterns-loading').style.display = 'block';
        document.getElementById('usage-patterns-content').style.display = 'none';
        
        const response = await fetch('/api/inventory/usage_patterns');
        const data = await response.json();
        
        if (response.ok) {
            displayUsagePatterns(data.patterns);
        } else {
            document.getElementById('usage-patterns-list').innerHTML = 
                `<div class="alert alert-danger">Error loading patterns: ${data.error}</div>`;
        }
    } catch (error) {
        console.error('Error loading usage patterns:', error);
        document.getElementById('usage-patterns-list').innerHTML = 
            '<div class="alert alert-danger">Error loading usage patterns</div>';
    } finally {
        document.getElementById('usage-patterns-loading').style.display = 'none';
        document.getElementById('usage-patterns-content').style.display = 'block';
    }
}

function displayUsagePatterns(patterns) {
    let html = '';
    if (patterns && patterns.length > 0) {
        patterns.slice(0, 10).forEach(pattern => {
            const percentage = ((pattern.usage_rate || 0) * 100).toFixed(1);
            html += `
                <div class="border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between">
                        <strong>${pattern.category || 'Unknown'}</strong>
                        <span class="badge bg-${percentage > 70 ? 'success' : percentage > 40 ? 'warning' : 'secondary'}">${percentage}%</span>
                    </div>
                    <small class="text-muted">${pattern.subcategory || ''}</small>
                    <div class="mt-1">
                        <small>${pattern.total_items || 0} items • ${pattern.rental_count || 0} rentals</small>
                    </div>
                </div>
            `;
        });
    } else {
        html = '<p class="text-muted">No usage patterns found.</p>';
    }
    document.getElementById('usage-patterns-list').innerHTML = html;
}

async function loadDataDiscrepancies() {
    try {
        document.getElementById('discrepancies-loading').style.display = 'block';
        document.getElementById('discrepancies-content').style.display = 'none';
        
        const response = await fetch('/api/inventory/data_discrepancies');
        const data = await response.json();
        
        if (response.ok) {
            displayDataDiscrepancies(data);
        } else {
            document.getElementById('discrepancies-list').innerHTML = 
                `<div class="alert alert-danger">Error loading discrepancies: ${data.error}</div>`;
        }
    } catch (error) {
        console.error('Error loading data discrepancies:', error);
        document.getElementById('discrepancies-list').innerHTML = 
            '<div class="alert alert-danger">Error loading data discrepancies</div>';
    } finally {
        document.getElementById('discrepancies-loading').style.display = 'none';
        document.getElementById('discrepancies-content').style.display = 'block';
    }
}

function displayDataDiscrepancies(data) {
    // Update summary metrics
    document.getElementById('total-master-items').textContent = data.summary?.total_master_items || '--';
    document.getElementById('items-with-transactions').textContent = data.summary?.items_with_transactions || '--';
    document.getElementById('orphaned-transactions').textContent = data.summary?.orphaned_transactions || '--';
    document.getElementById('data-sync-issues').textContent = data.summary?.data_sync_issues || '--';
    
    // Display summary
    let summaryHtml = '<div class="alert alert-info">';
    summaryHtml += `<h6>Data Quality Overview</h6>`;
    summaryHtml += `<p>Found ${data.summary?.data_sync_issues || 0} items with potential sync issues out of ${data.summary?.total_master_items || 0} total items.</p>`;
    summaryHtml += '</div>';
    document.getElementById('discrepancies-summary').innerHTML = summaryHtml;
    
    // Display discrepancy details
    let html = '';
    if (data.discrepancies && data.discrepancies.length > 0) {
        html += '<h6>Top Data Discrepancies:</h6>';
        data.discrepancies.slice(0, 5).forEach(disc => {
            html += `
                <div class="border-left-warning p-2 mb-2 bg-light">
                    <div class="d-flex justify-content-between">
                        <strong>${disc.tag_id}</strong>
                        <span class="badge bg-warning">${disc.issue_type}</span>
                    </div>
                    <small class="text-muted">${disc.common_name || 'Unknown Item'}</small>
                    <div class="mt-1">
                        <small>Master: ${disc.master_last_scan || 'None'} • Transactions: ${disc.latest_transaction || 'None'}</small>
                    </div>
                </div>
            `;
        });
    } else {
        html = '<p class="text-success"><i class="fas fa-check"></i> No significant data discrepancies found.</p>';
    }
    document.getElementById('discrepancies-list').innerHTML = html;
}

function refreshAnalysisData() {
    loadUsagePatterns();
    loadDataDiscrepancies();
}

// Global data storage and pagination state
let allHealthAlerts = [];
let allStaleItems = [];
let currentAlertsPage = 1;
let currentStaleItemsPage = 1;

// Load ALL health alerts by making multiple API calls if needed
async function loadAllHealthAlerts() {
    try {
        document.getElementById('alerts-loading').style.display = 'block';
        document.getElementById('alerts-content').style.display = 'none';
        
        let allAlerts = [];
        let offset = 0;
        const limit = 200; // API max limit
        let hasMore = true;
        
        while (hasMore) {
            const response = await fetch(`/api/inventory/alerts?limit=${limit}&offset=${offset}`);
            const data = await response.json();
            
            if (response.ok && data.alerts) {
                allAlerts = allAlerts.concat(data.alerts);
                hasMore = data.pagination.has_more;
                offset += limit;
                
                // Show progress
                console.log(`Loaded ${allAlerts.length} alerts so far...`);
            } else {
                hasMore = false;
                console.error('Failed to load alerts:', data.error);
            }
        }
        
        console.log(`Loaded ${allAlerts.length} total alerts`);
        allHealthAlerts = allAlerts;
        
        // Populate category filter
        const categories = [...new Set(allHealthAlerts.map(alert => alert.category).filter(Boolean))];
        const categorySelect = document.getElementById('alert-category-filter');
        categorySelect.innerHTML = '<option value="">All Categories</option>';
        categories.forEach(cat => {
            categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
        
        // Display filtered alerts
        filterHealthAlerts();
        
    } catch (error) {
        console.error('Error loading all health alerts:', error);
        document.getElementById('alerts-list').innerHTML = '<div class="alert alert-danger">Error loading alerts</div>';
    } finally {
        document.getElementById('alerts-loading').style.display = 'none';
        document.getElementById('alerts-content').style.display = 'block';
    }
}

// Load ALL stale items by making multiple API calls if needed
async function loadAllStaleItems() {
    try {
        // Show loading state
        document.getElementById('stale-items-loading').style.display = 'block';
        document.getElementById('stale-items-content').style.display = 'none';
        
        let allItems = [];
        let offset = 0;
        const limit = 100; // API max limit for stale items
        const maxItems = 2000; // Reasonable limit - load first 2000 stale items
        let hasMore = true;
        
        while (hasMore && allItems.length < maxItems) {
            const response = await fetch(`/api/inventory/stale_items_simple?limit=${limit}&offset=${offset}`);
            const data = await response.json();
            
            if (response.ok && data.items) {
                allItems = allItems.concat(data.items);
                hasMore = data.pagination.has_more;
                offset += limit;
                
                // Show progress - but limit to avoid spam
                if (allItems.length % 1000 === 0 || !hasMore) {
                    console.log(`Loaded ${allItems.length} stale items so far...`);
                }
            } else {
                hasMore = false;
                console.error('Failed to load stale items:', data.error);
            }
        }
        
        console.log(`Loaded ${allItems.length} total stale items`);
        allStaleItems = allItems;
        
    } catch (error) {
        console.error('Error loading all stale items:', error);
        allStaleItems = [];
    } finally {
        // Hide loading state
        document.getElementById('stale-items-loading').style.display = 'none';
        document.getElementById('stale-items-content').style.display = 'block';
    }
}

// Health Alerts filtering and pagination
// Store current filtered alerts globally for pagination
let currentFilteredAlerts = [];

function filterHealthAlerts() {
    const categoryFilter = document.getElementById('alert-category-filter').value;
    const severityFilter = document.getElementById('alert-severity-filter').value;
    const typeFilter = document.getElementById('alert-type-filter').value;
    
    currentFilteredAlerts = allHealthAlerts.filter(alert => {
        if (categoryFilter && alert.category !== categoryFilter) return false;
        if (severityFilter && alert.severity !== severityFilter) return false;
        if (typeFilter && alert.alert_type !== typeFilter) return false;
        return true;
    });
    
    currentAlertsPage = 1; // Reset to first page
    displayHealthAlerts(currentFilteredAlerts);
}

function displayHealthAlerts(alerts) {
    // Ensure alerts is an array
    if (!Array.isArray(alerts)) {
        console.error('displayHealthAlerts: alerts is not an array:', alerts);
        alerts = [];
    }
    
    const perPage = parseInt(document.getElementById('alerts-per-page').value) || 25;
    const totalPages = Math.ceil(alerts.length / perPage);
    const startIndex = (currentAlertsPage - 1) * perPage;
    const endIndex = startIndex + perPage;
    const pageAlerts = alerts.slice(startIndex, endIndex);
    
    // Update count
    document.getElementById('alerts-count').textContent = 
        `Showing ${startIndex + 1}-${Math.min(endIndex, alerts.length)} of ${alerts.length} alerts`;
    
    // Display alerts
    let html = '';
    if (pageAlerts.length > 0) {
        pageAlerts.forEach(alert => {
            const severityColor = {
                'critical': 'danger',
                'high': 'warning',
                'medium': 'info',
                'low': 'secondary'
            }[alert.severity] || 'secondary';
            
            html += `
                <div class="alert alert-${severityColor} d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <strong>${alert.common_name || alert.category || 'Unknown Item'}</strong>
                        ${alert.tag_id ? ` (${alert.tag_id})` : ''}
                        <div class="small text-muted">${alert.category || 'No Category'} > ${alert.subcategory || 'No Subcategory'}</div>
                        <div class="mt-1">
                            <small>${alert.suggested_action || 'No action suggested'}</small>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">Created: ${new Date(alert.created_at).toLocaleDateString()}</small>
                        </div>
                    </div>
                    <div class="d-flex flex-column align-items-end">
                        <span class="badge bg-${severityColor} mb-2">${alert.severity?.toUpperCase()}</span>
                        ${alert.tag_id ? `
                            <button class="btn btn-outline-primary btn-sm" onclick="navigateToItem('${alert.tag_id}')" 
                                    title="View item details on Open Contracts tab">
                                <i class="fas fa-external-link-alt"></i> View Item
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        });
    } else {
        html = '<div class="alert alert-info">No alerts match the current filters.</div>';
    }
    
    document.getElementById('alerts-list').innerHTML = html;
    
    // Update pagination
    console.log(`Health alerts pagination: page ${currentAlertsPage} of ${totalPages}, showing ${pageAlerts.length} alerts`);
    updatePagination('alerts-pagination', currentAlertsPage, totalPages, (page) => {
        console.log(`Health alerts pagination clicked: page ${page}`);
        currentAlertsPage = page;
        displayHealthAlerts(currentFilteredAlerts); // Display same filtered data, different page
    });
}

function updateAlertsPagination() {
    filterHealthAlerts(); // Refresh display with new page size
}

// Stale Items filtering and pagination  
function filterStaleItems() {
    const categoryFilter = document.getElementById('stale-category-filter').value;
    const subcategoryFilter = document.getElementById('stale-subcategory-filter').value;
    const daysFilter = parseInt(document.getElementById('stale-days-filter').value);
    
    let filteredItems = allStaleItems.filter(item => {
        if (categoryFilter && item.category !== categoryFilter) return false;
        if (subcategoryFilter && item.subcategory !== subcategoryFilter) return false;
        if (daysFilter && item.days_since_scan < daysFilter) return false;
        return true;
    });
    
    // Update subcategory options based on selected category
    if (categoryFilter) {
        const subcategories = [...new Set(allStaleItems
            .filter(item => item.category === categoryFilter)
            .map(item => item.subcategory)
            .filter(Boolean))];
        
        const subcategorySelect = document.getElementById('stale-subcategory-filter');
        subcategorySelect.innerHTML = '<option value="">All Subcategories</option>';
        subcategories.forEach(sub => {
            subcategorySelect.innerHTML += `<option value="${sub}"${subcategory === subcategoryFilter ? ' selected' : ''}>${sub}</option>`;
        });
    }
    
    currentStaleItemsPage = 1; // Reset to first page
    displayStaleItems(filteredItems);
}

function displayStaleItems(items) {
    const perPage = parseInt(document.getElementById('stale-items-per-page').value) || 25;
    const totalPages = Math.ceil(items.length / perPage);
    const startIndex = (currentStaleItemsPage - 1) * perPage;
    const endIndex = startIndex + perPage;
    const pageItems = items.slice(startIndex, endIndex);
    
    // Update count
    document.getElementById('stale-items-count').innerHTML = `
        <div>Showing ${startIndex + 1}-${Math.min(endIndex, items.length)} of ${items.length} stale items</div>
    `;
    
    // Display items with enhanced activity information
    let html = '';
    if (pageItems.length > 0) {
        pageItems.forEach(item => {
            // Simplified display for debugging
            const daysStale = item.days_since_scan || 0;
            
            let daysBadgeColor = 'danger';
            if (daysStale <= 7) {
                daysBadgeColor = 'warning';
            } else if (daysStale <= 14) {
                daysBadgeColor = 'danger'; 
            } else {
                daysBadgeColor = 'dark';
            }
                                  
            html += `
                <div class="col-md-6 mb-3">
                    <div class="stale-item border rounded p-3">
                        <div class="d-flex justify-content-between">
                            <div class="flex-grow-1">
                                <strong>${item.common_name || 'Unknown Item'}</strong>
                                <div class="text-muted small">
                                    ${item.category || 'No Category'} > ${item.subcategory || 'No Subcategory'}
                                </div>
                                <div class="text-muted small">
                                    Tag: ${item.tag_id} • Location: ${item.bin_location || 'Unknown'}
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-${daysBadgeColor}">${daysStale} days</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    } else {
        html = '<div class="col-12"><div class="alert alert-info">No stale items match the current filters.</div></div>';
    }
    
    document.getElementById('stale-items-list').innerHTML = `<div class="row">${html}</div>`;
    
    // Update pagination
    updatePagination('stale-items-pagination', currentStaleItemsPage, totalPages, (page) => {
        currentStaleItemsPage = page;
        displayStaleItems(items);
    });
}

function updateStaleItemsPagination() {
    filterStaleItems(); // Refresh display with new page size
}

// Generic pagination component
function updatePagination(containerId, currentPage, totalPages, onPageChange) {
    console.log(`updatePagination called: ${containerId}, page ${currentPage} of ${totalPages}`);
    const container = document.getElementById(containerId);
    if (!container) {
        console.error(`Pagination container not found: ${containerId}`);
        return;
    }
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '<nav><ul class="pagination pagination-sm">';
    
    // Previous button
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
    </li>`;
    
    // Page numbers (show max 5 pages around current)
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);
    
    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>`;
        if (startPage > 2) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    for (let page = startPage; page <= endPage; page++) {
        html += `<li class="page-item ${page === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" data-page="${page}">${page}</a>
        </li>`;
    }
    
    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
        html += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
    }
    
    // Next button
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
    </li>`;
    
    html += '</ul></nav>';
    container.innerHTML = html;
    
    // Add event listeners to pagination links
    container.querySelectorAll('a.page-link[data-page]').forEach(link => {
        link.addEventListener('click', (event) => {
            event.preventDefault();
            const page = parseInt(link.getAttribute('data-page'));
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                onPageChange(page);
            }
        });
    });
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    window.inventoryAnalytics = new InventoryAnalytics();
    
    // Initialize tabs with fallback for MDB
    function initializeTabs() {
        const triggerTabList = [].slice.call(document.querySelectorAll('#analyticsTab button[data-mdb-toggle="tab"]'));
        
        triggerTabList.forEach(function (triggerEl) {
            triggerEl.addEventListener('click', function (event) {
                event.preventDefault();
                
                // Remove active class from all tabs and content
                document.querySelectorAll('#analyticsTab .nav-link').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('#analyticsTabContent .tab-pane').forEach(pane => {
                    pane.classList.remove('show', 'active');
                });
                
                // Add active class to clicked tab
                triggerEl.classList.add('active');
                
                // Show corresponding content
                const targetId = triggerEl.getAttribute('data-mdb-target');
                if (targetId) {
                    const targetPane = document.querySelector(targetId);
                    if (targetPane) {
                        targetPane.classList.add('show', 'active');
                    }
                }
            });
        });
    }
    
    // Initialize tabs immediately
    initializeTabs();
    
    // Load configuration when configuration tab is clicked
    document.getElementById('configuration-tab').addEventListener('click', function() {
        loadConfiguration();
    });
    
    // Load stale items when stale items tab is clicked  
    document.getElementById('stale-items-tab').addEventListener('click', function() {
        if (window.inventoryAnalytics) {
            window.inventoryAnalytics.loadStaleItems();
        }
    });
    
    // Load usage analysis when usage analysis tab is clicked
    document.getElementById('usage-analysis-tab').addEventListener('click', function() {
        loadUsagePatterns();
        loadDataDiscrepancies();
    });
});

// Navigate to specific item on Tab 2 (Open Contracts)
function navigateToItem(tagId) {
    try {
        // Switch to Tab 2 (Open Contracts)
        const tab2Link = document.querySelector('a[data-bs-target="#tab2"]');
        if (tab2Link) {
            // Trigger tab switch
            tab2Link.click();
            
            // Wait for tab to load, then search for the item
            setTimeout(() => {
                // Try to find and scroll to the item in Tab 2
                const itemElements = document.querySelectorAll('#tab2 [data-tag-id], #tab2 .contract-item, #tab2 .item-row');
                let foundItem = null;
                
                // Search through various possible selectors
                itemElements.forEach(element => {
                    const elementText = element.textContent || element.innerHTML || '';
                    if (elementText.includes(tagId)) {
                        foundItem = element;
                    }
                });
                
                if (foundItem) {
                    // Scroll to the item and highlight it
                    foundItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    foundItem.style.backgroundColor = '#fff3cd';
                    foundItem.style.border = '2px solid #ffc107';
                    
                    // Remove highlighting after 3 seconds
                    setTimeout(() => {
                        foundItem.style.backgroundColor = '';
                        foundItem.style.border = '';
                    }, 3000);
                } else {
                    // If not found, show search hint
                    alert(`Switched to Open Contracts tab. Please search for item: ${tagId}`);
                }
            }, 500);
        } else {
            console.error('Could not find Tab 2 link');
            alert('Could not navigate to Open Contracts tab');
        }
    } catch (error) {
        console.error('Error navigating to item:', error);
        alert(`Error navigating to item ${tagId}`);
    }
}
</script>
{% endblock %}
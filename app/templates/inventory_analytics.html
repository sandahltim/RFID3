{% extends "base.html" %}
{% block title %}Inventory & Analytics{% endblock %}
{% block extra_head %}
<style>
    .dashboard-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        color: white;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .metric-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #2c3e50;
    }
    
    .metric-label {
        font-size: 0.9rem;
        color: #7f8c8d;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .health-score {
        font-size: 3rem;
        font-weight: bold;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .alert-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 0.25rem;
        text-transform: uppercase;
    }
    
    .alert-critical { background-color: #dc3545; color: white; }
    .alert-high { background-color: #fd7e14; color: white; }
    .alert-medium { background-color: #ffc107; color: black; }
    .alert-low { background-color: #28a745; color: white; }
    
    .stale-item {
        padding: 10px;
        border-left: 4px solid #e74c3c;
        background-color: #fdf2f2;
        margin-bottom: 8px;
        border-radius: 4px;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .tab-content {
        margin-top: 20px;
    }
    
    .nav-tabs .nav-link.active {
        background-color: #667eea;
        color: white;
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card text-center">
                <h1><i class="fas fa-chart-line"></i> Inventory & Analytics Dashboard</h1>
                <p class="mb-0">Real-time inventory health monitoring and usage analysis</p>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="health-score" id="health-score">--</div>
                        <div>Overall Health Score</div>
                    </div>
                    <div class="col-md-4">
                        <div class="health-score" id="total-items">--</div>
                        <div>Total Items</div>
                    </div>
                    <div class="col-md-4">
                        <div class="health-score" id="active-alerts">--</div>
                        <div>Active Alerts</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Key Metrics Row -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value text-success" id="items-on-rent">--</div>
                <div class="metric-label">On Rent</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value text-primary" id="items-available">--</div>
                <div class="metric-label">Available</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value text-warning" id="items-in-service">--</div>
                <div class="metric-label">In Service</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="metric-card text-center">
                <div class="metric-value text-info" id="utilization-rate">--%</div>
                <div class="metric-label">Utilization Rate</div>
            </div>
        </div>
    </div>
    
    <!-- Tabs for Different Views -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="analyticsTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="alerts-tab" data-bs-toggle="tab" data-bs-target="#alerts" type="button" role="tab">
                        <i class="fas fa-exclamation-triangle"></i> Health Alerts
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stale-items-tab" data-bs-toggle="tab" data-bs-target="#stale-items" type="button" role="tab">
                        <i class="fas fa-clock"></i> Stale Items
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="usage-analysis-tab" data-bs-toggle="tab" data-bs-target="#usage-analysis" type="button" role="tab">
                        <i class="fas fa-chart-bar"></i> Usage Analysis
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="resale-tracking-tab" data-bs-toggle="tab" data-bs-target="#resale-tracking" type="button" role="tab">
                        <i class="fas fa-shopping-cart"></i> Resale Tracking
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="configuration-tab" data-bs-toggle="tab" data-bs-target="#configuration" type="button" role="tab">
                        <i class="fas fa-cog"></i> Configuration
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="analyticsTabContent">
                <!-- Health Alerts Tab -->
                <div class="tab-pane fade show active" id="alerts" role="tabpanel">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-bell"></i> Active Health Alerts</h5>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary btn-sm" id="generate-alerts-btn" onclick="generateAlerts()" 
                                                title="Scans stale items and creates health alerts based on current configuration thresholds. This creates alert records in the database for proactive inventory management.">
                                            <i class="fas fa-sync"></i> Generate Alerts
                                        </button>
                                        <select class="form-select form-select-sm" id="alert-severity-filter">
                                            <option value="">All Severities</option>
                                            <option value="critical">Critical</option>
                                            <option value="high">High</option>
                                            <option value="medium">Medium</option>
                                            <option value="low">Low</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="alerts-loading" class="text-center">
                                        <div class="loading-spinner"></div> Loading alerts...
                                    </div>
                                    <div id="alerts-list" style="display: none;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie"></i> Alert Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <span class="alert-badge alert-critical" id="critical-count">0</span> Critical
                                    </div>
                                    <div class="mb-2">
                                        <span class="alert-badge alert-high" id="high-count">0</span> High
                                    </div>
                                    <div class="mb-2">
                                        <span class="alert-badge alert-medium" id="medium-count">0</span> Medium
                                    </div>
                                    <div class="mb-2">
                                        <span class="alert-badge alert-low" id="low-count">0</span> Low
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stale Items Tab -->
                <div class="tab-pane fade" id="stale-items" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-clock"></i> Items Not Recently Scanned</h5>
                            <small class="text-muted">Items that haven't been scanned recently based on category-specific thresholds</small>
                        </div>
                        <div class="card-body">
                            <div id="stale-items-loading" class="text-center">
                                <div class="loading-spinner"></div> Analyzing scan history...
                            </div>
                            <div id="stale-items-list" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Usage Analysis Tab -->
                <div class="tab-pane fade" id="usage-analysis" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-line"></i> Usage Patterns</h5>
                                </div>
                                <div class="card-body">
                                    <div id="usage-patterns-loading" class="text-center">
                                        <div class="loading-spinner"></div> Loading usage patterns...
                                    </div>
                                    <div id="usage-patterns-content" style="display: none;">
                                        <div id="usage-patterns-list"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header">
                                    <h5><i class="fas fa-exclamation-circle"></i> Data Discrepancies</h5>
                                </div>
                                <div class="card-body">
                                    <div id="discrepancies-loading" class="text-center">
                                        <div class="loading-spinner"></div> Analyzing data discrepancies...
                                    </div>
                                    <div id="discrepancies-content" style="display: none;">
                                        <div id="discrepancies-summary"></div>
                                        <div id="discrepancies-list" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5><i class="fas fa-database"></i> Database Health Summary</h5>
                                    <button class="btn btn-primary btn-sm" onclick="refreshAnalysisData()">
                                        <i class="fas fa-refresh"></i> Refresh Analysis
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-md-3">
                                            <div class="metric-card">
                                                <div class="metric-value text-info" id="total-master-items">--</div>
                                                <div class="metric-label">Items in Master</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="metric-card">
                                                <div class="metric-value text-success" id="items-with-transactions">--</div>
                                                <div class="metric-label">Items with Transactions</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="metric-card">
                                                <div class="metric-value text-warning" id="orphaned-transactions">--</div>
                                                <div class="metric-label">Orphaned Transactions</div>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="metric-card">
                                                <div class="metric-value text-danger" id="data-sync-issues">--</div>
                                                <div class="metric-label">Data Sync Issues</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Resale Tracking Tab -->
                <div class="tab-pane fade" id="resale-tracking" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-shopping-cart"></i> Resale & Pack Status Tracking</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">Specialized tracking for resale items and pack status management coming in Phase 2...</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Resale Item Features:</h6>
                                    <ul>
                                        <li>Automatic restock alerts (7-day threshold)</li>
                                        <li>Consumption rate tracking</li>
                                        <li>Low inventory warnings</li>
                                        <li>Supplier order suggestions</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <h6>Pack Status Management:</h6>
                                    <ul>
                                        <li>Pack/unpack recommendations based on demand</li>
                                        <li>Storage optimization alerts</li>
                                        <li>Bulk item tracking</li>
                                        <li>Space utilization analysis</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Configuration Tab -->
                <div class="tab-pane fade" id="configuration" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-cog"></i> Inventory Analytics Configuration</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-bell"></i> Alert Thresholds</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Stale Item Days (Default Categories)</label>
                                        <input type="number" class="form-control config-input" id="stale-default" value="30" min="1" max="365">
                                        <small class="form-text text-muted">Days without scan before item is flagged as stale</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Stale Item Days (Resale Categories)</label>
                                        <input type="number" class="form-control config-input" id="stale-resale" value="7" min="1" max="90">
                                        <small class="form-text text-muted">Shorter threshold for resale items</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Stale Item Days (Pack Location)</label>
                                        <input type="number" class="form-control config-input" id="stale-pack" value="14" min="1" max="180">
                                        <small class="form-text text-muted">Threshold for items in pack locations</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-chart-line"></i> Usage Thresholds</h6>
                                    <div class="mb-3">
                                        <label class="form-label">High Usage Threshold</label>
                                        <input type="number" class="form-control config-input" id="high-usage" value="0.8" min="0.1" max="1.0" step="0.1">
                                        <small class="form-text text-muted">Utilization rate above this triggers high usage alerts</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Low Usage Threshold</label>
                                        <input type="number" class="form-control config-input" id="low-usage" value="0.2" min="0.0" max="0.9" step="0.1">
                                        <small class="form-text text-muted">Utilization rate below this triggers low usage alerts</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Quality Decline Threshold</label>
                                        <input type="number" class="form-control config-input" id="quality-decline" value="2" min="1" max="5">
                                        <small class="form-text text-muted">Grade drops triggering quality decline alerts</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6><i class="fas fa-save"></i> Configuration Management</h6>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success" id="save-config-btn" onclick="saveConfiguration()">
                                            <i class="fas fa-save"></i> Save Configuration
                                        </button>
                                        <button class="btn btn-secondary" id="reset-config-btn" onclick="resetConfiguration()">
                                            <i class="fas fa-undo"></i> Reset to Defaults
                                        </button>
                                        <button class="btn btn-info" id="load-config-btn" onclick="loadConfiguration()">
                                            <i class="fas fa-refresh"></i> Reload Current
                                        </button>
                                    </div>
                                    <div class="mt-2">
                                        <div class="alert alert-info" id="config-status" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class InventoryAnalytics {
    constructor() {
        this.refreshInterval = null;
        this.init();
    }
    
    init() {
        console.log('Initializing Inventory Analytics dashboard');
        this.loadDashboardData();
        this.setupEventHandlers();
        this.startAutoRefresh();
    }
    
    async loadDashboardData() {
        try {
            console.log('Loading dashboard summary data');
            const response = await fetch('/api/inventory/dashboard_summary');
            const data = await response.json();
            
            if (response.ok) {
                this.updateDashboardMetrics(data);
            } else {
                console.error('Failed to load dashboard data:', data.error);
                this.showError('Failed to load dashboard data');
            }
        } catch (error) {
            console.error('Error loading dashboard data:', error);
            this.showError('Error loading dashboard data');
        }
    }
    
    updateDashboardMetrics(data) {
        const inventory = data.inventory_overview;
        const health = data.health_metrics;
        
        // Update main dashboard cards
        document.getElementById('health-score').textContent = health.health_score;
        document.getElementById('total-items').textContent = inventory.total_items.toLocaleString();
        document.getElementById('active-alerts').textContent = health.active_alerts;
        
        // Update metric cards
        document.getElementById('items-on-rent').textContent = inventory.items_on_rent.toLocaleString();
        document.getElementById('items-available').textContent = inventory.items_available.toLocaleString();
        document.getElementById('items-in-service').textContent = inventory.items_in_service.toLocaleString();
        document.getElementById('utilization-rate').textContent = inventory.utilization_rate + '%';
        
        // Update alert counts
        document.getElementById('critical-count').textContent = health.critical_alerts;
        document.getElementById('high-count').textContent = health.high_alerts;
        document.getElementById('medium-count').textContent = health.medium_alerts;
        document.getElementById('low-count').textContent = health.low_alerts;
        
        // Apply health score color coding
        const healthScoreEl = document.getElementById('health-score');
        if (health.health_score >= 90) {
            healthScoreEl.style.color = '#28a745'; // Green
        } else if (health.health_score >= 70) {
            healthScoreEl.style.color = '#ffc107'; // Yellow
        } else {
            healthScoreEl.style.color = '#dc3545'; // Red
        }
        
        console.log('Dashboard metrics updated successfully');
    }
    
    async loadHealthAlerts() {
        try {
            document.getElementById('alerts-loading').style.display = 'block';
            document.getElementById('alerts-list').style.display = 'none';
            
            const severityFilter = document.getElementById('alert-severity-filter').value;
            const queryParams = new URLSearchParams();
            if (severityFilter) queryParams.append('severity', severityFilter);
            
            const response = await fetch(`/api/inventory/alerts?${queryParams}`);
            const data = await response.json();
            
            if (response.ok) {
                this.displayHealthAlerts(data.alerts);
            } else {
                console.error('Failed to load alerts:', data.error);
                this.showError('Failed to load alerts', 'alerts-list');
            }
        } catch (error) {
            console.error('Error loading health alerts:', error);
            this.showError('Error loading health alerts', 'alerts-list');
        } finally {
            document.getElementById('alerts-loading').style.display = 'none';
            document.getElementById('alerts-list').style.display = 'block';
        }
    }
    
    displayHealthAlerts(alerts) {
        const container = document.getElementById('alerts-list');
        
        if (alerts.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No active alerts found.</p>';
            return;
        }
        
        let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr>';
        html += '<th>Severity</th><th>Type</th><th>Item/Category</th><th>Description</th><th>Created</th></tr></thead><tbody>';
        
        alerts.forEach(alert => {
            const severityBadge = `<span class="alert-badge alert-${alert.severity}">${alert.severity}</span>`;
            const itemInfo = alert.tag_id ? 
                `${alert.common_name} (${alert.tag_id})` : 
                `${alert.category}/${alert.subcategory}`;
            const createdDate = new Date(alert.created_at).toLocaleDateString();
            
            html += `<tr>
                <td>${severityBadge}</td>
                <td>${alert.alert_type.replace('_', ' ')}</td>
                <td>${itemInfo}</td>
                <td>${alert.suggested_action || 'Review required'}</td>
                <td>${createdDate}</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }
    
    async loadStaleItems() {
        try {
            document.getElementById('stale-items-loading').style.display = 'block';
            document.getElementById('stale-items-list').style.display = 'none';
            
            const response = await fetch('/api/inventory/stale_items');
            const data = await response.json();
            
            if (response.ok) {
                this.displayStaleItems(data.stale_items, data.thresholds_used);
            } else {
                console.error('Failed to load stale items:', data.error);
                this.showError('Failed to load stale items', 'stale-items-list');
            }
        } catch (error) {
            console.error('Error loading stale items:', error);
            this.showError('Error loading stale items', 'stale-items-list');
        } finally {
            document.getElementById('stale-items-loading').style.display = 'none';
            document.getElementById('stale-items-list').style.display = 'block';
        }
    }
    
    displayStaleItems(items, thresholds) {
        const container = document.getElementById('stale-items-list');
        
        if (items.length === 0) {
            container.innerHTML = '<p class="text-success text-center"><i class="fas fa-check-circle"></i> All items are within scan thresholds!</p>';
            return;
        }
        
        let html = `<div class="alert alert-info"><strong>Scan Thresholds:</strong> Default: ${thresholds.default} days, Resale: ${thresholds.resale} days, Pack: ${thresholds.pack} days</div>`;
        html += '<div class="row">';
        
        items.forEach(item => {
            const lastScanDate = new Date(item.last_scan_date).toLocaleDateString();
            const categoryInfo = item.category ? `${item.category}/${item.subcategory}` : 'Uncategorized';
            
            const transactionCount = item.transaction_count || 0;
            const hasTransactions = transactionCount > 0;
            
            html += `<div class="col-md-6 mb-3">
                <div class="stale-item">
                    <div class="d-flex justify-content-between">
                        <strong>${item.common_name}</strong>
                        <div>
                            <span class="badge bg-danger">${item.days_since_scan} days</span>
                            ${hasTransactions ? `<span class="badge bg-info ms-1">${transactionCount} transactions</span>` : '<span class="badge bg-warning ms-1">No transactions</span>'}
                        </div>
                    </div>
                    <div class="small text-muted">
                        <div>Tag: ${item.tag_id} | Status: ${item.status}</div>
                        <div>Category: ${categoryInfo} | Location: ${item.bin_location || 'N/A'}</div>
                        <div>Last Scan: ${lastScanDate} | Contract: ${item.last_contract || 'N/A'}</div>
                        <div>Data Source: ${item.data_source || 'master'} | Quality: ${item.quality || 'N/A'}</div>
                    </div>
                </div>
            </div>`;
        });
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    setupEventHandlers() {
        // Tab change handlers
        document.addEventListener('shown.bs.tab', (event) => {
            const targetTab = event.target.getAttribute('data-bs-target');
            console.log('Tab changed to:', targetTab);
            
            if (targetTab === '#alerts') {
                this.loadHealthAlerts();
            } else if (targetTab === '#stale-items') {
                this.loadStaleItems();
            }
        });
        
        // Alternative tab click handler for better compatibility
        document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('click', (event) => {
                const targetTab = event.target.getAttribute('data-bs-target');
                console.log('Tab clicked:', targetTab);
                
                // Small delay to ensure tab is shown
                setTimeout(() => {
                    if (targetTab === '#alerts') {
                        this.loadHealthAlerts();
                    } else if (targetTab === '#stale-items') {
                        this.loadStaleItems();
                    }
                }, 100);
            });
        });
        
        // Alert filter change
        document.getElementById('alert-severity-filter').addEventListener('change', () => {
            this.loadHealthAlerts();
        });
        
        // Load initial tab content
        this.loadHealthAlerts();
    }
    
    async generateAlerts() {
        try {
            const button = document.getElementById('generate-alerts-btn');
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="loading-spinner"></div> Generating...';
            button.disabled = true;
            
            const response = await fetch('/api/inventory/generate_alerts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            });
            const data = await response.json();
            
            if (response.ok) {
                console.log('Alerts generated successfully:', data);
                // Refresh the dashboard and alerts
                this.loadDashboardData();
                this.loadHealthAlerts();
                
                // Show detailed success message
                let message = `Alert Generation Complete: ${data.alerts_created} alerts created`;
                if (data.stale_items_processed) {
                    message += ` from ${data.stale_items_processed} stale items analyzed`;
                }
                if (data.existing_alerts_updated) {
                    message += `, ${data.existing_alerts_updated} existing alerts updated`;
                }
                this.showSuccess(message);
            } else {
                console.error('Failed to generate alerts:', data.error);
                this.showError('Failed to generate alerts: ' + (data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error generating alerts:', error);
            this.showError('Error generating alerts');
        } finally {
            const button = document.getElementById('generate-alerts-btn');
            button.innerHTML = '<i class="fas fa-sync"></i> Generate Alerts';
            button.disabled = false;
        }
    }
    
    startAutoRefresh() {
        // Refresh dashboard data every 5 minutes
        this.refreshInterval = setInterval(() => {
            console.log('Auto-refreshing dashboard data');
            this.loadDashboardData();
        }, 5 * 60 * 1000);
    }
    
    showError(message, containerId = null) {
        const errorHtml = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
        
        if (containerId) {
            document.getElementById(containerId).innerHTML = errorHtml;
        } else {
            // Show in a toast or modal
            console.error(message);
        }
    }
    
    showSuccess(message) {
        // Create a temporary success message
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
        successDiv.style.top = '20px';
        successDiv.style.right = '20px';
        successDiv.style.zIndex = '9999';
        successDiv.innerHTML = `
            <i class="fas fa-check-circle"></i> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(successDiv);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.parentNode.removeChild(successDiv);
            }
        }, 5000);
    }
}

// Make generateAlerts globally available
function generateAlerts() {
    if (window.inventoryAnalytics) {
        window.inventoryAnalytics.generateAlerts();
    }
}

// Configuration management functions
async function loadConfiguration() {
    try {
        const response = await fetch('/api/inventory/configuration');
        if (response.ok) {
            const config = await response.json();
            
            // Load alert thresholds
            const alertThresholds = config.alert_thresholds || {};
            document.getElementById('stale-default').value = alertThresholds.stale_item_days?.default || 30;
            document.getElementById('stale-resale').value = alertThresholds.stale_item_days?.resale || 7;
            document.getElementById('stale-pack').value = alertThresholds.stale_item_days?.pack || 14;
            document.getElementById('high-usage').value = alertThresholds.high_usage_threshold || 0.8;
            document.getElementById('low-usage').value = alertThresholds.low_usage_threshold || 0.2;
            document.getElementById('quality-decline').value = alertThresholds.quality_decline_threshold || 2;
            
            showConfigStatus('Configuration loaded successfully', 'success');
        } else {
            showConfigStatus('Failed to load configuration', 'error');
        }
    } catch (error) {
        console.error('Error loading configuration:', error);
        showConfigStatus('Error loading configuration', 'error');
    }
}

async function saveConfiguration() {
    try {
        const config = {
            alert_thresholds: {
                stale_item_days: {
                    default: parseInt(document.getElementById('stale-default').value),
                    resale: parseInt(document.getElementById('stale-resale').value),
                    pack: parseInt(document.getElementById('stale-pack').value)
                },
                high_usage_threshold: parseFloat(document.getElementById('high-usage').value),
                low_usage_threshold: parseFloat(document.getElementById('low-usage').value),
                quality_decline_threshold: parseInt(document.getElementById('quality-decline').value)
            }
        };
        
        const response = await fetch('/api/inventory/configuration', {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        
        if (response.ok) {
            showConfigStatus('Configuration saved successfully', 'success');
        } else {
            const error = await response.json();
            showConfigStatus('Failed to save: ' + (error.message || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error('Error saving configuration:', error);
        showConfigStatus('Error saving configuration', 'error');
    }
}

function resetConfiguration() {
    // Reset to default values
    document.getElementById('stale-default').value = 30;
    document.getElementById('stale-resale').value = 7;
    document.getElementById('stale-pack').value = 14;
    document.getElementById('high-usage').value = 0.8;
    document.getElementById('low-usage').value = 0.2;
    document.getElementById('quality-decline').value = 2;
    showConfigStatus('Configuration reset to defaults', 'info');
}

function showConfigStatus(message, type) {
    const statusDiv = document.getElementById('config-status');
    statusDiv.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'}`;
    statusDiv.textContent = message;
    statusDiv.style.display = 'block';
    
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 3000);
}

// Usage Analysis functions
async function loadUsagePatterns() {
    try {
        document.getElementById('usage-patterns-loading').style.display = 'block';
        document.getElementById('usage-patterns-content').style.display = 'none';
        
        const response = await fetch('/api/inventory/usage_patterns');
        const data = await response.json();
        
        if (response.ok) {
            displayUsagePatterns(data.patterns);
        } else {
            document.getElementById('usage-patterns-list').innerHTML = 
                `<div class="alert alert-danger">Error loading patterns: ${data.error}</div>`;
        }
    } catch (error) {
        console.error('Error loading usage patterns:', error);
        document.getElementById('usage-patterns-list').innerHTML = 
            '<div class="alert alert-danger">Error loading usage patterns</div>';
    } finally {
        document.getElementById('usage-patterns-loading').style.display = 'none';
        document.getElementById('usage-patterns-content').style.display = 'block';
    }
}

function displayUsagePatterns(patterns) {
    let html = '';
    if (patterns && patterns.length > 0) {
        patterns.slice(0, 10).forEach(pattern => {
            const percentage = ((pattern.usage_rate || 0) * 100).toFixed(1);
            html += `
                <div class="border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between">
                        <strong>${pattern.category || 'Unknown'}</strong>
                        <span class="badge bg-${percentage > 70 ? 'success' : percentage > 40 ? 'warning' : 'secondary'}">${percentage}%</span>
                    </div>
                    <small class="text-muted">${pattern.subcategory || ''}</small>
                    <div class="mt-1">
                        <small>${pattern.total_items || 0} items • ${pattern.rental_count || 0} rentals</small>
                    </div>
                </div>
            `;
        });
    } else {
        html = '<p class="text-muted">No usage patterns found.</p>';
    }
    document.getElementById('usage-patterns-list').innerHTML = html;
}

async function loadDataDiscrepancies() {
    try {
        document.getElementById('discrepancies-loading').style.display = 'block';
        document.getElementById('discrepancies-content').style.display = 'none';
        
        const response = await fetch('/api/inventory/data_discrepancies');
        const data = await response.json();
        
        if (response.ok) {
            displayDataDiscrepancies(data);
        } else {
            document.getElementById('discrepancies-list').innerHTML = 
                `<div class="alert alert-danger">Error loading discrepancies: ${data.error}</div>`;
        }
    } catch (error) {
        console.error('Error loading data discrepancies:', error);
        document.getElementById('discrepancies-list').innerHTML = 
            '<div class="alert alert-danger">Error loading data discrepancies</div>';
    } finally {
        document.getElementById('discrepancies-loading').style.display = 'none';
        document.getElementById('discrepancies-content').style.display = 'block';
    }
}

function displayDataDiscrepancies(data) {
    // Update summary metrics
    document.getElementById('total-master-items').textContent = data.summary?.total_master_items || '--';
    document.getElementById('items-with-transactions').textContent = data.summary?.items_with_transactions || '--';
    document.getElementById('orphaned-transactions').textContent = data.summary?.orphaned_transactions || '--';
    document.getElementById('data-sync-issues').textContent = data.summary?.data_sync_issues || '--';
    
    // Display summary
    let summaryHtml = '<div class="alert alert-info">';
    summaryHtml += `<h6>Data Quality Overview</h6>`;
    summaryHtml += `<p>Found ${data.summary?.data_sync_issues || 0} items with potential sync issues out of ${data.summary?.total_master_items || 0} total items.</p>`;
    summaryHtml += '</div>';
    document.getElementById('discrepancies-summary').innerHTML = summaryHtml;
    
    // Display discrepancy details
    let html = '';
    if (data.discrepancies && data.discrepancies.length > 0) {
        html += '<h6>Top Data Discrepancies:</h6>';
        data.discrepancies.slice(0, 5).forEach(disc => {
            html += `
                <div class="border-left-warning p-2 mb-2 bg-light">
                    <div class="d-flex justify-content-between">
                        <strong>${disc.tag_id}</strong>
                        <span class="badge bg-warning">${disc.issue_type}</span>
                    </div>
                    <small class="text-muted">${disc.common_name || 'Unknown Item'}</small>
                    <div class="mt-1">
                        <small>Master: ${disc.master_last_scan || 'None'} • Transactions: ${disc.latest_transaction || 'None'}</small>
                    </div>
                </div>
            `;
        });
    } else {
        html = '<p class="text-success"><i class="fas fa-check"></i> No significant data discrepancies found.</p>';
    }
    document.getElementById('discrepancies-list').innerHTML = html;
}

function refreshAnalysisData() {
    loadUsagePatterns();
    loadDataDiscrepancies();
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    window.inventoryAnalytics = new InventoryAnalytics();
    
    // Load configuration when configuration tab is clicked
    document.getElementById('configuration-tab').addEventListener('click', function() {
        loadConfiguration();
    });
    
    // Load usage analysis when usage analysis tab is clicked
    document.getElementById('usage-analysis-tab').addEventListener('click', function() {
        loadUsagePatterns();
        loadDataDiscrepancies();
    });
});
</script>
{% endblock %}
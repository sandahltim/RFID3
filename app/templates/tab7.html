{% extends "base.html" %}
{% block content %}

<h1>Tag Info</h1>

<form method="GET" class="mb-3 row g-2">
    <div class="col-12 col-md-2">
        <input type="text" class="form-control" name="tag_id" placeholder="Filter EPC" value="{{ filter_tag_id }}" />
    </div>
    <div class="col-12 col-md-2">
        <input type="text" class="form-control" name="common_name" placeholder="Filter Common Name" value="{{ filter_common_name }}" />
    </div>
    <div class="col-12 col-md-2">
        <select class="form-control" name="category">
            <option value="">All Categories</option>
            {% for category in parent_data | map(attribute='category') | sort %}
            <option value="{{ category }}" {% if filter_category == category %}selected{% endif %}>{{ category }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-12 col-md-2">
        <select class="form-control" name="status">
            <option value="">All Statuses</option>
            <option value="active" {% if filter_status == 'active' %}selected{% endif %}>Active</option>
            <option value="out/used" {% if filter_status == 'out/used' %}selected{% endif %}>Out/Used</option>
            <option value="sold" {% if filter_status == 'sold' %}selected{% endif %}>Sold</option>
            <option value="discarded" {% if filter_status == 'discarded' %}selected{% endif %}>Discarded</option>
        </select>
    </div>
    <div class="col-12 col-md-2">
        <button type="submit" class="btn btn-primary">Apply Filters</button>
    </div>
</form>

<div class="mb-3">
    <a href="/tab7/print_tags" target="_blank" class="btn btn-primary">Print Tags for Reprogramming</a>
</div>

<div class="table-container">
    <table class="table table-striped table-bordered" id="tagTable">
        <thead>
            <tr>
                <th style="width: 50px;"></th>
                <th class="sortable" data-col-name="category">Category</th>
                <th class="sortable" data-col-name="total">Total Tags</th>
                <th class="sortable" data-col-name="out_used">Out/Used</th>
                <th class="sortable" data-col-name="active">Active</th>
            </tr>
        </thead>
        <tbody id="tagTableBody">
            {% for parent in parent_data %}
            {% set cat_key = parent.category|lower|replace('/[^a-z0-9]/gi', '_') %}
            <tr class="table-active">
                <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#child-{{ cat_key }}">+</span></td>
                <td>{{ parent.category }}</td>
                <td>{{ parent.total }}</td>
                <td>{{ parent.out_used }}</td>
                <td>{{ parent.active }}</td>
            </tr>
            <tr>
                <td colspan="5" class="p-0">
                    <div id="child-{{ cat_key }}" class="collapse" data-category="{{ parent.category }}">
                        <table class="table mb-0 child-table" id="childTable-{{ cat_key }}">
                            <thead>
                                <tr>
                                    <th class="sortable" data-col-name="tag_id">EPC</th>
                                    <th class="sortable" data-col-name="common_name">Common Name</th>
                                    <th class="sortable" data-col-name="status">Status</th>
                                    <th class="sortable" data-col-name="item_type">Item Type</th>
                                    <th class="sortable" data-col-name="last_contract_num">Last Contract</th>
                                    <th class="sortable" data-col-name="reuse_count">Reuse Count</th>
                                </tr>
                            </thead>
                            <tbody id="childTbody-{{ cat_key }}">
                                {% for tag in tags if tag.category == parent.category %}
                                <tr>
                                    <td>{{ tag.tag_id }}</td>
                                    <td>{{ tag.common_name }}</td>
                                    <td>{{ tag.status }}</td>
                                    <td>{{ tag.item_type }}</td>
                                    <td>{{ tag.last_contract_num or 'N/A' }}</td>
                                    <td>{{ tag.reuse_count }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function sortTable(tableEl, colName) {
    let tbody = tableEl.querySelector("tbody");
    if (!tbody) return;

    let asc = tableEl.getAttribute("data-sort-col") === colName 
              ? tableEl.getAttribute("data-sort-dir") !== "asc" 
              : true;
    tableEl.setAttribute("data-sort-col", colName);
    tableEl.setAttribute("data-sort-dir", asc ? "asc" : "desc");

    let headers = Array.from(tableEl.querySelectorAll("th"));
    let colIndex = headers.findIndex(th => th.getAttribute("data-col-name") === colName);

    if (tableEl.id === "tagTable") {
        let rows = Array.from(tbody.children);
        let pairs = [];
        for (let i = 0; i < rows.length; i += 2) {
            let parentRow = rows[i];
            let childRow = rows[i + 1] || null;
            if (parentRow && parentRow.classList.contains("table-active")) {
                pairs.push({ parent: parentRow, child: childRow });
            }
        }
        pairs.sort((a, b) => {
            let cellA = a.parent.cells[colIndex]?.innerText.trim() || "";
            let cellB = b.parent.cells[colIndex]?.innerText.trim() || "";
            let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
            let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
            if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
            return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
        });
        tbody.innerHTML = "";
        pairs.forEach(pair => {
            tbody.appendChild(pair.parent);
            if (pair.child) tbody.appendChild(pair.child);
        });
    } else {
        let rows = Array.from(tbody.querySelectorAll("tr"));
        rows.sort((a, b) => {
            let cellA = a.cells[colIndex]?.innerText.trim() || "";
            let cellB = b.cells[colIndex]?.innerText.trim() || "";
            let numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
            let numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
            if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
            return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
        });
        tbody.innerHTML = "";
        rows.forEach(row => tbody.appendChild(row));
    }
}

function refreshTable() {
    console.log("Refreshing Tab 7 at " + new Date().toLocaleTimeString());
    const expandedIds = Array.from(document.querySelectorAll('.collapse.show')).map(el => el.id);
    const urlParams = new URLSearchParams(window.location.search);
    const url = `/tab7/data?${urlParams.toString()}`;

    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            console.log("Refresh data received:", data);
            const tbody = document.getElementById('tagTableBody');
            tbody.innerHTML = '';
            if (data && data.tags) {
                const categoryMap = {};
                data.tags.forEach(tag => {
                    if (!categoryMap[tag.category]) {
                        categoryMap[tag.category] = [];
                    }
                    categoryMap[tag.category].push(tag);
                });

                Object.entries(data.category_counts).forEach(([cat, counts]) => {
                    const cat_key = cat.toLowerCase().replace(/[^a-z0-9]/gi, '_');
                    const parentRow = document.createElement('tr');
                    parentRow.className = 'table-active';
                    parentRow.innerHTML = `
                        <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#child-${cat_key}">+</span></td>
                        <td>${cat}</td>
                        <td>${counts.total}</td>
                        <td>${counts.out_used}</td>
                        <td>${counts.active}</td>
                    `;
                    const childRow = document.createElement('tr');
                    childRow.innerHTML = `
                        <td colspan="5" class="p-0">
                            <div id="child-${cat_key}" class="collapse" data-category="${cat}">
                                <table class="table mb-0 child-table" id="childTable-${cat_key}">
                                    <thead>
                                        <tr>
                                            <th class="sortable" data-col-name="tag_id">EPC</th>
                                            <th class="sortable" data-col-name="common_name">Common Name</th>
                                            <th class="sortable" data-col-name="status">Status</th>
                                            <th class="sortable" data-col-name="item_type">Item Type</th>
                                            <th class="sortable" data-col-name="last_contract_num">Last Contract</th>
                                            <th class="sortable" data-col-name="reuse_count">Reuse Count</th>
                                        </tr>
                                    </thead>
                                    <tbody id="childTbody-${cat_key}"></tbody>
                                </table>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(parentRow);
                    tbody.appendChild(childRow);

                    const childTbody = document.getElementById(`childTbody-${cat_key}`);
                    if (expandedIds.includes(`child-${cat_key}`)) {
                        categoryMap[cat].forEach(tag => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${tag.tag_id}</td>
                                <td>${tag.common_name}</td>
                                <td>${tag.status}</td>
                                <td>${tag.item_type}</td>
                                <td>${tag.last_contract_num || 'N/A'}</td>
                                <td>${tag.reuse_count}</td>
                            `;
                            childTbody.appendChild(tr);
                        });
                    }
                });
            }

            expandedIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    console.log(`Restoring expanded state for: ${id}`);
                    new bootstrap.Collapse(element, { toggle: false }).show();
                    const toggle = document.querySelector(`[data-bs-target="#${id}"]`);
                    if (toggle) toggle.textContent = '-';
                }
            });
        })
        .catch(error => console.error('Error refreshing table:', error));
}

document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM Content Loaded - Tab 7");

    document.getElementById("tagTable").addEventListener("click", function(event) {
        const target = event.target;
        if (target.classList.contains("sortable")) {
            const table = target.closest("table");
            const colName = target.getAttribute("data-col-name");
            sortTable(table, colName);
        }
        if (target.classList.contains("expand-toggle")) {
            const targetId = target.getAttribute("data-bs-target").substring(1);
            const collapseEl = document.getElementById(targetId);
            if (collapseEl) {
                collapseEl.addEventListener("show.bs.collapse", () => target.textContent = "-");
                collapseEl.addEventListener("hide.bs.collapse", () => target.textContent = "+");
            }
        }
    });

    document.addEventListener('newData', (e) => {
        refreshTable();
    });

    setInterval(refreshTable, 60000);
});
</script>

<style>
    body, html { height: 100%; overflow-y: auto; margin: 0; padding: 0; }
    .table-container { width: 100%; overflow-y: visible; padding-bottom: 100px; }
    .child-table, .collapse { width: 100%; overflow-y: visible; }
</style>

{% endblock %}
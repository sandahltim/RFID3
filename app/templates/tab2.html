{% extends 'base.html' %}
{% block content %}
<h1>Categories</h1>

<form method="GET" class="mb-3 row g-2">
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="common_name" placeholder="Filter Common Name" value="{{ filter_common_name }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="tag_id" placeholder="Filter Tag ID" value="{{ filter_tag_id }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="bin_location" placeholder="Filter Bin Location" value="{{ filter_bin_location }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="last_contract_num" placeholder="Filter Last Contract" value="{{ filter_last_contract }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="status" placeholder="Filter Status" value="{{ filter_status }}" />
  </div>
  <div class="col-12 col-md-2">
    <button type="submit" class="btn btn-primary">Apply Filters</button>
  </div>
</form>

<div class="table-container">
  <table class="table table-striped table-bordered" id="parentTable">
    <thead>
      <tr>
        <th style="width: 50px;"></th>
        <th class="sortable" data-col-name="category">Category</th>
        <th class="sortable" data-col-name="total_amount">Total Amount</th>
        <th class="sortable" data-col-name="on_contract">On Contract</th>
        <th class="sortable" data-col-name="available">Available</th>
        <th class="sortable" data-col-name="service">Service</th>
      </tr>
    </thead>
    <tbody id="parentTableBody">
      {% for parent in parent_data %}
      {% set cat_key = parent.category|lower|replace(' ', '_') %}
      <tr class="table-active">
        <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#middle-{{ cat_key }}">+</span></td>
        <td>{{ parent.category }}</td>
        <td>{{ parent.total_amount }}</td>
        <td>{{ parent.on_contract }}</td>
        <td>{{ parent.available }}</td>
        <td>{{ parent.service }}</td>
      </tr>
      <tr>
        <td colspan="6" class="p-0">
          <div id="middle-{{ cat_key }}" class="collapse" data-category="{{ parent.category }}">
            {% if middle_map[parent.category] %}
            <table class="table mb-0 middle-table" id="middleTable-{{ cat_key }}">
              <thead>
                <tr>
                  <th style="width: 50px;"></th>
                  <th class="sortable" data-col-name="subcategory">Subcategory</th>
                  <th class="sortable" data-col-name="total">Total</th>
                  <th class="sortable" data-col-name="on_contract">On Contract</th>
                  <th class="sortable" data-col-name="available">Available</th>
                  <th class="sortable" data-col-name="service">Service</th>
                </tr>
              </thead>
              <tbody>
                {% for middle in middle_map[parent.category] %}
                {% set middle_idx = cat_key ~ '_' ~ loop.index %}
                <tr>
                  <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#child-{{ middle_idx }}">+</span></td>
                  <td>{{ middle.subcategory }}</td>
                  <td>{{ middle.total }}</td>
                  <td>{{ middle.on_contract }}</td>
                  <td>{{ middle.available }}</td>
                  <td>{{ middle.service }}</td>
                </tr>
                <tr>
                  <td colspan="6" class="p-0">
                    <div id="child-{{ middle_idx }}" class="collapse" data-subcategory="{{ middle.subcategory }}">
                      <div id="loading-{{ middle_idx }}" class="text-center my-2" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </div>
                      <nav aria-label="Item navigation" class="mb-2 mx-2" id="pagination-{{ middle_idx }}">
                        <ul class="pagination pagination-sm justify-content-center flex-wrap"></ul>
                      </nav>
                      <div class="grandchild-table-container">
                        <table class="table mb-0 grandchild-table" id="grandchildTable-{{ middle_idx }}">
                          <thead>
                            <tr>
                              <th class="sortable" data-col-name="tag_id">Tag ID</th>
                              <th class="sortable" data-col-name="common_name">Common Name</th>
                              <th class="sortable" data-col-name="status">Status</th>
                              <th class="sortable" data-col-name="bin_location">Bin Location</th>
                              <th class="sortable" data-col-name="quality">Quality</th>
                              <th class="sortable" data-col-name="last_contract_num">Last Contract Num</th>
                              <th class="sortable" data-col-name="client_name">Client Name</th>
                              <th class="sortable" data-col-name="date_last_scanned">Scanned Date</th>
                              <th class="sortable" data-col-name="last_scanned_by">Scanned By</th>
                              <th class="sortable" data-col-name="notes">Notes</th>
                            </tr>
                          </thead>
                          <tbody id="grandchildTbody-{{ middle_idx }}"></tbody>
                        </table>
                      </div>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p class="m-2">No items available</p>
            {% endif %}
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
function sortTable(tableEl, colName) {
  const tbody = tableEl.querySelector("tbody");
  if (!tbody) return;

  let asc = tableEl.getAttribute("data-sort-col") === colName 
            ? tableEl.getAttribute("data-sort-dir") !== "asc" 
            : true;
  tableEl.setAttribute("data-sort-col", colName);
  tableEl.setAttribute("data-sort-dir", asc ? "asc" : "desc");

  const headers = Array.from(tableEl.querySelectorAll("th"));
  const colIndex = headers.findIndex(th => th.getAttribute("data-col-name") === colName);

  if (tableEl.id === "parentTable") {
    const rows = Array.from(tbody.children);
    const pairs = [];
    for (let i = 0; i < rows.length; i += 2) {
      const parentRow = rows[i];
      const middleRow = rows[i + 1] || null;
      if (parentRow && parentRow.classList.contains("table-active")) {
        pairs.push({ parent: parentRow, middle: middleRow });
      }
    }
    pairs.sort((a, b) => {
      const cellA = a.parent.cells[colIndex]?.innerText.trim() || "";
      const cellB = b.parent.cells[colIndex]?.innerText.trim() || "";
      const numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      const numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    pairs.forEach(pair => {
      tbody.appendChild(pair.parent);
      if (pair.middle) tbody.appendChild(pair.middle);
    });
  } else if (tableEl.classList.contains("middle-table")) {
    const rows = Array.from(tbody.children);
    const pairs = [];
    for (let i = 0; i < rows.length; i += 2) {
      const middleRow = rows[i];
      const grandRow = rows[i + 1] || null;
      if (middleRow) pairs.push({ middle: middleRow, grand: grandRow });
    }
    pairs.sort((a, b) => {
      const cellA = a.middle.cells[colIndex]?.innerText.trim() || "";
      const cellB = b.middle.cells[colIndex]?.innerText.trim() || "";
      const numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      const numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    pairs.forEach(pair => {
      tbody.appendChild(pair.middle);
      if (pair.grand) tbody.appendChild(pair.grand);
    });
  } else {
    const rows = Array.from(tbody.querySelectorAll("tr"));
    rows.sort((a, b) => {
      const cellA = a.cells[colIndex]?.innerText.trim() || "";
      const cellB = b.cells[colIndex]?.innerText.trim() || "";
      const numA = parseFloat(cellA.replace(/[^0-9.\-]/g, ""));
      const numB = parseFloat(cellB.replace(/[^0-9.\-]/g, ""));
      if (!isNaN(numA) && !isNaN(numB)) return asc ? numA - numB : numB - numA;
      return asc ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
    });
    tbody.innerHTML = "";
    rows.forEach(row => tbody.appendChild(row));
  }
}

function loadSubcatData(category, subcategory, page, catKey) {
  console.log(`Loading: Category: ${category}, Subcategory: ${subcategory}, Page: ${page}, CatKey: ${catKey}`);
  const loading = document.getElementById(`loading-${catKey}`);
  if (loading) loading.style.display = 'block';

  const urlParams = new URLSearchParams(window.location.search);
  const params = {
    category: category,
    subcategory: subcategory,
    page: page,
    common_name: urlParams.get('common_name') || '',
    tag_id: urlParams.get('tag_id') || '',
    bin_location: urlParams.get('bin_location') || '',
    last_contract_num: urlParams.get('last_contract_num') || '',
    status: urlParams.get('status') || ''
  };
  const url = `/tab2/subcat_data?${new URLSearchParams(params).toString()}`;
  console.log(`Fetching URL: ${url}`);

  fetch(url)
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      return response.json();
    })
    .then(data => {
      console.log('AJAX Response:', data);
      const tbody = document.getElementById(`grandchildTbody-${catKey}`);
      if (!tbody) {
        console.error(`Tbody not found for CatKey: ${catKey}`);
        return;
      }
      tbody.innerHTML = '';
      if (data.items && data.items.length > 0) {
        data.items.forEach(item => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.tag_id}</td>
            <td>${item.common_name}</td>
            <td>${item.status || 'N/A'}</td>
            <td>${item.bin_location || 'N/A'}</td>
            <td>${item.quality || 'N/A'}</td>
            <td>${item.last_contract_num || 'N/A'}</td>
            <td>${item.client_name || 'N/A'}</td>
            <td>${item.date_last_scanned || 'N/A'}</td>
            <td>${item.last_scanned_by || 'N/A'}</td>
            <td>${item.notes || 'N/A'}</td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        tbody.innerHTML = '<tr><td colspan="10">No items found</td></tr>';
      }

      const pagination = document.getElementById(`pagination-${catKey}`);
      if (pagination) {
        const paginationList = pagination.querySelector('.pagination');
        paginationList.innerHTML = '';
        if (data.total_pages > 1) {
          const prevLi = document.createElement('li');
          prevLi.className = `page-item ${data.current_page === 1 ? 'disabled' : ''}`;
          prevLi.innerHTML = `<a class="page-link" href="#" data-page="${data.current_page - 1}" aria-label="Previous"><span aria-hidden="true">« Prev</span></a>`;
          paginationList.appendChild(prevLi);

          for (let p = 1; p <= data.total_pages; p++) {
            const li = document.createElement('li');
            li.className = `page-item ${p === data.current_page ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" data-page="${p}">${p}</a>`;
            paginationList.appendChild(li);
          }

          const nextLi = document.createElement('li');
          nextLi.className = `page-item ${data.current_page === data.total_pages ? 'disabled' : ''}`;
          nextLi.innerHTML = `<a class="page-link" href="#" data-page="${data.current_page + 1}" aria-label="Next"><span aria-hidden="true">Next »</span></a>`;
          paginationList.appendChild(nextLi);

          pagination.querySelectorAll('.page-link').forEach(link => {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              const newPage = parseInt(link.getAttribute('data-page'));
              if (!isNaN(newPage)) loadSubcatData(category, subcategory, newPage, catKey);
            });
          });
        }
      }
      if (loading) loading.style.display = 'none';
    })
    .catch(error => {
      console.error('Error loading subcat data:', error);
      const tbody = document.getElementById(`grandchildTbody-${catKey}`);
      if (tbody) {
        tbody.innerHTML = '<tr><td colspan="10">Error loading data</td></tr>';
      }
      if (loading) loading.style.display = 'none';
    });
}

function refreshTable() {
  console.log("Refreshing Tab 2 at " + new Date().toLocaleTimeString());
  const expandedIds = Array.from(document.querySelectorAll('.collapse.show')).map(el => el.id);
  const urlParams = new URLSearchParams(window.location.search);
  const url = `/tab2/data?${urlParams.toString()}`;

  fetch(url)
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      return response.json();
    })
    .then(data => {
      console.log("Refresh data received:", data);
      const tbody = document.getElementById('parentTableBody');
      tbody.innerHTML = '';
      if (data && data.parent_data) {
        data.parent_data.forEach(parent => {
          const cat_key = parent.category.toLowerCase().replace(/ /g, '_');
          const parentRow = document.createElement('tr');
          parentRow.className = 'table-active';
          parentRow.innerHTML = `
            <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#middle-${cat_key}">+</span></td>
            <td>${parent.category}</td>
            <td>${parent.total_amount}</td>
            <td>${parent.on_contract}</td>
            <td>${parent.available}</td>
            <td>${parent.service}</td>
          `;
          const middleRow = document.createElement('tr');
          middleRow.innerHTML = `
            <td colspan="6" class="p-0">
              <div id="middle-${cat_key}" class="collapse" data-category="${parent.category}">
                <table class="table mb-0 middle-table" id="middleTable-${cat_key}">
                  <thead>
                    <tr>
                      <th style="width: 50px;"></th>
                      <th class="sortable" data-col-name="subcategory">Subcategory</th>
                      <th class="sortable" data-col-name="total">Total</th>
                      <th class="sortable" data-col-name="on_contract">On Contract</th>
                      <th class="sortable" data-col-name="available">Available</th>
                      <th class="sortable" data-col-name="service">Service</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </td>
          `;
          tbody.appendChild(parentRow);
          tbody.appendChild(middleRow);

          const middleTbody = document.getElementById(`middleTable-${cat_key}`).querySelector('tbody');
          if (data.middle_map[parent.category] && expandedIds.includes(`middle-${cat_key}`)) {
            data.middle_map[parent.category].forEach((middle, index) => {
              const middle_idx = `${cat_key}_${index + 1}`;
              const middleRow = document.createElement('tr');
              middleRow.innerHTML = `
                <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#child-${middle_idx}">+</span></td>
                <td>${middle.subcategory}</td>
                <td>${middle.total}</td>
                <td>${middle.on_contract}</td>
                <td>${middle.available}</td>
                <td>${middle.service}</td>
              `;
              const grandRow = document.createElement('tr');
              grandRow.innerHTML = `
                <td colspan="6" class="p-0">
                  <div id="child-${middle_idx}" class="collapse" data-subcategory="${middle.subcategory}">
                    <div id="loading-${middle_idx}" class="text-center my-2" style="display: none;">
                      <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                    </div>
                    <nav aria-label="Item navigation" class="mb-2 mx-2" id="pagination-${middle_idx}">
                      <ul class="pagination pagination-sm justify-content-center flex-wrap"></ul>
                    </nav>
                    <div class="grandchild-table-container">
                      <table class="table mb-0 grandchild-table" id="grandchildTable-${middle_idx}">
                        <thead>
                          <tr>
                            <th class="sortable" data-col-name="tag_id">Tag ID</th>
                            <th class="sortable" data-col-name="common_name">Common Name</th>
                            <th class="sortable" data-col-name="status">Status</th>
                            <th class="sortable" data-col-name="bin_location">Bin Location</th>
                            <th class="sortable" data-col-name="quality">Quality</th>
                            <th class="sortable" data-col-name="last_contract_num">Last Contract Num</th>
                            <th class="sortable" data-col-name="client_name">Client Name</th>
                            <th class="sortable" data-col-name="date_last_scanned">Scanned Date</th>
                            <th class="sortable" data-col-name="last_scanned_by">Scanned By</th>
                            <th class="sortable" data-col-name="notes">Notes</th>
                          </tr>
                        </thead>
                        <tbody id="grandchildTbody-${middle_idx}"></tbody>
                      </table>
                    </div>
                  </div>
                </td>
              `;
              middleTbody.appendChild(middleRow);
              middleTbody.appendChild(grandRow);

              if (expandedIds.includes(`child-${middle_idx}`)) {
                loadSubcatData(parent.category, middle.subcategory, 1, middle_idx);
              }
            });
          }
        });
      }

      expandedIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          new bootstrap.Collapse(element, { toggle: false }).show();
          const toggle = document.querySelector(`[data-bs-target="#${id}"]`);
          if (toggle) toggle.textContent = '-';
        }
      });
    })
    .catch(error => console.error('Error refreshing table:', error));
}

function updateWithNewData(newData) {
  console.log("Updating Tab 2 with new data:", newData);
  const urlParams = new URLSearchParams(window.location.search);
  const filters = {
    common_name: urlParams.get('common_name')?.toLowerCase() || '',
    tag_id: urlParams.get('tag_id')?.toLowerCase() || '',
    bin_location: urlParams.get('bin_location')?.toLowerCase() || '',
    last_contract_num: urlParams.get('last_contract_num')?.toLowerCase() || '',
    status: urlParams.get('status')?.toLowerCase() || ''
  };

  const filteredItems = newData.items.filter(item => 
    (!filters.common_name || item.common_name.toLowerCase().includes(filters.common_name)) &&
    (!filters.tag_id || item.tag_id.toLowerCase().includes(filters.tag_id)) &&
    (!filters.bin_location || (item.bin_location || '').toLowerCase().includes(filters.bin_location)) &&
    (!filters.last_contract_num || (item.last_contract_num || '').toLowerCase().includes(filters.last_contract_num)) &&
    (!filters.status || (item.status || '').toLowerCase().includes(filters.status))
  );

  const tbody = document.getElementById('parentTableBody');
  const categoryTotals = {};
  filteredItems.forEach(item => {
    const cat = categorizeItem(item.rental_class_num);
    if (!categoryTotals[cat]) categoryTotals[cat] = { total: 0, on_contract: 0, available: 0, service: 0, subcategories: {} };
    categoryTotals[cat].total++;
    if (["Delivered", "On Rent"].includes(item.status)) categoryTotals[cat].on_contract++;
    if (item.status === "Ready to Rent") categoryTotals[cat].available++;
    if (!["Delivered", "On Rent", "Ready to Rent"].includes(item.status)) categoryTotals[cat].service++;
    const subcat = subcategorizeItem(cat, item.rental_class_num);
    if (!categoryTotals[cat].subcategories[subcat]) categoryTotals[cat].subcategories[subcat] = { total: 0, on_contract: 0, available: 0, service: 0, items: [] };
    categoryTotals[cat].subcategories[subcat].total++;
    if (["Delivered", "On Rent"].includes(item.status)) categoryTotals[cat].subcategories[subcat].on_contract++;
    if (item.status === "Ready to Rent") categoryTotals[cat].subcategories[subcat].available++;
    if (!["Delivered", "On Rent", "Ready to Rent"].includes(item.status)) categoryTotals[cat].subcategories[subcat].service++;
    categoryTotals[cat].subcategories[subcat].items.push(item);
  });

  Object.entries(categoryTotals).forEach(([category, data]) => {
    let parentRow = Array.from(tbody.querySelectorAll('.table-active'))
      .find(row => row.cells[1].innerText === category);
    const cat_key = category.toLowerCase().replace(/ /g, '_');
    if (!parentRow) {
      parentRow = document.createElement('tr');
      parentRow.className = 'table-active';
      parentRow.innerHTML = `
        <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#middle-${cat_key}">+</span></td>
        <td>${category}</td>
        <td>${data.total}</td>
        <td>${data.on_contract}</td>
        <td>${data.available}</td>
        <td>${data.service}</td>
      `;
      const middleRow = document.createElement('tr');
      middleRow.innerHTML = `
        <td colspan="6" class="p-0">
          <div id="middle-${cat_key}" class="collapse" data-category="${category}">
            <table class="table mb-0 middle-table" id="middleTable-${cat_key}">
              <thead>
                <tr>
                  <th style="width: 50px;"></th>
                  <th class="sortable" data-col-name="subcategory">Subcategory</th>
                  <th class="sortable" data-col-name="total">Total</th>
                  <th class="sortable" data-col-name="on_contract">On Contract</th>
                  <th class="sortable" data-col-name="available">Available</th>
                  <th class="sortable" data-col-name="service">Service</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </td>
      `;
      tbody.appendChild(parentRow);
      tbody.appendChild(middleRow);
    } else {
      parentRow.cells[2].innerText = data.total;
      parentRow.cells[3].innerText = data.on_contract;
      parentRow.cells[4].innerText = data.available;
      parentRow.cells[5].innerText = data.service;
    }

    const middleTbody = document.getElementById(`middleTable-${cat_key}`).querySelector('tbody');
    if (middleTbody.closest('.collapse').classList.contains('show')) {
      Object.entries(data.subcategories).forEach(([subcat, subData], index) => {
        let middleRow = Array.from(middleTbody.querySelectorAll('tr'))
          .find(row => row.cells[1]?.innerText === subcat);
        const middle_idx = `${cat_key}_${index + 1}`;
        if (!middleRow) {
          middleRow = document.createElement('tr');
          middleRow.innerHTML = `
            <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#child-${middle_idx}">+</span></td>
            <td>${subcat}</td>
            <td>${subData.total}</td>
            <td>${subData.on_contract}</td>
            <td>${subData.available}</td>
            <td>${subData.service}</td>
          `;
          const grandRow = document.createElement('tr');
          grandRow.innerHTML = `
            <td colspan="6" class="p-0">
              <div id="child-${middle_idx}" class="collapse" data-subcategory="${subcat}">
                <div id="loading-${middle_idx}" class="text-center my-2" style="display: none;">
                  <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>
                </div>
                <nav aria-label="Item navigation" class="mb-2 mx-2" id="pagination-${middle_idx}">
                  <ul class="pagination pagination-sm justify-content-center flex-wrap"></ul>
                </nav>
                <div class="grandchild-table-container">
                  <table class="table mb-0 grandchild-table" id="grandchildTable-${middle_idx}">
                    <thead>
                      <tr>
                        <th class="sortable" data-col-name="tag_id">Tag ID</th>
                        <th class="sortable" data-col-name="common_name">Common Name</th>
                        <th class="sortable" data-col-name="status">Status</th>
                        <th class="sortable" data-col-name="bin_location">Bin Location</th>
                        <th class="sortable" data-col-name="quality">Quality</th>
                        <th class="sortable" data-col-name="last_contract_num">Last Contract Num</th>
                        <th class="sortable" data-col-name="client_name">Client Name</th>
                        <th class="sortable" data-col-name="date_last_scanned">Scanned Date</th>
                        <th class="sortable" data-col-name="last_scanned_by">Scanned By</th>
                        <th class="sortable" data-col-name="notes">Notes</th>
                      </tr>
                    </thead>
                    <tbody id="grandchildTbody-${middle_idx}"></tbody>
                  </table>
                </div>
              </div>
            </td>
          `;
          middleTbody.appendChild(middleRow);
          middleTbody.appendChild(grandRow);
        } else {
          middleRow.cells[2].innerText = subData.total;
          middleRow.cells[3].innerText = subData.on_contract;
          middleRow.cells[4].innerText = subData.available;
          middleRow.cells[5].innerText = subData.service;
        }

        const grandTbody = document.getElementById(`grandchildTbody-${middle_idx}`);
        if (grandTbody && grandTbody.closest('.collapse').classList.contains('show')) {
          subData.items.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${item.tag_id}</td>
              <td>${item.common_name}</td>
              <td>${item.status || 'N/A'}</td>
              <td>${item.bin_location || 'N/A'}</td>
              <td>${item.quality || 'N/A'}</td>
              <td>${item.last_contract_num || 'N/A'}</td>
              <td>${item.client_name || 'N/A'}</td>
              <td>${item.date_last_scanned || 'N/A'}</td>
              <td>${item.last_scanned_by || 'N/A'}</td>
              <td>${item.notes || 'N/A'}</td>
            `;
            grandTbody.appendChild(tr);
          });
        }
      });
    }
  });
}

function categorizeItem(rental_class_num) {
  return CATEGORY_MAP[parseInt(rental_class_num)] || "Other";
}

function subcategorizeItem(category, rental_class_num) {
  const rid = parseInt(rental_class_num);
  if (category in ['Tent Tops', 'Tables and Chairs', 'Round Linen', 'Rectangle Linen', 
                   'Concession Equipment', 'AV Equipment', 'Runners and Drapes', 
                   'Other', 'Resale']) {
    return SUBCATEGORY_MAP[rid] || 'Unspecified';
  }
  return 'Unspecified';
}

document.addEventListener('DOMContentLoaded', () => {
  console.log("DOM Content Loaded - Tab 2");

  document.getElementById("parentTable").addEventListener('click', (e) => {
    const target = e.target;
    if (target.classList.contains("sortable")) {
      const table = target.closest('table');
      const colName = target.getAttribute('data-col-name');
      sortTable(table, colName);
    } else if (target.classList.contains("expand-toggle")) {
      const targetId = target.getAttribute('data-bs-target');
      const targetEl = document.querySelector(targetId);
      if (targetEl && !targetEl.classList.contains('show') && targetId.startsWith('#child-')) {
        const category = targetEl.closest(".collapse[data-category]").getAttribute("data-category");
        const subcategory = targetEl.getAttribute("data-subcategory");
        const catKey = targetId.split("child-")[1];
        loadSubcatData(category, subcategory, 1, catKey);
      }
      if (targetEl) {
        targetEl.addEventListener("show.bs.collapse", () => target.textContent = "-");
        targetEl.addEventListener("hide.bs.collapse", () => target.textContent = "+");
      }
    }
  });

  document.addEventListener('newData', (e) => {
    updateWithNewData(e.detail);
  });

  setInterval(refreshTable, 60000);
});
</script>

<style>
  body, html { height: 100%; overflow: auto; margin: 0; padding: 0; }
  .table-container { width: 100%; overflow-y: auto; }
  .table-container table { width: 100%; table-layout: auto; }
  .grandchild-table-container { width: 100%; overflow-y: auto; }
  .grandchild-table-container table { width: 100%; table-layout: auto; }
  .collapse { width: 100%; }
  @media (max-width: 768px) { .pagination .page-link { padding: 0.25rem 0.5rem; font-size: 0.9rem; } }
</style>

{% endblock %}
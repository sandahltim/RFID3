{% extends "base.html" %}
{% block content %}

<h1>Active Rentals</h1>

<form method="GET" class="mb-3 row g-2" id="filter-form">
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="last_contract_num" placeholder="Filter Contract Number" value="{{ filter_contract }}" />
  </div>
  <div class="col-12 col-md-2">
    <input type="text" class="form-control" name="common_name" placeholder="Filter Common Name" value="{{ filter_common }}" />
  </div>
  <div class="col-12 col-md-2">
    <button type="submit" class="btn btn-primary">Apply Filters</button>
  </div>
</form>

<nav aria-label="Page navigation" class="mb-3">
  <ul class="pagination justify-content-center flex-wrap" id="top-pagination">
    <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('tab1.show_tab1', page=current_page-1, last_contract_num=filter_contract, common_name=filter_common, sort=sort) }}" aria-label="Previous">
        <span aria-hidden="true">« Prev</span>
      </a>
    </li>
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == current_page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('tab1.show_tab1', page=p, last_contract_num=filter_contract, common_name=filter_common, sort=sort) }}">{{ p }}</a>
    </li>
    {% endfor %}
    <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('tab1.show_tab1', page=current_page+1, last_contract_num=filter_contract, common_name=filter_common, sort=sort) }}" aria-label="Next">
        <span aria-hidden="true">Next »</span>
      </a>
    </li>
  </ul>
</nav>

<div class="table-container" id="table-container">
  <table class="table table-striped table-bordered" id="parentTable">
    <thead>
      <tr>
        <th style="width: 50px;"></th>
        <th class="sortable" data-col-name="contract">Contract #</th>
        <th class="sortable" data-col-name="client_name">Client Name</th>
        <th class="sortable" data-col-name="total">Total Items</th>
        <th class="sortable" data-col-name="scan_date">Last Scan Date</th>
        <th class="sortable" data-col-name="transaction_notes">Transaction Notes</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="parentTableBody">
      {% for parent in parent_data %}
      {% set contract_key = parent.contract|lower|replace('[^a-z0-9]', '_') %}
      <tr class="table-active">
        <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#child-{{ contract_key }}">+</span></td>
        <td>{{ parent.contract }}</td>
        <td>{{ parent.client_name }}</td>
        <td>{{ parent.total }}</td>
        <td>{{ parent.scan_date }}</td>
        <td>{{ parent.transaction_notes }}</td>
        <td><button class="btn btn-sm btn-primary print-btn" data-level="parent" data-contract="{{ parent.contract }}">Print</button></td>
      </tr>
      <tr>
        <td colspan="7" class="p-0">
          <div id="child-{{ contract_key }}" class="collapse" data-contract="{{ parent.contract }}">
            <div class="child-table-container">
              <table class="table table-striped table-bordered child-table" id="childTable-{{ contract_key }}">
                <thead>
                  <tr>
                    <th style="width: 50px;"></th>
                    <th class="sortable" data-col-name="common_name">Common Name</th>
                    <th class="sortable" data-col-name="total">Total Items</th>
                    <th class="sortable" data-col-name="available">Available</th>
                    <th class="sortable" data-col-name="on_rent">On Rent</th>
                    <th class="sortable" data-col-name="service">Service</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for rental_class_id, totals in child_map[parent.contract].items() %}
                  {% set child_key = contract_key ~ '_' ~ rental_class_id %}
                  <tr class="child-row">
                    <td><span class="expand-toggle" data-bs-toggle="collapse" data-bs-target="#grandchild-{{ child_key }}">+</span></td>
                    <td>{{ totals.common_name }}</td>
                    <td>{{ totals.total }}</td>
                    <td>{{ totals.available }}</td>
                    <td>{{ totals.on_rent }}</td>
                    <td>{{ totals.service }}</td>
                    <td><button class="btn btn-sm btn-primary print-btn" data-level="child" data-contract="{{ parent.contract }}" data-common-name="{{ totals.common_name }}">Print</button></td>
                  </tr>
                  <tr>
                    <td colspan="7" class="p-0">
                      <div id="grandchild-{{ child_key }}" class="collapse" data-contract="{{ parent.contract }}" data-common-name="{{ totals.common_name }}">
                        <div id="loading-{{ child_key }}" class="text-center my-2" style="display: none;">
                          <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                          </div>
                        </div>
                        <nav aria-label="Item navigation" class="mb-2 mx-2" id="pagination-{{ child_key }}">
                          <ul class="pagination pagination-sm justify-content-center flex-wrap"></ul>
                        </nav>
                        <div class="grandchild-table-container">
                          <table class="table mb-0 grandchild-table" id="grandchildTable-{{ child_key }}">
                            <thead>
                              <tr>
                                <th class="sortable" data-col-name="tag_id">Tag ID</th>
                                <th class="sortable" data-col-name="common_name">Common Name</th>
                                <th class="sortable" data-col-name="status">Status</th>
                                <th class="sortable" data-col-name="bin_location">Bin Location</th>
                                <th class="sortable" data-col-name="quality">Quality</th>
                                <th class="sortable" data-col-name="last_contract_num">Last Contract Num</th>
                                <th class="sortable" data-col-name="date_last_scanned">Date Last Scanned</th>
                                <th class="sortable" data-col-name="last_scanned_by">Last Scanned By</th>
                                <th class="sortable" data-col-name="notes">Notes</th>
                              </tr>
                            </thead>
                            <tbody id="grandchildTbody-{{ child_key }}"></tbody>
                          </table>
                        </div>
                      </div>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<nav aria-label="Page navigation" class="mt-3">
  <ul class="pagination justify-content-center flex-wrap" id="bottom-pagination">
    <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('tab1.show_tab1', page=current_page-1, last_contract_num=filter_contract, common_name=filter_common, sort=sort) }}" aria-label="Previous">
        <span aria-hidden="true">« Prev</span>
      </a>
    </li>
    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if p == current_page %}active{% endif %}">
      <a class="page-link" href="{{ url_for('tab1.show_tab1', page=p, last_contract_num=filter_contract, common_name=filter_common, sort=sort) }}">{{ p }}</a>
    </li>
    {% endfor %}
    <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('tab1.show_tab1', page=current_page+1, last_contract_num=filter_contract, common_name=filter_common, sort=sort) }}" aria-label="Next">
        <span aria-hidden="true">Next »</span>
      </a>
    </li>
  </ul>
</nav>

<script>
  const childMap = {{ child_map|tojson }};
  
  // ... (sortTable, loadSubcatData, printTable, printChildItems, refreshTable, debounce unchanged) ...
  
  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM Content Loaded");
  
    document.getElementById("table-container").addEventListener("click", function(event) {
      if (event.target.classList.contains("sortable")) {
        const table = event.target.closest("table");
        const colName = event.target.getAttribute("data-col-name");
        sortTable(table, colName);
      }
  
      if (event.target.classList.contains("print-btn")) {
        console.log("Direct print-btn click detected");
        const level = event.target.getAttribute("data-level");
        const contract = event.target.getAttribute("data-contract");
        const common_name = event.target.getAttribute("data-common-name");
        if (level === "parent") {
          console.log(`Parent print button clicked for contract: ${contract}`);
          printTable("parent", contract);
        } else if (level === "child") {
          console.log(`Child print button clicked for contract: ${contract}, common_name: ${common_name}`);
          printTable("child", contract, common_name);
        }
      }
  
      if (event.target.classList.contains("expand-toggle")) {
        const targetId = event.target.getAttribute("data-bs-target").substring(1);
        const collapseEl = document.getElementById(targetId);
        console.log(`Expand toggle clicked, target: ${targetId}, showing: ${collapseEl.classList.contains('show')}`);
        if (collapseEl && !collapseEl.classList.contains("show")) {
          const contract = collapseEl.getAttribute("data-contract");
          const common_name = collapseEl.getAttribute("data-common-name");
          if (contract && common_name) {
            const normalizedCommonName = common_name.toLowerCase().replace(/\s+/g, ' ').trim();
            const rental_class_id = Object.keys(childMap[contract]).find(id => 
              childMap[contract][id].common_name.toLowerCase().replace(/\s+/g, ' ').trim() === normalizedCommonName);
            if (rental_class_id) {
              const childKey = `${contract.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${rental_class_id}`;
              console.log(`Triggering loadSubcatData for contract: ${contract}, common_name: ${common_name}, childKey: ${childKey}`);
              loadSubcatData(contract, common_name, 1, childKey);
            } else {
              console.error(`No rental_class_id found for contract: ${contract}, common_name: ${common_name}`);
            }
          } else {
            console.error(`Missing contract or common_name on collapse element: ${targetId}`);
          }
        }
      }
    });
  
    const filterForm = document.getElementById("filter-form");
    const debouncedSubmit = debounce(() => filterForm.submit(), 500);
    filterForm.querySelectorAll("input").forEach(input => {
      input.addEventListener("input", debouncedSubmit);
    });
  
    setInterval(refreshTable, 60000);
  });
  </script>
  
  # ... (styles unchanged) ...
  Step 6: Update tab5.html (Expand Fix Only)
  text
  
  Collapse
  
  Wrap
  
  Copy
  # ... (rest of the file unchanged up to script) ...
  
  <script>
  const childMap = {{ child_map|tojson }};
  
  // ... (sortTable, loadSubcatData, printTable, printChildItems, confirmSave, confirmUpdate, debounce unchanged) ...
  
  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM Content Loaded");
  
    document.getElementById("date_last_scanned").value = new Date().toISOString().replace("T", " ").slice(0, 19);
  
    document.getElementById("table-container").addEventListener("click", function(event) {
      if (event.target.classList.contains("sortable")) {
        const table = event.target.closest("table");
        const colName = event.target.getAttribute("data-col-name");
        sortTable(table, colName);
      }
  
      if (event.target.classList.contains("print-btn")) {
        console.log("Direct print-btn click detected");
        const level = event.target.getAttribute("data-level");
        const contract = event.target.getAttribute("data-contract");
        const common_name = event.target.getAttribute("data-common-name");
        if (level === "parent") {
          console.log(`Parent print button clicked for contract: ${contract}`);
          printTable("parent", contract);
        } else if (level === "child") {
          console.log(`Child print button clicked for contract: ${contract}, common_name: ${common_name}`);
          printTable("child", contract, common_name);
        }
      }
  
      if (event.target.classList.contains("expand-toggle")) {
        const targetId = event.target.getAttribute("data-bs-target").substring(1);
        const collapseEl = document.getElementById(targetId);
        console.log(`Expand toggle clicked, target: ${targetId}, showing: ${collapseEl.classList.contains('show')}`);
        if (collapseEl && !collapseEl.classList.contains("show")) {
          const contract = collapseEl.getAttribute("data-contract");
          const common_name = collapseEl.getAttribute("data-common-name");
          if (contract && common_name) {
            const normalizedCommonName = common_name.toLowerCase().replace(/\s+/g, ' ').trim();
            const rental_class_id = Object.keys(childMap[contract]).find(id => 
              childMap[contract][id].common_name.toLowerCase().replace(/\s+/g, ' ').trim() === normalizedCommonName);
            if (rental_class_id) {
              const childKey = `${contract.toLowerCase().replace(/[^a-z0-9]/g, '_')}_${rental_class_id}`;
              console.log(`Triggering loadSubcatData for contract: ${contract}, common_name: ${common_name}, childKey: ${childKey}`);
              loadSubcatData(contract, common_name, 1, childKey);
            } else {
              console.error(`No rental_class_id found for contract: ${contract}, common_name: ${common_name}`);
            }
          } else {
            console.error(`Missing contract or common_name on collapse element: ${targetId}`);
          }
        }
      }
    });
  
    const filterForm = document.getElementById("filter-form");
    const debouncedSubmit = debounce(() => filterForm.submit(), 500);
    filterForm.querySelectorAll("input").forEach(input => {
      input.addEventListener("input", debouncedSubmit);
    });
  });
  
  // ... (confirmSave, confirmUpdate, debounce unchanged) ...
  </script>

<style>
  body, html { height: 100%; overflow-y: auto; margin: 0; padding: 0; }
  .table-container { width: 100%; overflow-y: visible; padding-bottom: 100px; }
  .child-table-container, .grandchild-table-container, .collapse { width: 100%; overflow-y: visible; }
  @media (max-width: 768px) { .pagination .page-link { padding: 0.25rem 0.5rem; font-size: 0.9rem; } }
</style>

{% endblock %}